# Vulnerability Monitoring and Grype Ignore Re-evaluation

## Overview

This document describes the automated and manual processes for monitoring security vulnerabilities and re-evaluating Grype scan ignores.

**Last Updated:** 2026-02-12
**Owner:** Security Team (Claude-QA)
**Review Frequency:** Quarterly (Q1, Q2, Q3, Q4)

---

## Table of Contents

- [Background](#background)
- [Current Ignored Vulnerabilities](#current-ignored-vulnerabilities)
- [Automated Monitoring](#automated-monitoring)
- [Manual Re-evaluation](#manual-re-evaluation)
- [Remediation Workflow](#remediation-workflow)
- [FAQ](#faq)

---

## Background

### Why We Ignore Vulnerabilities

Grype is an excellent vulnerability scanner, but it can flag false positives or vulnerabilities that don't apply to our use case. We maintain a `.grype.yaml` configuration file that deliberately ignores certain vulnerabilities with documented justifications.

**Key Principles:**

1. **Every ignore MUST have a justification** - No blanket ignores
2. **Ignores are temporary** - We monitor for patches and remove ignores when fixed
3. **Transparency** - All ignores are documented with:
   - Date added
   - Reason for ignore
   - Action required to remove ignore
   - Last verification date

### Risk Management

Ignored vulnerabilities are NOT forgotten vulnerabilities. We:

- **Monitor** upstream security advisories (Alpine, npm, MCP SDK)
- **Re-evaluate** ignores weekly via automated CI/CD
- **Document** mitigation strategies for each ignored CVE
- **Track** when patches become available and remove ignores

---

## Current Ignored Vulnerabilities

### Summary (as of 2026-02-12)

| Category | CVEs Ignored | Status | Action Required |
|----------|--------------|--------|-----------------|
| **Hono** | 2 | ✅ **PATCHED** | Remove ignores (waiting for Grype DB update) |
| **Alpine** | 2 | ⏳ **Monitoring** | Wait for Alpine security patches |
| **npm** | 7 | ✅ **Justified** | Re-evaluate quarterly |

### 1. Hono JWT Vulnerabilities (READY TO REMOVE)

**CVEs:**
- `CVE-2026-22817` - JWT signature bypass
- `CVE-2026-22818` - JWT algorithm confusion

**Status:** ✅ **PATCHED** in Hono 4.11.4+

**Current Version:** Hono 4.11.9 (via `@modelcontextprotocol/sdk@1.26.0`)

**Verification:**

```bash
cd services/mcp-gateway
npm list hono
# Output: hono@4.11.9 (includes CVE fixes)
```

**Action Required:**
- ✅ Verify patches are included (DONE - see script output)
- ⏳ Wait for Grype vulnerability database to recognize the fix
- ✅ Remove ignores from `.grype.yaml` once Grype scan is clean

**References:**
- [Hono Security Advisories](https://github.com/honojs/hono/security/advisories)
- [CVE-2026-22817 Details](https://nvd.nist.gov/vuln/detail/CVE-2026-22817)

---

### 2. Alpine Base Image Vulnerabilities (MONITORING)

**CVEs:**
- `CVE-2026-22184` (CRITICAL) - zlib buffer overflow
- `CVE-2025-60876` (MEDIUM) - busybox command injection

**Status:** ⏳ **Awaiting Alpine Patches**

**Affected:** `node:20-alpine` base image (all production containers)

**Mitigation:**

All Dockerfiles include `apk update && apk upgrade --no-cache` to apply patches as soon as they become available:

```dockerfile
FROM node:20-alpine AS production
RUN apk update && apk upgrade --no-cache
```

**Monitoring:**

- **Alpine Security DB:** <https://secdb.alpinelinux.org/>
- **Alpine Advisories:** <https://security.alpinelinux.org/vulnerabilities>
- **GitHub Workflow:** Checks weekly for patch availability

**Action Required:**
1. Monitor Alpine security advisories for patches
2. When patches are released:
   - Rebuild all containers (`docker compose build --no-cache`)
   - Verify patches with: `docker run --rm node:20-alpine apk list --upgradable`
3. Remove ignores from `.grype.yaml`
4. Run `grype dir:.` to verify fixes

**References:**
- [Alpine Linux Security](https://security.alpinelinux.org/)
- [CVE-2026-22184 Advisory](https://security.alpinelinux.org/vuln/CVE-2026-22184)
- [CVE-2025-60876 Advisory](https://security.alpinelinux.org/vuln/CVE-2025-60876)

---

### 3. npm Bundled Dependencies (JUSTIFIED)

**CVEs:**
- `GHSA-3xgq-45jj-v275` (HIGH) - cross-spawn RegExp DoS
- `GHSA-5j98-mcp5-4vw2` (HIGH) - glob ReDoS
- `GHSA-8qq5-rm4j-mr97` (HIGH) - tar arbitrary file write
- `GHSA-r6q2-hw4h-h46w` (HIGH) - tar directory traversal
- `GHSA-34x7-hfp2-rc4v` (HIGH) - tar symlink attack
- `GHSA-v6h2-p8h4-qcjw` (LOW) - brace-expansion ReDoS
- `GHSA-73rr-hh4g-fpgx` (LOW) - diff ReDoS

**Status:** ✅ **JUSTIFIED** (npm NOT used at runtime)

**Justification:**

Production containers do NOT use npm at runtime. npm vulnerabilities only affect build phase:

**Container CMD/ENTRYPOINT:**

```dockerfile
# Production runtime (safe)
CMD ["node", "dist/index.js"]

# NOT using npm at runtime (would be vulnerable)
# CMD ["npm", "start"]  ❌ DO NOT USE
```

**Verification:**

```bash
# Check all production Dockerfiles
grep -E "CMD|ENTRYPOINT" services/*/Dockerfile clients/*/Dockerfile

# Expected: All use "node dist/index.js" directly
# ✓ services/mcp-gateway: CMD ["node", "dist/index.js"]
# ✓ services/mcp-hr: CMD ["node", "dist/index.js"]
# ✓ services/mcp-finance: CMD ["node", "dist/index.js"]
```

**Mitigation:**
- Multi-stage Dockerfiles - npm only in `builder` stage
- Production stage only contains compiled code (`dist/`)
- Runtime uses Node.js directly, not npm CLI

**Re-evaluation Trigger:**

If ANY Dockerfile is changed to use `npm start` or `npm run` at runtime, these ignores MUST be removed and vulnerabilities addressed.

**Automated Check:** Weekly CI/CD workflow scans Dockerfiles for npm runtime usage.

---

## Automated Monitoring

### GitHub Actions Workflow

**Workflow:** `.github/workflows/security-vulnerability-monitoring.yml`

**Schedule:** Every Monday at 9:00 AM UTC

**Triggers:**
- Weekly schedule (cron)
- Manual dispatch (`workflow_dispatch`)
- Pull requests modifying:
  - `.grype.yaml`
  - `**/package-lock.json`
  - `**/Dockerfile*`

**Jobs:**

1. **check-grype-ignores** - Runs re-evaluation script
2. **scan-with-grype** - Performs vulnerability scan with current ignores
3. **check-alpine-updates** - Monitors Alpine security advisories

**Outputs:**

- **Artifact:** `grype-ignore-report` (30-day retention)
- **GitHub Issue:** Auto-created when ignores should be updated
- **SARIF Upload:** Grype scan results to GitHub Security tab

**Example Workflow Run:**

```yaml
name: Security Vulnerability Monitoring

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly Monday 9 AM UTC
  workflow_dispatch:

jobs:
  check-grype-ignores:
    runs-on: ubuntu-latest
    steps:
      - name: Run re-evaluation script
        run: ./scripts/security/check-grype-ignores.sh
```

---

## Manual Re-evaluation

### When to Re-evaluate Manually

- **Dependency Updates:** After updating `package-lock.json`
- **Base Image Updates:** After changing Dockerfile `FROM` statements
- **Security Alerts:** When receiving GitHub Dependabot alerts
- **Quarterly Review:** Q1 (Jan), Q2 (Apr), Q3 (Jul), Q4 (Oct)

### Re-evaluation Script

**Location:** `scripts/security/check-grype-ignores.sh`

**Usage:**

```bash
# Make executable (first time only)
chmod +x scripts/security/check-grype-ignores.sh

# Run re-evaluation
./scripts/security/check-grype-ignores.sh

# Expected output:
# ℹ Starting Grype ignore re-evaluation...
# ℹ Checking Hono CVE fixes...
# ✓ Hono 4.11.9 includes CVE-2026-22817/22818 fixes
# ⚠ Consider removing Hono CVE ignores from .grype.yaml
# ...
# ==================================
# Grype Ignore Re-evaluation Report
# ==================================
```

**Exit Codes:**
- `0` - All ignores are still justified
- `1` - One or more ignores should be removed (patches available)
- `2` - Script error (missing dependencies)

**Dependencies:**

```bash
# Install required tools (Ubuntu/Debian)
sudo apt-get install jq curl nodejs npm

# Or use Docker (no local dependencies needed)
docker run --rm -v $(pwd):/repo -w /repo ubuntu:22.04 bash -c "
  apt-get update && apt-get install -y jq curl nodejs npm
  ./scripts/security/check-grype-ignores.sh
"
```

### What the Script Checks

1. **Hono Version:**
   - Extracts installed Hono version from `package-lock.json`
   - Compares against required version for CVE fixes (4.11.4)
   - Recommends removing ignores if patched

2. **Alpine Updates:**
   - Checks Alpine security database for CVE patches
   - Verifies `apk upgrade` is present in Dockerfiles
   - Reports when patches become available

3. **npm Runtime Usage:**
   - Scans Dockerfiles for `npm start` or `npm run` in CMD/ENTRYPOINT
   - Warns if npm is used at runtime (would make ignores invalid)
   - Confirms production containers use `node dist/index.js`

---

## Remediation Workflow

### When Patches Become Available

**Step 1: Verify the Patch**

```bash
# For Hono CVEs
cd services/mcp-gateway
npm list hono
# Confirm version >= 4.11.4

# For Alpine CVEs
docker run --rm node:20-alpine apk list --upgradable
# Check if zlib or busybox have updates
```

**Step 2: Update Dependencies**

```bash
# For npm packages
cd services/mcp-gateway
npm update @modelcontextprotocol/sdk
npm audit fix

# For Alpine packages
docker compose build --no-cache
```

**Step 3: Remove Ignores**

Edit `.grype.yaml` and remove the fixed CVE(s):

```diff
  ignore:
-   # CVE-2026-22817 - Fixed in Hono 4.11.4
-   - vulnerability: CVE-2026-22817
```

**Step 4: Verify with Grype**

```bash
# Install Grype (if not installed)
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh

# Run vulnerability scan
grype dir:.

# Expected: No CRITICAL or HIGH vulnerabilities
```

**Step 5: Commit and Push**

```bash
git add .grype.yaml package-lock.json
git commit -m "security: remove Grype ignores for patched CVEs

- Hono 4.11.9 includes CVE-2026-22817/22818 fixes
- Verified with grype scan (no critical/high findings)
"
git push
```

**Step 6: Close GitHub Issue**

If an automated issue was created by the monitoring workflow:

1. Navigate to the issue in GitHub
2. Add comment with verification details
3. Close the issue with label `resolved`

---

## FAQ

### Q: Why don't we fix ALL vulnerabilities immediately?

**A:** Some vulnerabilities are false positives or don't apply to our use case:

- **npm bundled deps:** npm is NOT used at runtime, only at build time
- **Alpine CVEs:** Patches not yet released by Alpine Linux
- **Grype DB lag:** Grype database may not recognize recent patches yet

We balance **security rigor** with **operational practicality** by:
1. Documenting ALL ignores with justifications
2. Monitoring for patches continuously
3. Removing ignores as soon as patches are available

### Q: How do I know if an ignore is still valid?

**A:** Run the re-evaluation script:

```bash
./scripts/security/check-grype-ignores.sh
```

If the script exits with code `1`, the ignore should be removed.

### Q: Can I add new ignores to .grype.yaml?

**A:** Yes, but follow the template:

```yaml
  # ===========================================================================
  # [Category Name] (e.g., Hono JWT Vulnerabilities)
  # ===========================================================================
  # CVE-XXXX-XXXXX: [Brief description]
  #
  # Status: [PATCHED | MONITORING | JUSTIFIED]
  # Added: YYYY-MM-DD
  # Verified: YYYY-MM-DD
  # Reason: [Why we're ignoring this CVE]
  # Action: [What will trigger removal of ignore]
  # Reference: [Link to CVE/advisory]
  #
  - vulnerability: CVE-XXXX-XXXXX
```

**ALL new ignores MUST be reviewed by Security Team.**

### Q: What if the monitoring workflow creates a duplicate issue?

**A:** The workflow checks for existing open issues before creating new ones. If a duplicate is created:

1. Close the duplicate with label `duplicate`
2. Keep the original issue open
3. Report the bug in the workflow file

### Q: How do I run Grype locally?

**A:**

```bash
# Install Grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh

# Scan current directory
grype dir:.

# Scan specific service
grype dir:services/mcp-gateway

# Scan Docker image
docker build -t test-image .
grype test-image
```

### Q: What is the difference between Grype and npm audit?

**A:**

| Tool | Scope | Format | Use Case |
|------|-------|--------|----------|
| **Grype** | Container images + OS packages | SARIF (GitHub Security) | Production container scanning |
| **npm audit** | npm dependencies only | JSON | Development dependency checks |
| **Trivy** | Multi-layer (OS + app deps) | SARIF | Comprehensive container scanning |

We use **ALL THREE** in our CI/CD pipeline for defense-in-depth.

---

## Resources

### Documentation

- [Grype Configuration](.grype.yaml)
- [Re-evaluation Script](../../scripts/security/check-grype-ignores.sh)
- [GitHub Workflow](../../.github/workflows/security-vulnerability-monitoring.yml)

### External Links

- [Grype Documentation](https://github.com/anchore/grype)
- [Alpine Linux Security](https://security.alpinelinux.org/)
- [Hono Security Advisories](https://github.com/honojs/hono/security/advisories)
- [npm Security Best Practices](https://docs.npmjs.com/security-best-practices)

### Internal Links

- [Security Model](./SECURITY_MODEL.md)
- [Terraform State Security](./TERRAFORM_STATE_SECURITY.md)
- [Testing & CI/CD](../../.specify/specs/011-qa-testing/TESTING_CI_CD_CONFIG.md)

---

**Document Owner:** Security Team (Claude-QA)
**Last Review:** 2026-02-12
**Next Review:** 2026-05-12 (Q2 Quarterly Review)
