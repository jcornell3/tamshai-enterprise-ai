# Architecture v1.4: Human-in-the-Loop Confirmation Flow

**Version**: 1.4
**Created**: December 2024
**Purpose**: Diagram showing the confirmation flow for write operations (Section 5.6)

---

## Confirmation Flow Sequence

```
┌──────────┐         ┌──────────────┐         ┌─────────────┐         ┌──────────┐
│  Client  │         │ MCP Gateway  │         │  MCP Server │         │  Redis   │
│ (Web/App)│         │  (Port 3100) │         │ (HR/Finance)│         │ (Cache)  │
└────┬─────┘         └──────┬───────┘         └──────┬──────┘         └────┬─────┘
     │                      │                        │                     │
     │                      │                        │                     │
     │  1. User: "Delete   │                        │                     │
     │     employee John"  │                        │                     │
     ├─────────────────────>│                        │                     │
     │   POST /api/query   │                        │                     │
     │   { query: "..." }  │                        │                     │
     │                      │                        │                     │
     │                      │  2. Call delete_employee tool                │
     │                      ├───────────────────────>│                     │
     │                      │                        │                     │
     │                      │                        │  3. Generate UUID  │
     │                      │                        │     confirmationId │
     │                      │                        │                     │
     │                      │                        │  4. Store pending  │
     │                      │                        │     action         │
     │                      │                        ├────────────────────>│
     │                      │                        │  SETEX pending:abc  │
     │                      │                        │  TTL: 300 seconds   │
     │                      │                        │  { action, data }   │
     │                      │                        │<────────────────────┤
     │                      │                        │     OK              │
     │                      │                        │                     │
     │                      │  5. Return pending_confirmation              │
     │                      │<───────────────────────┤                     │
     │                      │  {                     │                     │
     │                      │    status: 'pending',  │                     │
     │                      │    confirmationId,     │                     │
     │                      │    message: "⚠️..."    │                     │
     │                      │  }                     │                     │
     │                      │                        │                     │
     │  6. Render Approval │                        │                     │
     │     Card Component  │                        │                     │
     │<─────────────────────┤                        │                     │
     │                      │                        │                     │
     │                      │                        │                     │
     │ ┌────────────────────────────────┐            │                     │
     │ │  ⚠️ Confirm Action Required    │            │                     │
     │ │                                │            │                     │
     │ │  Delete John Doe (john@...)   │            │                     │
     │ │                                │            │                     │
     │ │  This will permanently delete  │            │                     │
     │ │  the employee record.          │            │                     │
     │ │                                │            │                     │
     │ │  [Approve]        [Reject]     │            │                     │
     │ └────────────────────────────────┘            │                     │
     │                      │                        │                     │
     │                      │                        │                     │
     │  7. User clicks     │                        │                     │
     │     "Approve"       │                        │                     │
     ├─────────────────────>│                        │                     │
     │  POST /api/confirm/:confirmationId           │                     │
     │  { approved: true } │                        │                     │
     │                      │                        │                     │
     │                      │  8. Retrieve pending action                  │
     │                      ├────────────────────────────────────────────>│
     │                      │         GET pending:abc                     │
     │                      │<────────────────────────────────────────────┤
     │                      │  { action: 'delete_employee', data: {...} }  │
     │                      │                        │                     │
     │                      │  9. Execute action     │                     │
     │                      ├───────────────────────>│                     │
     │                      │  executeDeleteEmployee │                     │
     │                      │                        │                     │
     │                      │                        │  DELETE FROM        │
     │                      │                        │  hr.employees       │
     │                      │                        │  WHERE id = ...     │
     │                      │                        │                     │
     │                      │  10. Success           │                     │
     │                      │<───────────────────────┤                     │
     │                      │  { status: 'success' } │                     │
     │                      │                        │                     │
     │                      │  11. Delete confirmation from cache          │
     │                      ├────────────────────────────────────────────>│
     │                      │         DEL pending:abc                     │
     │                      │<────────────────────────────────────────────┤
     │                      │            OK                               │
     │                      │                        │                     │
     │  12. Success message│                        │                     │
     │<─────────────────────┤                        │                     │
     │  "✅ Employee deleted successfully"          │                     │
     │                      │                        │                     │
```

---

## Alternative Flow: User Rejects

```
Step 7: User clicks "Reject"
     │
     ├─────────────────────>│
     │  POST /api/confirm/:confirmationId
     │  { approved: false }│
     │                      │
     │                      │  Delete confirmation from cache
     │                      ├────────────────────────────────────────────>│
     │                      │         DEL pending:abc                     │
     │                      │<────────────────────────────────────────────┤
     │                      │            OK                               │
     │                      │                        │                     │
     │  Cancellation msg   │                        │                     │
     │<─────────────────────┤                        │                     │
     │  "❌ Action cancelled"                        │                     │
     │                      │                        │                     │
```

---

## Alternative Flow: Timeout Expires

```
User waits > 5 minutes without clicking Approve/Reject
     │
     │  Redis TTL expires
     │                      │                        │                     │
     │                      │                        │  [After 5 minutes]  │
     │                      │                        │  Redis auto-deletes │
     │                      │                        │  pending:abc        │
     │                      │                        │                     │
     │  User finally clicks│                        │                     │
     │  "Approve"          │                        │                     │
     ├─────────────────────>│                        │                     │
     │  POST /api/confirm/:confirmationId           │                     │
     │  { approved: true } │                        │                     │
     │                      │                        │                     │
     │                      │  Retrieve pending action                     │
     │                      ├────────────────────────────────────────────>│
     │                      │         GET pending:abc                     │
     │                      │<────────────────────────────────────────────┤
     │                      │            null (expired)                   │
     │                      │                        │                     │
     │  Error: Expired     │                        │                     │
     │<─────────────────────┤                        │                     │
     │  "⏱️ Confirmation expired. Please retry."     │                     │
     │                      │                        │                     │
```

---

## Key Components

### 1. MCP Server Write Tool
**File**: `services/mcp-hr/src/tools/delete-employee.ts`

**Responsibilities**:
- Check user permissions (hr-write or executive role)
- Generate confirmation ID (UUID)
- Store pending action in Redis with 5-minute TTL
- Return `pending_confirmation` response

**Response Structure**:
```typescript
{
  status: 'pending_confirmation',
  confirmationId: '550e8400-e29b-41d4-a716-446655440000',
  message: '⚠️ Delete employee John Doe (john.doe@tamshai.com)?\n\nThis action will permanently delete the employee record and cannot be undone.',
  confirmationData: {
    action: 'delete_employee',
    employeeId: 'emp-123',
    employeeName: 'John Doe',
    employeeEmail: 'john.doe@tamshai.com'
  }
}
```

### 2. Gateway Confirmation Endpoint
**File**: `services/mcp-gateway/src/index.ts`
**Route**: `POST /api/confirm/:confirmationId`

**Responsibilities**:
- Validate JWT token
- Retrieve pending action from Redis
- If approved: Execute action via MCP server
- If rejected: Delete confirmation and return cancelled status
- Handle expiry (404 if confirmation not found)

### 3. Redis Storage
**Key Pattern**: `pending:{confirmationId}`
**TTL**: 300 seconds (5 minutes)

**Stored Data**:
```json
{
  "action": "delete_employee",
  "employeeId": "emp-123",
  "userId": "user-456",
  "timestamp": 1701964800000,
  "mcpServer": "mcp-hr"
}
```

### 4. Client Approval Card Component
**Files**:
- Web: `clients/web/apps/hr/src/components/ApprovalCard.tsx`
- Desktop: `clients/desktop/src/renderer/components/ApprovalCard.tsx`

**Responsibilities**:
- Render yellow warning UI with action details
- Provide Approve/Reject buttons
- Send POST request to confirmation endpoint
- Display success/failure/expiry messages

---

## Security Considerations

### 1. Authorization
- User's JWT token validated on confirmation endpoint
- MCP server re-checks permissions before executing action
- Confirmation data includes original user ID for audit trail

### 2. Expiry
- 5-minute TTL prevents stale confirmations
- Redis auto-deletes expired confirmations
- Gateway returns 404 for expired confirmations

### 3. Audit Trail
- Initial request logged with user context
- Confirmation stored/retrieved events logged
- Final action execution logged with approval timestamp

### 4. Race Conditions
- Confirmation ID is unique UUID
- Redis GET + DEL operations ensure single execution
- If user clicks Approve twice, second request gets 404 (already deleted)

---

## Implementation Files

### Backend
- [.specify/specs/003-mcp-core/spec.md](.specify/specs/003-mcp-core/spec.md) - Gateway confirmation endpoint
- [.specify/specs/004-mcp-suite/spec.md](.specify/specs/004-mcp-suite/spec.md) - MCP write tools (8 total)

### Frontend
- [.specify/specs/005-sample-apps/spec.md](.specify/specs/005-sample-apps/spec.md) - Web Approval Card
- [.specify/specs/006-ai-desktop/spec.md](.specify/specs/006-ai-desktop/spec.md) - Desktop Approval Card

### Status
- [.specify/V1.4_UPDATE_STATUS.md](.specify/V1.4_UPDATE_STATUS.md) - Overall v1.4 implementation status

---

**Related Documentation**:
- [Architecture Overview](../overview.md) - Section 1.3 (v1.4 enhancements)
- [Security Model](../security-model.md) - Defense-in-depth layers
- [CLAUDE.md](../../CLAUDE.md) - v1.4 development patterns
