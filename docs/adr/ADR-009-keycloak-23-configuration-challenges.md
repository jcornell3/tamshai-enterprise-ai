# ADR-009: Keycloak 23 Configuration Challenges

<!--
JSON-LD metadata for machine readability
-->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "name": "ADR-009: Keycloak 23 Configuration Challenges",
  "headline": "Lessons Learned from Keycloak 23 Integration and Configuration",
  "description": "Documents the extensive debugging and configuration challenges encountered integrating Keycloak 23 with the enterprise AI system",
  "datePublished": "2025-12-28",
  "dateModified": "2026-01-21",
  "keywords": ["keycloak", "authentication", "oauth", "oidc", "configuration", "debugging"],
  "learningResourceType": "failure-analysis",
  "articleSection": "Architecture Decision Record",
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Tamshai Project Journey"
  },
  "about": [
    { "@type": "SoftwareApplication", "name": "Keycloak" }
  ],
  "author": {
    "@type": "Organization",
    "name": "Tamshai Corp"
  }
}
</script>

## Status

**Accepted** (December 2025)

## Context

Keycloak 23 is the identity provider for the Tamshai Enterprise AI system, handling:
- User authentication (username/password + TOTP)
- OIDC/OAuth 2.0 token issuance
- Role-based access control (RBAC)
- Group-to-role mapping

**Challenge**: Keycloak 23 configuration proved significantly more complex than anticipated, resulting in 16 separate debugging sessions documented in December 2025.

## Decision

Document all Keycloak configuration patterns and anti-patterns discovered during integration, and establish environment-specific configuration management.

### Key Configuration Discoveries

#### 1. Audience Mapper Requirement

**Problem**: MCP Gateway rejected tokens with "invalid audience" errors.

**Solution**: Clients need an explicit audience mapper:

```json
{
  "name": "mcp-gateway-audience",
  "protocol": "openid-connect",
  "protocolMapper": "oidc-audience-mapper",
  "config": {
    "included.client.audience": "mcp-gateway",
    "access.token.claim": "true"
  }
}
```

#### 2. TOTP Secret Format

**Problem**: TOTP codes generated by oathtool didn't match Keycloak.

**Root Cause**: Keycloak stores secrets in **raw format**, not BASE32.

```json
// WRONG - causes double-encoding
"secretData": "{\"value\":\"JBSWY3DPEHPK3PXP\"}"

// CORRECT - raw secret
"secretData": "{\"value\":\"TamshaiTestKey123\"}"
```

#### 3. Realm Import Behavior

**Problem**: `--import-realm` doesn't overwrite existing users.

| Scenario | User Exists? | What Happens |
|----------|-------------|--------------|
| Fresh import | No | User created with TOTP |
| Re-import | Yes | User untouched, TOTP preserved |
| Realm deleted + import | No | User created with TOTP |

#### 4. Group Role Inheritance

**Problem**: Users had groups but no roles in tokens.

**Solution**: Groups must have realm roles assigned, not just exist:

```json
{
  "name": "C-Suite",
  "realmRoles": ["executive", "manager"]  // Required!
}
```

### Environment-Specific Patterns

| Environment | Realm Export | User Provisioning | TOTP Management |
|-------------|--------------|-------------------|-----------------|
| Dev | `realm-export-dev.json` | Pre-seeded + identity-sync | Hardcoded in realm |
| Stage | `realm-export-stage.json` | identity-sync | GitHub Secrets |
| Prod | `realm-export.json` | Manual + test-user.journey | GitHub Secrets + manual |

## Alternatives Considered

### Use Keycloak Terraform Provider

**Partially Adopted**:
- Terraform manages some resources
- Realm export still needed for complex configurations
- Provider lacks support for all Keycloak features

### Switch to Auth0/Okta

**Rejected because**:
- Significant cost increase
- Loss of on-premise deployment option
- Keycloak issues were configuration, not capability

### Simpler Auth (JWT only)

**Rejected because**:
- Need MFA (TOTP) support
- Need group-based RBAC
- Enterprise compliance requires full IdP

## Consequences

### Positive

- **Deep Understanding**: Team now expert in Keycloak configuration
- **Comprehensive Docs**: 16 debugging files capture all edge cases
- **Reproducible**: sync-realm.sh handles all configuration
- **Environment Parity**: Same patterns work across dev/stage/prod

### Negative

- **Time Investment**: ~40 hours of debugging in December 2025
- **Complexity**: Keycloak configuration is intricate
- **Fragility**: Small mistakes cause auth failures

### Documentation Produced

| File | Content |
|------|---------|
| `docs/archived/keycloak-debugging-2025-12/` | 16 investigation logs |
| `docs/troubleshooting/KEYCLOAK_23_DEEP_DIVE.md` | Technical analysis |
| `docs/keycloak/DEV_PROD_CONFIG_DIFFERENCES.md` | Environment differences |
| `keycloak/scripts/sync-realm.sh` | Idempotent configuration script |

### Key Lessons

1. **Test TOTP Early**: TOTP issues are subtle and hard to debug
2. **Validate Tokens**: Always decode JWT to verify claims
3. **Use sync-realm.sh**: Don't configure Keycloak manually
4. **Document Everything**: Future debugging will reference these docs
5. **Environment Variables**: Never hardcode secrets in realm exports

## References

- `docs/archived/keycloak-debugging-2025-12/` - All 16 debugging sessions
- `docs/troubleshooting/KEYCLOAK_23_DEEP_DIVE.md` - Technical deep dive
- `docs/keycloak/DEV_PROD_CONFIG_DIFFERENCES.md` - Environment differences
- `keycloak/scripts/sync-realm.sh` - Configuration sync script

## Related Decisions

- ADR-001: Desktop Client Migration (OAuth issues in Electron/React Native)
- ADR-003: Nginx to Caddy Migration (simplified Keycloak reverse proxy)
- ADR-010: Test User TOTP Strategy (born from TOTP debugging)
- ADR-012: User Application Access Issues (group assignment problems)

---

*This ADR is part of the Tamshai Project Journey - 40 hours of debugging distilled into reusable patterns.*
