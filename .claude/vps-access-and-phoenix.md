# VPS Access & Phoenix Rebuild Reference

## SSH Access to VPS

### Method 1: Local Terraform Key (fastest)

```bash
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29
```

- Key location: `infrastructure/terraform/vps/.keys/deploy_key`
- VPS IP from terraform: `cd infrastructure/terraform/vps && terraform output vps_ip`
- User: `root`
- Hostname: `tamshai-staging`

### Method 2: Via GitHub Secrets Export (if local key unavailable)

The `VPS_SSH_KEY` secret can be retrieved via the `export-test-secrets.yml` workflow:

```bash
# 1. Trigger the export workflow
gh workflow run export-test-secrets.yml -f secret_type=all

# 2. Wait for completion, get run ID
gh run list --workflow=export-test-secrets.yml --limit=1

# 3. Download artifact
gh run download <run_id> -n secrets-export -D /tmp/secrets

# 4. Use the key
chmod 600 /tmp/secrets/VPS_SSH_KEY
ssh -i /tmp/secrets/VPS_SSH_KEY root@$(cat /tmp/secrets/VPS_HOST)

# 5. Clean up (CRITICAL: delete the run for security)
gh run delete <run_id> --yes
rm -rf /tmp/secrets
```

### How the Secrets Export Works

- Workflow: `.github/workflows/export-test-secrets.yml`
- Script: `infrastructure/terraform/vps/scripts/fetch-github-secrets.ps1`
- The PowerShell script triggers the workflow, waits for completion, downloads the artifact, reads secret files, then deletes the run
- `secret_type=all` exports everything including VPS_SSH_KEY, VPS_HOST
- `secret_type=phoenix` exports prod secrets for DR
- Artifact retention: 1 day (auto-deleted)

## VPS Diagnostics via SSH

```bash
# Check all containers
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29 \
  "docker ps --format 'table {{.Names}}\t{{.Status}}'"

# Check logs for a specific service
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29 \
  "docker logs tamshai-dev-mcp-gateway --tail 50"

# Check .env on VPS
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29 \
  "cat /opt/tamshai/.env | grep -v PASSWORD | grep -v SECRET | grep -v KEY"

# Check Docker build cache
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29 \
  "docker system df"

# Interactive shell
ssh -i infrastructure/terraform/vps/.keys/deploy_key root@5.78.159.29
```

## Container Names

Docker-compose uses `tamshai-dev-*` prefix (from `container_name` in docker-compose.yml):

| Service | Container Name |
|---------|---------------|
| Kong | tamshai-dev-kong |
| Keycloak | tamshai-dev-keycloak |
| MCP Gateway | tamshai-dev-mcp-gateway |
| MCP HR | tamshai-dev-mcp-hr |
| MCP Finance | tamshai-dev-mcp-finance |
| MCP Sales | tamshai-dev-mcp-sales |
| MCP Support | tamshai-dev-mcp-support |
| MCP Journey | tamshai-dev-mcp-journey |
| MCP Payroll | tamshai-dev-mcp-payroll |
| MCP Tax | tamshai-dev-mcp-tax |
| MCP UI | tamshai-dev-mcp-ui |
| PostgreSQL | tamshai-dev-postgres |
| MongoDB | tamshai-dev-mongodb |
| Redis | tamshai-dev-redis |
| Elasticsearch | tamshai-dev-elasticsearch |

## Phoenix Rebuild Procedure (VPS/Stage)

### Infrastructure: Hetzner Cloud via Terraform

**Location**: `infrastructure/terraform/vps/`

### Required Credentials

| Credential | Source | Required For |
|-----------|--------|-------------|
| `TF_VAR_hcloud_token` | Hetzner Cloud API | terraform apply/destroy |
| `TF_VAR_claude_api_key_stage` | Anthropic Console | cloud-init -> .env |
| `TF_VAR_domain` | User config | DNS / Caddy TLS |
| `TF_VAR_email` | User config | Let's Encrypt |

**Auto-generated by Terraform**: postgres_password, keycloak_admin_password, keycloak_db_password, mongodb_password, minio_password, jwt_secret, mcp_hr_service_secret

**Auto-updated to GitHub by Terraform**: VPS_SSH_KEY, KEYCLOAK_VPS_ADMIN_PASSWORD

**Fetched from GitHub Secrets** (via fetch-github-secrets.ps1): TEST_USER_PASSWORD, TEST_USER_TOTP_SECRET_RAW, STAGE_USER_PASSWORD

### Steps

```bash
cd infrastructure/terraform/vps

# 1. Set credentials
export TF_VAR_hcloud_token="..."
export TF_VAR_claude_api_key_stage="sk-ant-api03-..."
export TF_VAR_domain="vps.tamshai.com"
export TF_VAR_email="admin@example.com"

# 2. Destroy current VPS (IRREVERSIBLE)
terraform destroy -auto-approve

# 3. Create fresh VPS
terraform apply -auto-approve

# 4. Get new IP
terraform output vps_ip

# 5. Update DNS A record in Cloudflare (manual)

# 6. Wait for cloud-init (~10 min)
# Cloud-init: installs Docker, clones repo, creates .env, builds containers,
# syncs Keycloak, configures test-user.journey TOTP
```

### What Terraform Manages vs Docker-Compose

- **Terraform**: VPS instance, firewall, SSH keys, secret generation, cloud-init
- **Docker-Compose**: All application containers, networking, volumes, databases
- **Cloud-init** (runs once on VPS boot): bridges the two - installs Docker, creates .env from Terraform vars, runs docker compose

### Workflow Relationships

1. `terraform apply` -> creates VPS + runs cloud-init (ONE TIME)
2. `deploy-vps.yml` -> deploys code changes (AUTO on push to main)
3. `bootstrap-vps.yml` -> restart/rebuild containers (MANUAL dispatch)

### Deploy-VPS.yml Key Fixes (Feb 2026)

- SSH `ServerAliveInterval=15` — keeps connection alive during long builds
- `COMPOSE_PARALLEL_LIMIT=3` — prevents OOM from 9 parallel builds
- `cancel-in-progress: true` — prevents overlapping deploys
- Container names use `tamshai-dev-*` prefix (matching docker-compose.yml)
- Pre-deploy step ensures all required variables exist in VPS .env

### GitHub Authentication for this Repo

- Repo: `jcornell3/tamshai-enterprise-ai`
- PAT: Use `JCORNELL_GH_TOKEN` or the PAT stored in git remote URL
- Remote already has PAT embedded: check `git remote -v`
