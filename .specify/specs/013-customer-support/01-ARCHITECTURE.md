# Customer Support Portal - Architecture

## 1. System Context Diagram (C4 Level 1)

```
                     ┌──────────────────────────────────────────────────┐
                     │                  TAMSHAI CORP                     │
                     │              Enterprise AI System                 │
                     └──────────────────────────────────────────────────┘
                                            │
              ┌─────────────────────────────┼─────────────────────────────┐
              │                             │                             │
              ▼                             ▼                             ▼
    ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
    │     EMPLOYEES    │         │    CUSTOMERS     │         │  EXTERNAL APIs   │
    │  (Internal Users)│         │ (External Users) │         │   (Future)       │
    └────────┬─────────┘         └────────┬─────────┘         └──────────────────┘
             │                            │
             │ HTTPS                      │ HTTPS
             │                            │
    ┌────────▼─────────┐         ┌────────▼─────────┐
    │  Internal Portal │         │ Customer Portal  │
    │  (Employee Apps) │         │  (Support Self-  │
    │                  │         │     Service)     │
    └────────┬─────────┘         └────────┬─────────┘
             │                            │
             │       ┌────────────────────┤
             │       │                    │
             ▼       ▼                    ▼
    ┌────────────────────┐      ┌────────────────────┐
    │   KEYCLOAK         │      │   KEYCLOAK         │
    │   tamshai realm    │      │ tamshai-customers  │
    │   (Employees)      │      │     realm          │
    └────────────────────┘      └────────────────────┘
```

## 2. Container Diagram (C4 Level 2)

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              TAMSHAI ENTERPRISE AI                             │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Portal    │  │   Support   │  │  Customer   │  │ HR/Finance  │         │
│  │  (Landing)  │  │    App      │  │   Portal    │  │    Apps     │         │
│  │   :4000     │  │   :4004     │  │   :4006     │  │   :4001-03  │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │                 │
│         │    HTTPS + JWT │                │                │                 │
│         └────────────────┴────────────────┴────────────────┘                 │
│                                    │                                          │
│                                    ▼                                          │
│                          ┌─────────────────┐                                  │
│                          │  Kong Gateway   │                                  │
│                          │     :8100       │                                  │
│                          │  Rate Limiting  │                                  │
│                          │    CORS, JWT    │                                  │
│                          └────────┬────────┘                                  │
│                                   │                                           │
│                                   ▼                                           │
│                          ┌─────────────────┐                                  │
│                          │   MCP Gateway   │                                  │
│                          │     :3100       │                                  │
│                          │  AI Routing     │                                  │
│                          │  Defense-in-    │                                  │
│                          │    Depth        │                                  │
│                          └────────┬────────┘                                  │
│                                   │                                           │
│         ┌─────────────────────────┼─────────────────────────┐                 │
│         │                         │                         │                 │
│         ▼                         ▼                         ▼                 │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐           │
│  │   MCP HR    │          │ MCP Support │          │ MCP Finance │           │
│  │   :3101     │          │   :3104     │          │   :3102     │           │
│  │             │          │ ──────────  │          │             │           │
│  │             │          │ DUAL-REALM  │          │             │           │
│  │             │          │ VALIDATION  │          │             │           │
│  └──────┬──────┘          └──────┬──────┘          └──────┬──────┘           │
│         │                        │                        │                  │
│         └────────────────────────┼────────────────────────┘                  │
│                                  │                                           │
│         ┌────────────────────────┼────────────────────────┐                  │
│         │                        │                        │                  │
│         ▼                        ▼                        ▼                  │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐           │
│  │ PostgreSQL  │          │  MongoDB    │          │   Redis     │           │
│  │   :5433     │          │   :27018    │          │   :6380     │           │
│  │ HR, Payroll │          │  Tickets    │          │ Token Cache │           │
│  │             │          │  KB Articles│          │ Confirmations│          │
│  └─────────────┘          └─────────────┘          └─────────────┘           │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## 3. Component Diagram - MCP Support (C4 Level 3)

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              MCP SUPPORT SERVER                                │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        EXPRESS APPLICATION                               │ │
│  │                                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │   Health    │  │   Execute   │  │   Query     │  │   Confirm   │   │ │
│  │  │  Endpoint   │  │  Endpoint   │  │  Endpoint   │  │  Endpoint   │   │ │
│  │  │  /health    │  │  /execute   │  │  /query     │  │ /confirm/:id│   │ │
│  │  └─────────────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │ │
│  │                          │                │                │          │ │
│  └──────────────────────────┼────────────────┼────────────────┼──────────┘ │
│                             │                │                │            │
│  ┌──────────────────────────▼────────────────▼────────────────▼──────────┐ │
│  │                      AUTH MIDDLEWARE LAYER                            │ │
│  │  ┌────────────────────────────────────────────────────────────────┐  │ │
│  │  │                 DUAL-REALM TOKEN VALIDATOR                     │  │ │
│  │  │                                                                │  │ │
│  │  │  1. Extract JWT from Authorization header                      │  │ │
│  │  │  2. Try validation with tamshai JWKS                          │  │ │
│  │  │  3. If fails, try tamshai-customers JWKS                      │  │ │
│  │  │  4. Add realm indicator to UserContext                        │  │ │
│  │  │  5. Extract roles and organization_id                         │  │ │
│  │  └────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                       │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐ │
│  │                          TOOL ROUTER                                   │ │
│  │                                 │                                      │ │
│  │     ┌───────────────────────────┼───────────────────────────┐         │ │
│  │     │                           │                           │         │ │
│  │     ▼                           ▼                           ▼         │ │
│  │ ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐  │ │
│  │ │ INTERNAL TOOLS  │     │ CUSTOMER TOOLS  │     │  SHARED TOOLS   │  │ │
│  │ │ ────────────────│     │ ────────────────│     │ ────────────────│  │ │
│  │ │ search_tickets  │     │ customer_list_  │     │ search_kb       │  │ │
│  │ │ get_ticket      │     │   tickets       │     │ get_kb_article  │  │ │
│  │ │ close_ticket    │     │ customer_get_   │     │                 │  │ │
│  │ │ escalate_ticket │     │   ticket        │     │                 │  │ │
│  │ │ get_sla_summary │     │ customer_submit_│     │                 │  │ │
│  │ │ internal_get_   │     │   ticket        │     │                 │  │ │
│  │ │   organization  │     │ customer_add_   │     │                 │  │ │
│  │ │ internal_list_  │     │   comment       │     │                 │  │ │
│  │ │   org_contacts  │     │ customer_list_  │     │                 │  │ │
│  │ │ internal_view_  │     │   contacts      │     │                 │  │ │
│  │ │   customer_     │     │ customer_invite_│     │                 │  │ │
│  │ │   history       │     │   contact       │     │                 │  │ │
│  │ │                 │     │ customer_       │     │                 │  │ │
│  │ │                 │     │   transfer_lead │     │                 │  │ │
│  │ └────────┬────────┘     └────────┬────────┘     └────────┬────────┘  │ │
│  │          │                       │                       │           │ │
│  └──────────┼───────────────────────┼───────────────────────┼───────────┘ │
│             │                       │                       │             │
│  ┌──────────▼───────────────────────▼───────────────────────▼───────────┐ │
│  │                         DATABASE LAYER                               │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │ │
│  │  │   MongoDB       │  │  Elasticsearch  │  │     Redis       │     │ │
│  │  │   Backend       │  │    Backend      │  │   (Confirms)    │     │ │
│  │  │                 │  │                 │  │                 │     │ │
│  │  │ - Tickets       │  │ - KB Search     │  │ - Pending       │     │ │
│  │  │ - Organizations │  │ - Ticket Search │  │   Confirmations │     │ │
│  │  │ - Contacts      │  │                 │  │ - Token Cache   │     │ │
│  │  │ - Audit Log     │  │                 │  │                 │     │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────────┘
```

## 4. Network Topology

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                           DOCKER NETWORK: tamshai-network                      │
│                              172.30.0.0/16                                     │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────┐      ┌─────────────────────────────┐        │
│  │      EXTERNAL ACCESS        │      │      INTERNAL ONLY          │        │
│  │  (Published Ports)          │      │  (Docker Network Only)      │        │
│  └─────────────────────────────┘      └─────────────────────────────┘        │
│                                                                               │
│  Host:8100 ──► Kong Gateway ◄──────────────────────────────────────────┐     │
│  Host:8180 ──► Keycloak                                                │     │
│  Host:4000 ──► Portal                                                  │     │
│  Host:4004 ──► Support App                                             │     │
│  Host:4006 ──► Customer Portal                                         │     │
│                                                                         │     │
│                         ┌───────────────────────────────────────────────┤     │
│                         │                                               │     │
│                         ▼                                               │     │
│               ┌─────────────────┐                                       │     │
│               │   MCP Gateway   │◄──────────────────────────────────────┤     │
│               │   172.30.0.10   │                                       │     │
│               │     :3100       │                                       │     │
│               └────────┬────────┘                                       │     │
│                        │                                                │     │
│         ┌──────────────┼──────────────┬──────────────┐                 │     │
│         │              │              │              │                 │     │
│         ▼              ▼              ▼              ▼                 │     │
│   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │     │
│   │  MCP HR   │  │MCP Support│  │MCP Finance│  │MCP Payroll│          │     │
│   │172.30.0.11│  │172.30.0.14│  │172.30.0.12│  │172.30.0.16│          │     │
│   │  :3101    │  │  :3104    │  │  :3102    │  │  :3106    │          │     │
│   └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘          │     │
│         │              │              │              │                 │     │
│         └──────────────┴──────────────┴──────────────┘                 │     │
│                                │                                        │     │
│         ┌──────────────────────┼──────────────────────┐                │     │
│         │                      │                      │                │     │
│         ▼                      ▼                      ▼                │     │
│   ┌───────────┐          ┌───────────┐          ┌───────────┐         │     │
│   │PostgreSQL │          │  MongoDB  │          │   Redis   │         │     │
│   │172.30.0.50│          │172.30.0.51│          │172.30.0.52│         │     │
│   │  :5432    │          │  :27017   │          │  :6379    │         │     │
│   └───────────┘          └───────────┘          └───────────┘         │     │
│                                                                        │     │
│                      ┌───────────┐                                     │     │
│                      │ Keycloak  │◄────────────────────────────────────┘     │
│                      │172.30.0.60│                                           │
│                      │  :8080    │                                           │
│                      │           │                                           │
│                      │ Realms:   │                                           │
│                      │ - tamshai │                                           │
│                      │ - tamshai-│                                           │
│                      │   customers│                                          │
│                      └───────────┘                                           │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## 5. Sequence Diagram - Customer Authentication

```
┌────────┐     ┌──────────┐     ┌──────────────┐     ┌──────────┐     ┌───────────┐
│Customer│     │Customer  │     │   Keycloak   │     │   MCP    │     │   MCP     │
│Browser │     │Portal    │     │tamshai-      │     │ Gateway  │     │  Support  │
└───┬────┘     └────┬─────┘     │customers     │     └────┬─────┘     └─────┬─────┘
    │               │           └──────┬───────┘          │                 │
    │  Navigate to  │                  │                  │                 │
    │  /login       │                  │                  │                 │
    │──────────────►│                  │                  │                 │
    │               │                  │                  │                 │
    │               │ OIDC Auth        │                  │                 │
    │               │ (PKCE)           │                  │                 │
    │               │─────────────────►│                  │                 │
    │               │                  │                  │                 │
    │  ◄───────────────────────────────│                  │                 │
    │  Redirect to Keycloak Login      │                  │                 │
    │                                  │                  │                 │
    │  Enter Credentials               │                  │                 │
    │─────────────────────────────────►│                  │                 │
    │                                  │                  │                 │
    │  JWT + ID Token                  │                  │                 │
    │◄─────────────────────────────────│                  │                 │
    │                                  │                  │                 │
    │  /callback                       │                  │                 │
    │  (with code)                     │                  │                 │
    │──────────────►│                  │                  │                 │
    │               │                  │                  │                 │
    │               │  Exchange code   │                  │                 │
    │               │─────────────────►│                  │                 │
    │               │                  │                  │                 │
    │               │  Access Token    │                  │                 │
    │               │◄─────────────────│                  │                 │
    │               │                  │                  │                 │
    │  Dashboard    │                  │                  │                 │
    │◄──────────────│                  │                  │                 │
    │               │                  │                  │                 │
    │  List Tickets │                  │                  │                 │
    │──────────────►│                  │                  │                 │
    │               │                  │                  │                 │
    │               │  GET /api/query  │                  │                 │
    │               │  Authorization:  │                  │                 │
    │               │  Bearer <token>  │                  │                 │
    │               │────────────────────────────────────►│                 │
    │               │                  │                  │                 │
    │               │                  │                  │ customer_list_  │
    │               │                  │                  │ tickets         │
    │               │                  │                  │────────────────►│
    │               │                  │                  │                 │
    │               │                  │                  │ Validate JWT    │
    │               │                  │                  │ (tamshai-       │
    │               │                  │                  │  customers      │
    │               │                  │                  │  JWKS)          │
    │               │                  │                  │────────────────►│
    │               │                  │                  │                 │
    │               │                  │                  │ Query with      │
    │               │                  │                  │ org_id filter   │
    │               │                  │                  │◄────────────────│
    │               │                  │                  │                 │
    │               │  SSE Response    │                  │                 │
    │               │◄────────────────────────────────────│                 │
    │               │                  │                  │                 │
    │  Ticket List  │                  │                  │                 │
    │◄──────────────│                  │                  │                 │
    │               │                  │                  │                 │
```

## 6. Deployment Architecture

### 6.1 Development Environment

```
┌─────────────────────────────────────────────────────────────────┐
│                    LOCAL DEVELOPMENT                            │
│                    (Docker Compose)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Developer Machine                                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                                                          │  │
│  │  ┌─────────────┐  npm run dev                           │  │
│  │  │Customer     │─────────────────► http://localhost:4006│  │
│  │  │Portal Source│                                        │  │
│  │  └─────────────┘                                        │  │
│  │                                                          │  │
│  │  ┌─────────────┐  npm run dev                           │  │
│  │  │MCP Support  │─────────────────► http://localhost:3104│  │
│  │  │Source       │                                        │  │
│  │  └─────────────┘                                        │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                         │                                       │
│                         │ Docker Network                        │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  Docker Compose                          │  │
│  │                                                          │  │
│  │  Keycloak (:8180)  MongoDB (:27018)  Redis (:6380)      │  │
│  │  PostgreSQL (:5433)  Elasticsearch (:9201)              │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 Staging/Production (Terraform)

```
┌─────────────────────────────────────────────────────────────────┐
│                    VPS / GCP DEPLOYMENT                         │
│                    (Terraform + Docker)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                     CADDY (Reverse Proxy)                 │ │
│  │                                                           │ │
│  │  customers.tamshai.local → web-customer-support│ │
│  │  www.tamshai.local → portal                    │ │
│  │  www.tamshai.local/support → web-support       │ │
│  │  www.tamshai.local/api → kong                  │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│              ┌───────────────┼───────────────┐                 │
│              │               │               │                 │
│              ▼               ▼               ▼                 │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐     │
│  │web-customer-   │ │   portal       │ │   kong         │     │
│  │support (:4006) │ │   (:4000)      │ │   (:8100)      │     │
│  └────────────────┘ └────────────────┘ └────────────────┘     │
│                                                │                │
│                                                ▼                │
│                                        ┌────────────────┐      │
│                                        │  mcp-gateway   │      │
│                                        │   (:3100)      │      │
│                                        └────────────────┘      │
│                                                │                │
│                         ┌──────────────────────┼─────────┐     │
│                         │                      │         │     │
│                         ▼                      ▼         ▼     │
│                 ┌────────────────┐    ┌────────────────┐│     │
│                 │  mcp-support   │    │  mcp-hr, etc   ││     │
│                 │   (:3104)      │    │                ││     │
│                 └────────────────┘    └────────────────┘│     │
│                                                          │     │
└─────────────────────────────────────────────────────────────────┘
```
