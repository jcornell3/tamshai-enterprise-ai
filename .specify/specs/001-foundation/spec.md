# Specification: Foundation Infrastructure

## 1. Business Intent
**User Story:** As a platform administrator, I need a robust, containerized environment with centralized identity management so that I can securely deploy and manage future AI applications.

**Business Value:** Establishes the core security perimeter and identity source of truth (Keycloak) required for all subsequent features.

## 2. Access Control & Security (Crucial)
* **Required Role(s):** Platform Administrator
* **Data Classification:** Internal / System Configuration
* **PII Risks:** No - Infrastructure only
* **RLS Impact:** None - This phase establishes the foundation for RLS in subsequent phases

## 3. MCP Tool Definition
No MCP tools are exposed in this phase. This is pure infrastructure setup.

## 4. User Interaction Scenarios
* **Setup Scenario (Dev):** Administrator runs Terraform (`cd infrastructure/terraform/dev && terraform apply -var-file=dev.tfvars`) -> All services start -> Keycloak accessible at localhost:8180 -> Access via https://www.tamshai.local
* **Setup Scenario (Legacy):** Administrator runs `./scripts/setup-dev.sh` (deprecated) -> All services start -> Keycloak accessible at localhost:8180
* **VPS Deployment:** GitHub Actions workflow triggered -> Vault SSH authentication -> Docker Compose deployed on Hetzner VPS
* **Health Check:** Administrator runs health checks -> All services respond healthy -> Docker network isolated -> Redis cache operational.
* **Authentication Test:** Test user (alice.chen) logs in -> Keycloak authenticates -> JWT issued with roles -> Token can be validated.

## 5. Success Criteria
- [x] `docker-compose up` starts all infrastructure services without error
- [x] Keycloak is accessible at `localhost:8180`
- [x] Test users (Alice, Bob, Eve, Carol, Dan, Nina, Marcus, Frank) can log in
- [x] Redis is available for token revocation
- [x] PostgreSQL databases initialized (keycloak, tamshai_hr, tamshai_finance)
- [x] MongoDB initialized with tamshai_sales database
- [x] Elasticsearch initialized with support indices
- [x] MinIO initialized with finance-docs and public-docs buckets
- [x] Kong Gateway accessible at `localhost:8100`
- [x] Docker network `tamshai-network` (172.30.0.0/16) isolated and operational

## 6. Scope
* **Docker Compose:** Base configuration for Keycloak, Postgres, Redis, Kong, MongoDB, Elasticsearch, MinIO, Caddy (HTTPS)
* **Identity:** Realm import via Docker `--import-realm` (ADR-006) with predefined Roles (`hr-read`, `hr-write`, `finance-read`, `finance-write`, `sales-read`, `sales-write`, `support-read`, `support-write`, `manager`, `executive`) and test users
* **Databases:** Initialization of PostgreSQL schemas for Keycloak and future microservices
* **Network:** Subnet allocation (172.30.0.0/16) to avoid conflicts with existing MCP dev environment (172.28.0.0/16)
* **Multi-Environment:** CI (GitHub Actions), Dev (Terraform + Docker), VPS/Stage (Terraform + Hetzner), Prod (Terraform + GCP planned)

## 7. Technical Details
* **Port Allocation:** Custom ports to avoid conflicts (8180 for Keycloak, 5433 for Postgres, 27018 for MongoDB, etc.)
* **Environment Variables:** Stored in `.env` file (generated by Terraform from template, not committed to git)
* **Sample Data:** Test users with predefined roles and TOTP configuration
* **Authentication Flow:** OIDC with PKCE, TOTP MFA enforcement
* **Keycloak Configuration Method (ADR-006):**
  - All environments use Docker `--import-realm` flag
  - Dev/Stage: `keycloak/realm-export-dev.json` (includes test users with TOTP)
  - Production: `keycloak/realm-export.json` (no pre-configured users)
  - Benefits: Atomic setup (~30s), no Terraform timing issues, consistent across environments
* **Terraform Dev Environment:**
  - Location: `infrastructure/terraform/dev/`
  - Hosts file validation for tamshai.local
  - Caddy health check integration
  - HTTPS access via https://www.tamshai.local

## Status
**COMPLETED ✓** - This phase has been successfully implemented.

### Deployment Status (January 2026)
| Environment | Status | Notes |
|-------------|--------|-------|
| **CI** | ✅ Working | GitHub Actions with Docker Compose |
| **Dev** | ✅ Working | Terraform + Docker Desktop, Caddy HTTPS |
| **VPS/Stage** | ✅ Working | Terraform + Hetzner Cloud, Vault SSH deployment |
| **GCP/Prod** | ✅ Complete | Terraform + Cloud Run, Phase 1 deployed |

### Related ADRs
- **ADR-006**: Keycloak realm unification via Docker --import-realm
