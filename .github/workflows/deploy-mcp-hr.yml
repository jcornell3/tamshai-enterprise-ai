# Incremental Deployment: MCP HR Service
#
# This workflow deploys ONLY the MCP HR service to VPS.
# Other services are not restarted (--no-deps flag).
#
# Triggers:
#   - Push to main with changes in services/mcp-hr/
#   - Manual workflow_dispatch with environment selection
#
# Deployment Strategy:
#   1. Tag current version for rollback
#   2. Build new version
#   3. Deploy with --no-deps (no dependency restart)
#   4. Health check (30-second timeout)
#   5. Auto-rollback on health check failure
#
# Deployment Time: 1-2 minutes (vs 10-15 minutes monolithic)
# Downtime: 0-5 seconds (rolling update)

name: Deploy MCP HR

on:
  push:
    branches: [main]
    paths:
      - 'services/mcp-hr/**'
      - '.github/workflows/deploy-mcp-hr.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      rollback:
        description: 'Rollback to previous version'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-mcp-hr-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
  SERVICE_NAME: mcp-hr
  HEALTH_CHECK_URL: http://localhost:3101/health
  HEALTH_CHECK_TIMEOUT: 30

permissions:
  contents: read
  deployments: write
  id-token: write  # Required for Vault OIDC authentication

jobs:
  deploy:
    name: Deploy MCP HR to ${{ github.event.inputs.environment || 'staging' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        if: ${{ github.event.inputs.rollback != 'true' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Vault SSH
        uses: ./.github/actions/vault-ssh
        with:
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vps-host: ${{ secrets.VPS_HOST }}

      - name: Deploy MCP HR
        if: ${{ github.event.inputs.rollback != 'true' }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          set -e  # Exit on error

          cd /opt/tamshai

          echo "üì¶ Deploying MCP HR..."

          # Fix git ownership check (running as root but repo may be owned by another user)
          git config --global --add safe.directory /opt/tamshai

          # Tag current version for rollback
          echo "üè∑Ô∏è  Tagging current version..."
          docker tag tamshai/mcp-hr:latest tamshai/mcp-hr:rollback || true

          # Pull latest code
          echo "üì• Pulling latest code..."
          git pull origin main

          # Build new version
          echo "üî® Building MCP HR..."
          docker compose -f docker-compose.vps.yml build mcp-hr

          # Deploy (--no-deps = don't restart dependencies)
          echo "üöÄ Deploying MCP HR (no dependency restart)..."
          docker compose -f docker-compose.vps.yml up -d --no-deps mcp-hr

          # Health check with timeout (use docker exec - ports not exposed to host)
          echo "‚è≥ Waiting for health check..."
          for i in {1..30}; do
            if docker exec tamshai-mcp-hr wget -q -O- http://localhost:3101/health 2>/dev/null | grep -q '"healthy"'; then
              echo "‚úÖ MCP HR is healthy"
              exit 0
            fi
            echo "   Attempt $i/30..."
            sleep 1
          done

          # Health check failed - rollback
          echo "‚ùå Health check failed after 30 seconds"
          echo "üîÑ Rolling back to previous version..."
          docker tag tamshai/mcp-hr:rollback tamshai/mcp-hr:latest
          docker compose -f docker-compose.vps.yml up -d --no-deps mcp-hr

          # Verify rollback succeeded
          sleep 5
          if docker exec tamshai-mcp-hr wget -q -O- http://localhost:3101/health 2>/dev/null | grep -q '"healthy"'; then
            echo "‚úÖ Rollback successful"
          else
            echo "‚ùå Rollback failed - manual intervention required"
          fi

          exit 1
          EOF

      - name: Rollback MCP HR
        if: ${{ github.event.inputs.rollback == 'true' }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          set -e

          cd /opt/tamshai

          echo "üîÑ Rolling back MCP HR..."

          # Restore rollback tag
          docker tag tamshai/mcp-hr:rollback tamshai/mcp-hr:latest

          # Redeploy with rollback version
          docker compose -f docker-compose.vps.yml up -d --no-deps mcp-hr

          # Health check (use docker exec - ports not exposed to host)
          echo "‚è≥ Verifying rollback..."
          for i in {1..30}; do
            if docker exec tamshai-mcp-hr wget -q -O- http://localhost:3101/health 2>/dev/null | grep -q '"healthy"'; then
              echo "‚úÖ Rollback successful"
              exit 0
            fi
            sleep 1
          done

          echo "‚ùå Rollback health check failed"
          exit 1
          EOF

      - name: Deployment summary
        if: success()
        run: |
          echo "## ‚úÖ MCP HR Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: mcp-hr" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check**: PASSED" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: failure()
        run: |
          echo "## ‚ùå MCP HR Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: mcp-hr" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check**: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: Auto-rollback performed" >> $GITHUB_STEP_SUMMARY
