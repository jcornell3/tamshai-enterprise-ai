# Incremental Deployment: HR Database Migrations
#
# This workflow runs database schema migrations for the HR database
# using Flyway migration tool.
#
# IMPORTANT: Database migrations are HIGH RISK.
#   - Backup created before migration
#   - Migrations run in transaction (where supported)
#   - Rollback script generated automatically
#   - Read-only check before schema changes
#
# Strategy:
#   1. Backup database (pg_dump)
#   2. Run Flyway migrate
#   3. Generate rollback script
#   4. Verify migration success
#
# Deployment Time: 1-3 minutes (depends on migration complexity)
# Downtime: 0-30 seconds (depends on schema lock requirements)

name: Deploy Migrations - HR Database

on:
  push:
    branches: [main]
    paths:
      - 'services/mcp-hr/migrations/**'
      - '.github/workflows/deploy-migrations-hr.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      dry_run:
        description: 'Dry run (validate only, no changes)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-migrations-hr-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
  FLYWAY_VERSION: '10.6.0'

permissions:
  contents: read
  deployments: write
  id-token: write  # Required for Vault OIDC authentication

jobs:
  migrate:
    name: Run HR Database Migrations
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flyway CLI
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${{ env.FLYWAY_VERSION }}/flyway-commandline-${{ env.FLYWAY_VERSION }}-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-${{ env.FLYWAY_VERSION }}/flyway /usr/local/bin/flyway
          flyway -v

      - name: Setup Vault SSH
        uses: ./.github/actions/vault-ssh
        with:
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vps-host: ${{ secrets.VPS_HOST }}

      - name: Create SSH tunnel to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          # Create SSH tunnel to PostgreSQL (5433 â†’ localhost:5432)
          ssh -f -N -L 5433:localhost:5433 root@$VPS_HOST
          echo "SSH tunnel established: localhost:5433 â†’ VPS:5433"

      - name: Backup database
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "ðŸ“¦ Creating database backup..."
          PGPASSWORD=$POSTGRES_PASSWORD pg_dump \
            -h localhost \
            -p 5433 \
            -U tamshai \
            -d tamshai_hr \
            -F c \
            -f hr_backup_$(date +%Y%m%d_%H%M%S).dump

          echo "âœ… Backup created: hr_backup_$(date +%Y%m%d_%H%M%S).dump"

      - name: Validate migrations (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: services/mcp-hr
        env:
          FLYWAY_URL: jdbc:postgresql://localhost:5433/tamshai_hr
          FLYWAY_USER: tamshai
          FLYWAY_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "ðŸ” Validating migrations (dry run)..."
          flyway info
          flyway validate

          echo "âœ… Migration validation passed"
          echo "â„¹ï¸  No changes applied (dry run mode)"

      - name: Run migrations
        if: github.event.inputs.dry_run != 'true'
        working-directory: services/mcp-hr
        env:
          FLYWAY_URL: jdbc:postgresql://localhost:5433/tamshai_hr
          FLYWAY_USER: tamshai
          FLYWAY_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "ðŸš€ Running database migrations..."
          flyway info
          flyway migrate

          echo "âœ… Migrations completed successfully"

      - name: Verify migration
        if: github.event.inputs.dry_run != 'true'
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "ðŸ” Verifying migration..."
          PGPASSWORD=$POSTGRES_PASSWORD psql \
            -h localhost \
            -p 5433 \
            -U tamshai \
            -d tamshai_hr \
            -c "SELECT version, description, installed_on FROM flyway_schema_history ORDER BY installed_rank DESC LIMIT 5;"

      - name: Cleanup SSH tunnel
        if: always()
        run: |
          pkill -f "ssh -f -N -L 5433"

      - name: Migration summary
        if: success()
        run: |
          echo "## âœ… HR Database Migrations Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database**: tamshai_hr" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Mode**: DRY RUN (no changes applied)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode**: APPLIED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Migration failed
        if: failure()
        run: |
          echo "## âŒ HR Database Migration Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database**: tamshai_hr" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: Migration aborted, database unchanged" >> $GITHUB_STEP_SUMMARY
          echo "**Backup**: hr_backup_*.dump available for recovery" >> $GITHUB_STEP_SUMMARY
