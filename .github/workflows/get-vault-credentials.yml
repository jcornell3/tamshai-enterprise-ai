# Retrieve Vault Credentials from VPS
#
# This workflow retrieves the Vault credentials from /root/vault-init.txt
# and displays them in the job summary for manual addition to GitHub Secrets.
#
# SECURITY: The credentials are displayed in the job summary which is only
# visible to users with repository access. Delete the workflow run after
# copying the credentials.

name: Get Vault Credentials

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  get-credentials:
    name: Retrieve Vault Credentials
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Retrieve credentials
        id: creds
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          # Get the init file content
          INIT_CONTENT=$(ssh $VPS_USER@$VPS_HOST "cat /root/vault-init.txt 2>/dev/null" || echo "FILE_NOT_FOUND")

          if [ "$INIT_CONTENT" = "FILE_NOT_FOUND" ]; then
            echo "::error::Vault init file not found at /root/vault-init.txt"
            exit 1
          fi

          # Extract values
          KEY1=$(echo "$INIT_CONTENT" | grep 'Unseal Key 1:' | awk '{print $NF}')
          KEY2=$(echo "$INIT_CONTENT" | grep 'Unseal Key 2:' | awk '{print $NF}')
          KEY3=$(echo "$INIT_CONTENT" | grep 'Unseal Key 3:' | awk '{print $NF}')
          KEY4=$(echo "$INIT_CONTENT" | grep 'Unseal Key 4:' | awk '{print $NF}')
          KEY5=$(echo "$INIT_CONTENT" | grep 'Unseal Key 5:' | awk '{print $NF}')
          TOKEN=$(echo "$INIT_CONTENT" | grep 'Initial Root Token:' | awk '{print $NF}')

          # Output to summary (visible only to repo users)
          echo "## Vault Credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these to GitHub Secrets (Settings > Secrets > Actions):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_UNSEAL_KEY_1 | \`$KEY1\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_UNSEAL_KEY_2 | \`$KEY2\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_UNSEAL_KEY_3 | \`$KEY3\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_UNSEAL_KEY_4 | \`$KEY4\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_UNSEAL_KEY_5 | \`$KEY5\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_ROOT_TOKEN | \`$TOKEN\` |" >> $GITHUB_STEP_SUMMARY
          echo "| VAULT_ADDR | \`https://${{ secrets.VPS_HOST }}:8200\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IMPORTANT**: After copying these values:" >> $GITHUB_STEP_SUMMARY
          echo "1. Delete this workflow run to remove credentials from logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Consider deleting /root/vault-init.txt from VPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To delete the init file from VPS:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@${{ secrets.VPS_HOST }} 'rm /root/vault-init.txt'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "Credentials written to job summary"
