# =============================================================================
# Full E2E Test Suite - All Playwright Projects
# =============================================================================
#
# Starts the complete Docker Compose stack (databases, Keycloak, MCP servers,
# web apps, Caddy) and runs all 3 Playwright projects: api, customer, employee.
#
# The main CI workflow (ci.yml) only runs --project=api with minimal infra.
# This workflow resolves the ~380 skipped browser tests that require full infra.
#
# Trigger: push to main, manual dispatch
# Runtime: ~10-15 minutes
# =============================================================================

name: Full E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-full:
    name: Full E2E Suite (Docker Compose)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      # -----------------------------------------------------------------------
      # 2. Add /etc/hosts entries for local domain routing
      # -----------------------------------------------------------------------
      - name: Configure /etc/hosts
        run: |
          echo "127.0.0.1 tamshai.local www.tamshai.local customers.tamshai.local" | sudo tee -a /etc/hosts

      # -----------------------------------------------------------------------
      # 3. Create .env file from secrets + dev defaults
      # -----------------------------------------------------------------------
      - name: Create Docker Compose .env
        working-directory: infrastructure/docker
        run: |
          cat > .env << 'ENVEOF'
          # =============================================================================
          # CI Environment - Generated by e2e-full.yml
          # =============================================================================

          # Database Credentials (dev defaults - not real secrets)
          POSTGRES_PASSWORD=ci-postgres-password
          TAMSHAI_DB_PASSWORD=ci-tamshai-password
          KEYCLOAK_DB_PASSWORD=ci-keycloak-db-password
          MONGODB_PASSWORD=ci-mongodb-password

          # Keycloak
          KEYCLOAK_ADMIN=admin
          KEYCLOAK_ADMIN_PASSWORD=ci-admin-password
          KEYCLOAK_CUSTOMER_REALM=tamshai-customers

          # Redis
          REDIS_PASSWORD=ci-redis-password

          # MinIO
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=ci-minio-password

          # Elasticsearch
          ELASTIC_PASSWORD=ci-elastic-password

          # MCP Gateway (placeholder - E2E tests don't call Claude)
          CLAUDE_API_KEY=sk-ant-placeholder-not-used-in-e2e
          MCP_INTERNAL_SECRET=ci-internal-secret-for-e2e-testing-only
          E2E_ADMIN_API_KEY=ci-e2e-admin-api-key

          # Vault
          VAULT_DEV_ROOT_TOKEN=ci-vault-token

          # Environment
          ENVIRONMENT=dev
          NODE_ENV=dev

          # Ports (8443 matches KC_HOSTNAME_URL hardcoded in docker-compose.yml)
          PORT_CADDY_HTTP=8080
          PORT_CADDY_HTTPS=8443
          PORT_KEYCLOAK=8180
          PORT_KONG_PROXY=8100
          PORT_KONG_ADMIN=8101
          PORT_VAULT=8200
          PORT_POSTGRES=5433
          PORT_MONGODB=27018
          PORT_REDIS=6380
          PORT_ELASTICSEARCH=9201
          PORT_MINIO_API=9100
          PORT_MINIO_CONSOLE=9102
          PORT_MCP_GATEWAY=3100
          PORT_MCP_HR=3101
          PORT_MCP_FINANCE=3102
          PORT_MCP_SALES=3103
          PORT_MCP_SUPPORT=3104
          PORT_MCP_JOURNEY=3105
          PORT_MCP_PAYROLL=3106
          PORT_MCP_TAX=3107
          PORT_MCP_UI=3108
          PORT_WEB_PORTAL=4000
          PORT_WEB_HR=4001
          PORT_WEB_FINANCE=4002
          PORT_WEB_SALES=4003
          PORT_WEB_SUPPORT=4004
          PORT_WEB_PAYROLL=4005
          PORT_WEB_TAX=4006
          PORT_WEB_CUSTOMER_SUPPORT=4007
          PORT_WEBSITE=8080
          ENVEOF

          # Append secrets from GitHub Secrets (avoid embedding in heredoc)
          echo "" >> .env
          echo "# Secrets from GitHub" >> .env
          echo "MCP_GATEWAY_CLIENT_SECRET=${MCP_GATEWAY_CLIENT_SECRET}" >> .env
          echo "MCP_HR_SERVICE_CLIENT_SECRET=${MCP_HR_SERVICE_CLIENT_SECRET}" >> .env
          echo "MCP_UI_CLIENT_SECRET=${MCP_UI_CLIENT_SECRET:-mcp-ui-secret}" >> .env
          echo "MCP_INTEGRATION_RUNNER_SECRET=" >> .env
          echo "GEMINI_API_KEY=" >> .env
          echo "DEV_USER_PASSWORD=${DEV_USER_PASSWORD}" >> .env
          echo "TEST_USER_PASSWORD=${TEST_USER_PASSWORD}" >> .env
          echo "CUSTOMER_USER_PASSWORD=${CUSTOMER_USER_PASSWORD}" >> .env
        env:
          MCP_GATEWAY_CLIENT_SECRET: ${{ secrets.MCP_GATEWAY_CLIENT_SECRET }}
          MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.MCP_HR_SERVICE_CLIENT_SECRET }}
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          CUSTOMER_USER_PASSWORD: ${{ secrets.CUSTOMER_USER_PASSWORD }}

      # -----------------------------------------------------------------------
      # 4. Set Elasticsearch kernel parameter
      # -----------------------------------------------------------------------
      - name: Set vm.max_map_count for Elasticsearch
        run: sudo sysctl -w vm.max_map_count=262144

      # -----------------------------------------------------------------------
      # 5. Start Docker Compose (runtime services only, no init containers)
      # -----------------------------------------------------------------------
      - name: Start Docker Compose stack
        working-directory: infrastructure/docker
        run: |
          docker compose up -d \
            redis postgres mongodb elasticsearch minio \
            keycloak kong caddy \
            mcp-gateway mcp-hr mcp-finance mcp-sales mcp-support mcp-payroll mcp-tax mcp-ui \
            web-portal web-hr web-finance web-sales web-support web-payroll web-tax web-customer-support \
            tamshai-website

      # -----------------------------------------------------------------------
      # 6. Wait for services to be healthy
      # -----------------------------------------------------------------------
      - name: Wait for services healthy
        timeout-minutes: 5
        run: |
          echo "Waiting for Caddy (HTTPS reverse proxy)..."
          for i in $(seq 1 60); do
            if curl -sfk https://www.tamshai.local:8443/ > /dev/null 2>&1; then
              echo "Caddy is ready (attempt $i)"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "ERROR: Caddy did not become ready within 5 minutes"
              cd infrastructure/docker && docker compose ps && docker compose logs caddy --tail=50
              exit 1
            fi
            sleep 5
          done

          echo "Waiting for Keycloak..."
          for i in $(seq 1 60); do
            if curl -sfk https://www.tamshai.local:8443/auth/realms/tamshai-corp > /dev/null 2>&1; then
              echo "Keycloak is ready (attempt $i)"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "ERROR: Keycloak did not become ready"
              cd infrastructure/docker && docker compose logs keycloak --tail=50
              exit 1
            fi
            sleep 5
          done

          echo "Verifying MCP Gateway via Kong..."
          curl -sf http://localhost:8100/api/health || echo "WARNING: Kong/MCP Gateway health check failed (may need init containers first)"

      # -----------------------------------------------------------------------
      # 7. Run init containers (keycloak-sync, identity-sync, elasticsearch-init)
      # -----------------------------------------------------------------------
      - name: Run init containers
        working-directory: infrastructure/docker
        run: |
          echo "Running keycloak-sync..."
          docker compose run --rm keycloak-sync

          echo "Running identity-sync..."
          docker compose run --rm identity-sync

          echo "Running elasticsearch-init..."
          docker compose run --rm elasticsearch-init

          echo "Running minio-init..."
          docker compose run --rm minio-init

      # -----------------------------------------------------------------------
      # 8. Install Playwright and browsers
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: 20

      - name: Install Playwright dependencies
        working-directory: tests/e2e
        run: |
          npm ci
          npx playwright install chromium --with-deps

      # -----------------------------------------------------------------------
      # 9. Install oathtool for TOTP generation
      # -----------------------------------------------------------------------
      - name: Install oathtool
        run: sudo apt-get install -y oathtool

      # -----------------------------------------------------------------------
      # 10. Run all Playwright projects
      # -----------------------------------------------------------------------
      - name: Run full E2E test suite
        working-directory: tests/e2e
        run: npx playwright test
        env:
          CI: "true"
          TEST_ENV: dev
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_USER_TOTP_SECRET: ${{ secrets.TEST_USER_TOTP_SECRET }}
          CUSTOMER_USER_PASSWORD: ${{ secrets.CUSTOMER_USER_PASSWORD }}
          KEYCLOAK_URL: https://www.tamshai.local:8443/auth
          PORT_CADDY_HTTPS: "8443"
          PORT_MCP_GATEWAY: "3100"

      # -----------------------------------------------------------------------
      # 11. Upload Playwright report (always, even on failure)
      # -----------------------------------------------------------------------
      - name: Upload Playwright report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: playwright-report-full
          path: tests/e2e/playwright-report/
          retention-days: 7

      # -----------------------------------------------------------------------
      # 12. Debug: show docker logs on failure
      # -----------------------------------------------------------------------
      - name: Show Docker logs on failure
        if: failure()
        working-directory: infrastructure/docker
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== Keycloak Logs (last 100 lines) ==="
          docker compose logs keycloak --tail=100
          echo ""
          echo "=== MCP Gateway Logs (last 100 lines) ==="
          docker compose logs mcp-gateway --tail=100
          echo ""
          echo "=== Caddy Logs (last 50 lines) ==="
          docker compose logs caddy --tail=50
          echo ""
          echo "=== Kong Logs (last 50 lines) ==="
          docker compose logs kong --tail=50

      # -----------------------------------------------------------------------
      # 13. Cleanup
      # -----------------------------------------------------------------------
      - name: Cleanup Docker Compose
        if: always()
        working-directory: infrastructure/docker
        run: docker compose down -v
