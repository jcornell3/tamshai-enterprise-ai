# Flutter Native Builds - Windows, macOS, iOS, Android
#
# This workflow builds native Flutter applications for all supported platforms.
# It produces release artifacts that can be distributed to users.
#
# Triggers:
#   - Push to main (changes to Flutter client)
#   - Release published (production builds)
#   - Manual dispatch (with environment selection)
#
# Outputs (uploaded as artifacts):
#   - Windows: tamshai-{env}-windows.msix (installer), tamshai-{env}-windows.zip (portable)
#   - macOS: tamshai-{env}-macos.dmg (installer), tamshai-{env}-macos.zip (.app bundle)
#   - Android: tamshai-{env}.apk (sideload), tamshai-{env}.aab (Play Store)
#   - iOS: tamshai-{env}.ipa (requires Apple signing secrets)
#
# Environment Configuration:
#   - dev: Points to localhost Docker (for local testing)
#   - stage: Points to VPS (IP from Terraform output)
#   - prod: Points to production GCP (api.tamshai.com)
#
# References:
#   - docs/deployment/FLUTTER_MULTI_ENVIRONMENT_BUILDS.md
#   - .specify/specs/009-flutter-unified/spec.md

name: Build Flutter Native Apps

on:
  push:
    branches: [main]
    paths:
      - 'clients/unified_flutter/**'
      - '.github/workflows/build-flutter-native.yml'

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
        default: 'stage'
      platforms:
        description: 'Platforms to build'
        required: true
        type: choice
        options:
          - all
          - windows
          - macos
          - android
          - ios
          - desktop
          - mobile
        default: 'all'

  # Allow this workflow to be called by other workflows (e.g., create-release.yml)
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'stage'
      platforms:
        description: 'Platforms to build'
        required: true
        type: string
        default: 'all'

concurrency:
  group: build-flutter-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.29.0'  # Dart 3.7+ required for flutter_appauth ^11.0.0
  # Default to stage for push builds, can be overridden by workflow_dispatch
  BUILD_ENV: ${{ github.event.inputs.environment || 'stage' }}

permissions:
  contents: read
  actions: read

jobs:
  # =============================================================================
  # DETERMINE BUILD MATRIX
  # =============================================================================
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      build_windows: ${{ steps.matrix.outputs.build_windows }}
      build_macos: ${{ steps.matrix.outputs.build_macos }}
      build_android: ${{ steps.matrix.outputs.build_android }}
      build_ios: ${{ steps.matrix.outputs.build_ios }}
      environment: ${{ steps.matrix.outputs.environment }}
      app_suffix: ${{ steps.matrix.outputs.app_suffix }}

    steps:
      - name: Determine build matrix
        id: matrix
        run: |
          PLATFORMS="${{ github.event.inputs.platforms || 'all' }}"
          ENV="${{ github.event.inputs.environment || 'stage' }}"

          # Determine app suffix based on environment
          case $ENV in
            dev)
              APP_SUFFIX="Dev"
              ;;
            stage)
              APP_SUFFIX="Stage"
              ;;
            prod)
              APP_SUFFIX=""
              ;;
          esac

          # Determine which platforms to build
          case $PLATFORMS in
            all)
              echo "build_windows=true" >> $GITHUB_OUTPUT
              echo "build_macos=true" >> $GITHUB_OUTPUT
              echo "build_android=true" >> $GITHUB_OUTPUT
              echo "build_ios=true" >> $GITHUB_OUTPUT
              ;;
            desktop)
              echo "build_windows=true" >> $GITHUB_OUTPUT
              echo "build_macos=true" >> $GITHUB_OUTPUT
              echo "build_android=false" >> $GITHUB_OUTPUT
              echo "build_ios=false" >> $GITHUB_OUTPUT
              ;;
            mobile)
              echo "build_windows=false" >> $GITHUB_OUTPUT
              echo "build_macos=false" >> $GITHUB_OUTPUT
              echo "build_android=true" >> $GITHUB_OUTPUT
              echo "build_ios=true" >> $GITHUB_OUTPUT
              ;;
            windows)
              echo "build_windows=true" >> $GITHUB_OUTPUT
              echo "build_macos=false" >> $GITHUB_OUTPUT
              echo "build_android=false" >> $GITHUB_OUTPUT
              echo "build_ios=false" >> $GITHUB_OUTPUT
              ;;
            macos)
              echo "build_windows=false" >> $GITHUB_OUTPUT
              echo "build_macos=true" >> $GITHUB_OUTPUT
              echo "build_android=false" >> $GITHUB_OUTPUT
              echo "build_ios=false" >> $GITHUB_OUTPUT
              ;;
            android)
              echo "build_windows=false" >> $GITHUB_OUTPUT
              echo "build_macos=false" >> $GITHUB_OUTPUT
              echo "build_android=true" >> $GITHUB_OUTPUT
              echo "build_ios=false" >> $GITHUB_OUTPUT
              ;;
            ios)
              echo "build_windows=false" >> $GITHUB_OUTPUT
              echo "build_macos=false" >> $GITHUB_OUTPUT
              echo "build_android=false" >> $GITHUB_OUTPUT
              echo "build_ios=true" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "app_suffix=$APP_SUFFIX" >> $GITHUB_OUTPUT

          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **App Suffix**: $APP_SUFFIX" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: $PLATFORMS" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # WINDOWS BUILD
  # =============================================================================
  build-windows:
    name: Build Windows
    needs: setup
    if: needs.setup.outputs.build_windows == 'true'
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Clean and get dependencies
        working-directory: clients/unified_flutter
        shell: pwsh
        run: |
          # Remove Windows ephemeral folder to force fresh plugin rebuild
          if (Test-Path "windows/flutter/ephemeral") {
            Remove-Item -Recurse -Force "windows/flutter/ephemeral"
          }
          flutter clean
          flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Windows release
        working-directory: clients/unified_flutter
        run: |
          flutter build windows --release `
            --dart-define=ENV=${{ needs.setup.outputs.environment }} `
            --dart-define=APP_SUFFIX=${{ needs.setup.outputs.app_suffix }}

      - name: Create MSIX installer
        working-directory: clients/unified_flutter
        shell: pwsh
        run: |
          $env = "${{ needs.setup.outputs.environment }}"
          $suffix = "${{ needs.setup.outputs.app_suffix }}"
          $appName = if ($suffix) { "Tamshai $suffix" } else { "Tamshai" }
          $identityName = "com.tamshai.app.$env"

          # Install msix package if not already in pubspec.yaml dev_dependencies
          flutter pub add --dev msix

          # Create MSIX with environment-specific identity
          # This allows side-by-side installation of dev/stage/prod
          # Note: --install-certificate false prevents interactive prompt in CI
          # Note: --build-windows false since we already built above
          flutter pub run msix:create `
            --display-name "$appName" `
            --publisher-display-name "Tamshai Corporation" `
            --identity-name "$identityName" `
            --version "1.0.0.0" `
            --capabilities "internetClient" `
            --install-certificate false `
            --build-windows false

          # Rename MSIX to include environment
          $msixPath = Get-ChildItem -Path "build/windows/x64/runner/Release/*.msix" | Select-Object -First 1
          if ($msixPath) {
            $newName = "tamshai-$env-windows.msix"
            Move-Item -Path $msixPath.FullName -Destination "$env:GITHUB_WORKSPACE/$newName"
            echo "Created $newName"
          } else {
            echo "::warning::MSIX file not found, skipping installer"
          }

      - name: Create Windows portable archive
        shell: pwsh
        run: |
          $env = "${{ needs.setup.outputs.environment }}"
          $archiveName = "tamshai-$env-windows-portable"

          # Create archive of release folder (portable version)
          Compress-Archive `
            -Path "clients/unified_flutter/build/windows/x64/runner/Release/*" `
            -DestinationPath "$archiveName.zip"

          echo "Created $archiveName.zip"

      - name: Upload Windows MSIX installer
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-windows-msix
          path: tamshai-${{ needs.setup.outputs.environment }}-windows.msix
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Windows portable
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-windows-portable
          path: tamshai-${{ needs.setup.outputs.environment }}-windows-portable.zip
          retention-days: 30

      - name: Build summary
        run: |
          echo "## Windows Build Complete" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **App Name**: Tamshai ${{ needs.setup.outputs.app_suffix }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **MSIX Installer**: tamshai-${{ needs.setup.outputs.environment }}-windows.msix" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Portable**: tamshai-${{ needs.setup.outputs.environment }}-windows-portable.zip" >> $env:GITHUB_STEP_SUMMARY

  # =============================================================================
  # MACOS BUILD
  # =============================================================================
  build-macos:
    name: Build macOS
    needs: setup
    if: needs.setup.outputs.build_macos == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        working-directory: clients/unified_flutter
        run: flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build macOS release
        working-directory: clients/unified_flutter
        run: |
          flutter build macos --release \
            --dart-define=ENV=${{ needs.setup.outputs.environment }} \
            --dart-define=APP_SUFFIX=${{ needs.setup.outputs.app_suffix }}

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG installer
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          SUFFIX="${{ needs.setup.outputs.app_suffix }}"
          APP_NAME="Tamshai${SUFFIX:+ $SUFFIX}"
          DMG_NAME="tamshai-$ENV-macos.dmg"
          APP_PATH="clients/unified_flutter/build/macos/Build/Products/Release"

          # Find the .app bundle
          APP_BUNDLE=$(find "$APP_PATH" -name "*.app" -maxdepth 1 | head -1)

          if [ -z "$APP_BUNDLE" ]; then
            echo "::error::No .app bundle found in $APP_PATH"
            exit 1
          fi

          echo "Creating DMG from: $APP_BUNDLE"

          # Create DMG with Applications symlink for drag-and-drop install
          create-dmg \
            --volname "$APP_NAME" \
            --volicon "$APP_BUNDLE/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$(basename "$APP_BUNDLE")" 150 190 \
            --hide-extension "$(basename "$APP_BUNDLE")" \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "$GITHUB_WORKSPACE/$DMG_NAME" \
            "$APP_BUNDLE" \
            || {
              # create-dmg returns non-zero even on success sometimes
              # Check if DMG was created
              if [ -f "$GITHUB_WORKSPACE/$DMG_NAME" ]; then
                echo "DMG created successfully (ignoring create-dmg exit code)"
              else
                echo "::error::Failed to create DMG"
                exit 1
              fi
            }

          echo "Created $DMG_NAME"

      - name: Create macOS portable archive
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          ARCHIVE_NAME="tamshai-$ENV-macos-portable"

          # Create archive of .app bundle (portable version)
          cd clients/unified_flutter/build/macos/Build/Products/Release
          zip -r "$GITHUB_WORKSPACE/$ARCHIVE_NAME.zip" *.app

          echo "Created $ARCHIVE_NAME.zip"

      - name: Upload macOS DMG installer
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-macos-dmg
          path: tamshai-${{ needs.setup.outputs.environment }}-macos.dmg
          retention-days: 30

      - name: Upload macOS portable
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-macos-portable
          path: tamshai-${{ needs.setup.outputs.environment }}-macos-portable.zip
          retention-days: 30

      - name: Build summary
        run: |
          echo "## macOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: Tamshai ${{ needs.setup.outputs.app_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DMG Installer**: tamshai-${{ needs.setup.outputs.environment }}-macos.dmg" >> $GITHUB_STEP_SUMMARY
          echo "- **Portable**: tamshai-${{ needs.setup.outputs.environment }}-macos-portable.zip" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # ANDROID BUILD
  # =============================================================================
  build-android:
    name: Build Android
    needs: setup
    if: needs.setup.outputs.build_android == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Java
        uses: actions/setup-java@7a6d8a8234af8eb26422e24e3006232cccaa061b # v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        working-directory: clients/unified_flutter
        run: flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Android APK (debug-signed)
        working-directory: clients/unified_flutter
        run: |
          flutter build apk --release \
            --dart-define=ENV=${{ needs.setup.outputs.environment }} \
            --dart-define=APP_SUFFIX=${{ needs.setup.outputs.app_suffix }}

      - name: Build Android App Bundle (for Play Store)
        working-directory: clients/unified_flutter
        run: |
          flutter build appbundle --release \
            --dart-define=ENV=${{ needs.setup.outputs.environment }} \
            --dart-define=APP_SUFFIX=${{ needs.setup.outputs.app_suffix }}

      - name: Rename artifacts
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          # Rename APK
          mv clients/unified_flutter/build/app/outputs/flutter-apk/app-release.apk \
             tamshai-$ENV.apk

          # Rename AAB
          mv clients/unified_flutter/build/app/outputs/bundle/release/app-release.aab \
             tamshai-$ENV.aab

      - name: Upload Android APK
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-android-apk
          path: tamshai-${{ needs.setup.outputs.environment }}.apk
          retention-days: 30

      - name: Upload Android App Bundle
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-android-aab
          path: tamshai-${{ needs.setup.outputs.environment }}.aab
          retention-days: 30

      - name: Build summary
        run: |
          echo "## Android Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: Tamshai ${{ needs.setup.outputs.app_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK**: tamshai-${{ needs.setup.outputs.environment }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **AAB**: tamshai-${{ needs.setup.outputs.environment }}.aab (Play Store)" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # IOS BUILD
  # =============================================================================
  build-ios:
    name: Build iOS
    needs: setup
    if: needs.setup.outputs.build_ios == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        working-directory: clients/unified_flutter
        run: flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build iOS (no codesign)
        working-directory: clients/unified_flutter
        run: |
          flutter build ios --release --no-codesign \
            --dart-define=ENV=${{ needs.setup.outputs.environment }} \
            --dart-define=APP_SUFFIX=${{ needs.setup.outputs.app_suffix }}

      # Note: For actual distribution, you need:
      # 1. Apple Developer account
      # 2. Provisioning profile and certificates
      # 3. Secrets: APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD, APPLE_PROVISIONING_PROFILE
      # Then use: flutter build ipa --release

      - name: Create iOS archive (unsigned)
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          ARCHIVE_NAME="tamshai-$ENV-ios-unsigned"

          # Archive the build output (unsigned .app)
          cd clients/unified_flutter/build/ios/iphoneos
          zip -r "$GITHUB_WORKSPACE/$ARCHIVE_NAME.zip" Runner.app

          echo "Created $ARCHIVE_NAME.zip (unsigned - for development only)"

      - name: Upload iOS artifact (unsigned)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tamshai-${{ needs.setup.outputs.environment }}-ios-unsigned
          path: tamshai-${{ needs.setup.outputs.environment }}-ios-unsigned.zip
          retention-days: 30

      - name: Build summary
        run: |
          echo "## iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: Tamshai ${{ needs.setup.outputs.app_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: tamshai-${{ needs.setup.outputs.environment }}-ios-unsigned.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This is an unsigned build for development purposes." >> $GITHUB_STEP_SUMMARY
          echo "For App Store distribution, configure Apple signing secrets." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # BUILD SUMMARY
  # =============================================================================
  summary:
    name: Build Summary
    needs: [setup, build-windows, build-macos, build-android, build-ios]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate final summary
        run: |
          echo "# Flutter Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Windows status
          if [ "${{ needs.setup.outputs.build_windows }}" == "true" ]; then
            if [ "${{ needs.build-windows.result }}" == "success" ]; then
              echo "| Windows | :white_check_mark: Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Windows | :x: ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Windows | :black_square_button: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # macOS status
          if [ "${{ needs.setup.outputs.build_macos }}" == "true" ]; then
            if [ "${{ needs.build-macos.result }}" == "success" ]; then
              echo "| macOS | :white_check_mark: Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| macOS | :x: ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| macOS | :black_square_button: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Android status
          if [ "${{ needs.setup.outputs.build_android }}" == "true" ]; then
            if [ "${{ needs.build-android.result }}" == "success" ]; then
              echo "| Android | :white_check_mark: Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Android | :x: ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Android | :black_square_button: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # iOS status
          if [ "${{ needs.setup.outputs.build_ios }}" == "true" ]; then
            if [ "${{ needs.build-ios.result }}" == "success" ]; then
              echo "| iOS | :white_check_mark: Success (unsigned) |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| iOS | :x: ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| iOS | :black_square_button: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Installer | Portable |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | \`.msix\` (double-click to install) | \`.zip\` (extract and run) |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | \`.dmg\` (drag to Applications) | \`.zip\` (extract .app) |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | \`.apk\` (sideload) | \`.aab\` (Play Store) |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | \`.ipa\` (requires signing) | \`.zip\` (unsigned .app) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Actions** tab â†’ **Artifacts** section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention**: 30 days" >> $GITHUB_STEP_SUMMARY
