name: Export Test Secrets

# Exports E2E test secrets to a downloadable artifact
# Use: ./scripts/secrets/read-github-secrets.sh --e2e
#
# SECURITY: Artifact is only available for 1 day and should be deleted after use

on:
  workflow_dispatch:
    inputs:
      secret_type:
        description: 'Which secrets to export'
        required: true
        type: choice
        options:
          - e2e
          - phoenix
          - keycloak
          - user-passwords
          - all
        default: 'e2e'

jobs:
  export-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Export secrets to files
        env:
          SECRET_TYPE: ${{ inputs.secret_type }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_USER_TOTP_SECRET: ${{ secrets.TEST_USER_TOTP_SECRET }}
          TEST_USER_TOTP_SECRET_RAW: ${{ secrets.TEST_USER_TOTP_SECRET_RAW }}
          KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}
          STAGE_USER_PASSWORD: ${{ secrets.STAGE_USER_PASSWORD }}
          PROD_USER_PASSWORD: ${{ secrets.PROD_USER_PASSWORD }}
          MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.MCP_HR_SERVICE_CLIENT_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Issue #102: GCP secrets - mapped to names expected by GITHUB_TO_GCP_MAP
          CLAUDE_API_KEY_PROD: ${{ secrets.CLAUDE_API_KEY_PROD }}
          KEYCLOAK_ADMIN_PASSWORD_PROD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          KEYCLOAK_DB_PASSWORD_PROD: ${{ secrets.KEYCLOAK_DB_PASSWORD }}
          PROD_DB_PASSWORD: ${{ secrets.TAMSHAI_DB_PASSWORD }}
          MONGODB_ATLAS_URI_PROD: ${{ secrets.MONGODB_ATLAS_URI_PROD }}
        run: |
          mkdir -p secrets-export

          case "$SECRET_TYPE" in
            e2e)
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              ;;
            phoenix)
              # Secrets needed for Phoenix rebuild / DR evacuation:
              # - TOTP provisioning, user password sync, E2E tests
              # - GCP secrets sync (Issue #102)
              [ -n "$TEST_USER_TOTP_SECRET_RAW" ] && echo "$TEST_USER_TOTP_SECRET_RAW" > secrets-export/TEST_USER_TOTP_SECRET_RAW
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              # Issue #102: All GCP secrets needed by sync_secrets_from_env() / GITHUB_TO_GCP_MAP
              [ -n "$MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/MCP_HR_SERVICE_CLIENT_SECRET
              [ -n "$CLAUDE_API_KEY_PROD" ] && echo "$CLAUDE_API_KEY_PROD" > secrets-export/CLAUDE_API_KEY_PROD
              [ -n "$KEYCLOAK_ADMIN_PASSWORD_PROD" ] && echo "$KEYCLOAK_ADMIN_PASSWORD_PROD" > secrets-export/KEYCLOAK_ADMIN_PASSWORD_PROD
              [ -n "$KEYCLOAK_DB_PASSWORD_PROD" ] && echo "$KEYCLOAK_DB_PASSWORD_PROD" > secrets-export/KEYCLOAK_DB_PASSWORD_PROD
              [ -n "$PROD_DB_PASSWORD" ] && echo "$PROD_DB_PASSWORD" > secrets-export/PROD_DB_PASSWORD
              [ -n "$MONGODB_ATLAS_URI_PROD" ] && echo "$MONGODB_ATLAS_URI_PROD" > secrets-export/MONGODB_ATLAS_URI_PROD
              ;;
            keycloak)
              [ -n "$KEYCLOAK_ADMIN_PASSWORD" ] && echo "$KEYCLOAK_ADMIN_PASSWORD" > secrets-export/KEYCLOAK_ADMIN_PASSWORD
              ;;
            user-passwords)
              [ -n "$DEV_USER_PASSWORD" ] && echo "$DEV_USER_PASSWORD" > secrets-export/DEV_USER_PASSWORD
              [ -n "$STAGE_USER_PASSWORD" ] && echo "$STAGE_USER_PASSWORD" > secrets-export/STAGE_USER_PASSWORD
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              ;;
            all)
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              [ -n "$TEST_USER_TOTP_SECRET_RAW" ] && echo "$TEST_USER_TOTP_SECRET_RAW" > secrets-export/TEST_USER_TOTP_SECRET_RAW
              [ -n "$KEYCLOAK_ADMIN_PASSWORD" ] && echo "$KEYCLOAK_ADMIN_PASSWORD" > secrets-export/KEYCLOAK_ADMIN_PASSWORD
              [ -n "$DEV_USER_PASSWORD" ] && echo "$DEV_USER_PASSWORD" > secrets-export/DEV_USER_PASSWORD
              [ -n "$STAGE_USER_PASSWORD" ] && echo "$STAGE_USER_PASSWORD" > secrets-export/STAGE_USER_PASSWORD
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              [ -n "$MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/MCP_HR_SERVICE_CLIENT_SECRET
              [ -n "$CLAUDE_API_KEY_PROD" ] && echo "$CLAUDE_API_KEY_PROD" > secrets-export/CLAUDE_API_KEY_PROD
              [ -n "$GEMINI_API_KEY" ] && echo "$GEMINI_API_KEY" > secrets-export/GEMINI_API_KEY
              ;;
          esac

          echo "Exported secrets:"
          ls -la secrets-export/

      - name: Upload secrets artifact
        uses: actions/upload-artifact@v6
        with:
          name: secrets-export
          path: secrets-export/
          retention-days: 1
          if-no-files-found: error

      - name: Security reminder
        run: |
          echo "=================================================="
          echo "SECURITY REMINDER"
          echo "=================================================="
          echo "1. Download the artifact immediately"
          echo "2. Delete this workflow run after downloading"
          echo "3. Artifact auto-deletes after 24 hours"
          echo "=================================================="
