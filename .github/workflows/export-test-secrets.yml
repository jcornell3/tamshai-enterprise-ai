name: Export Test Secrets

# Exports E2E test secrets to a downloadable artifact
# Use: ./scripts/secrets/read-github-secrets.sh --e2e
#
# SECURITY: Artifact is only available for 1 day and should be deleted after use
#
# Naming Convention:
#   All environment-specific secrets use PREFIX pattern: ${ENV}_SECRET_NAME
#   Examples: DEV_MCP_GATEWAY_CLIENT_SECRET, STAGE_POSTGRES_PASSWORD, PROD_CLAUDE_API_KEY

on:
  workflow_dispatch:
    inputs:
      secret_type:
        description: 'Which secrets to export'
        required: true
        type: choice
        options:
          - integration
          - e2e
          - phoenix
          - keycloak
          - user-passwords
          - all
        default: 'integration'

jobs:
  export-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Export secrets to files
        env:
          SECRET_TYPE: ${{ inputs.secret_type }}
          # =================================================================
          # GLOBAL SECRETS (same across all environments)
          # =================================================================
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_USER_TOTP_SECRET: ${{ secrets.TEST_USER_TOTP_SECRET }}
          TEST_USER_TOTP_SECRET_RAW: ${{ secrets.TEST_USER_TOTP_SECRET_RAW }}
          CUSTOMER_USER_PASSWORD: ${{ secrets.CUSTOMER_USER_PASSWORD }}
          MCP_INTEGRATION_RUNNER_SECRET: ${{ secrets.MCP_INTEGRATION_RUNNER_SECRET }}
          # VPS access
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}

          # =================================================================
          # DEV ENVIRONMENT SECRETS (DEV_ prefix)
          # =================================================================
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}
          # Keycloak
          DEV_KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.DEV_KEYCLOAK_ADMIN_PASSWORD }}
          DEV_KEYCLOAK_DB_PASSWORD: ${{ secrets.DEV_KEYCLOAK_DB_PASSWORD }}
          # Databases
          DEV_POSTGRES_PASSWORD: ${{ secrets.DEV_POSTGRES_PASSWORD }}
          DEV_TAMSHAI_DB_PASSWORD: ${{ secrets.DEV_TAMSHAI_DB_PASSWORD }}
          DEV_MONGODB_PASSWORD: ${{ secrets.DEV_MONGODB_PASSWORD }}
          DEV_REDIS_PASSWORD: ${{ secrets.DEV_REDIS_PASSWORD }}
          # MCP secrets
          DEV_MCP_INTERNAL_SECRET: ${{ secrets.DEV_MCP_INTERNAL_SECRET }}
          DEV_MCP_GATEWAY_CLIENT_SECRET: ${{ secrets.DEV_MCP_GATEWAY_CLIENT_SECRET }}
          DEV_MCP_UI_CLIENT_SECRET: ${{ secrets.DEV_MCP_UI_CLIENT_SECRET }}
          DEV_MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.DEV_MCP_HR_SERVICE_CLIENT_SECRET }}
          # Other services
          DEV_E2E_ADMIN_API_KEY: ${{ secrets.DEV_E2E_ADMIN_API_KEY }}
          DEV_ELASTIC_PASSWORD: ${{ secrets.DEV_ELASTIC_PASSWORD }}
          DEV_MINIO_ROOT_USER: ${{ secrets.DEV_MINIO_ROOT_USER }}
          DEV_MINIO_ROOT_PASSWORD: ${{ secrets.DEV_MINIO_ROOT_PASSWORD }}
          DEV_VAULT_ROOT_TOKEN: ${{ secrets.DEV_VAULT_ROOT_TOKEN }}
          # API keys
          DEV_GEMINI_API_KEY: ${{ secrets.DEV_GEMINI_API_KEY }}
          DEV_CLAUDE_API_KEY: ${{ secrets.DEV_CLAUDE_API_KEY }}

          # =================================================================
          # STAGE ENVIRONMENT SECRETS (STAGE_ prefix)
          # =================================================================
          STAGE_USER_PASSWORD: ${{ secrets.STAGE_USER_PASSWORD }}
          STAGE_KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.STAGE_KEYCLOAK_ADMIN_PASSWORD }}
          STAGE_KEYCLOAK_DB_PASSWORD: ${{ secrets.STAGE_KEYCLOAK_DB_PASSWORD }}
          STAGE_POSTGRES_PASSWORD: ${{ secrets.STAGE_POSTGRES_PASSWORD }}
          STAGE_TAMSHAI_DB_PASSWORD: ${{ secrets.STAGE_TAMSHAI_DB_PASSWORD }}
          STAGE_MONGODB_PASSWORD: ${{ secrets.STAGE_MONGODB_PASSWORD }}
          STAGE_REDIS_PASSWORD: ${{ secrets.STAGE_REDIS_PASSWORD }}
          STAGE_MCP_INTERNAL_SECRET: ${{ secrets.STAGE_MCP_INTERNAL_SECRET }}
          STAGE_MCP_GATEWAY_CLIENT_SECRET: ${{ secrets.STAGE_MCP_GATEWAY_CLIENT_SECRET }}
          STAGE_MCP_UI_CLIENT_SECRET: ${{ secrets.STAGE_MCP_UI_CLIENT_SECRET }}
          STAGE_MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.STAGE_MCP_HR_SERVICE_CLIENT_SECRET }}
          STAGE_CLAUDE_API_KEY: ${{ secrets.STAGE_CLAUDE_API_KEY }}
          STAGE_MINIO_ROOT_PASSWORD: ${{ secrets.STAGE_MINIO_ROOT_PASSWORD }}

          # =================================================================
          # PROD ENVIRONMENT SECRETS (PROD_ prefix)
          # =================================================================
          PROD_USER_PASSWORD: ${{ secrets.PROD_USER_PASSWORD }}
          PROD_KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.PROD_KEYCLOAK_ADMIN_PASSWORD }}
          PROD_KEYCLOAK_DB_PASSWORD: ${{ secrets.PROD_KEYCLOAK_DB_PASSWORD }}
          PROD_TAMSHAI_DB_PASSWORD: ${{ secrets.PROD_TAMSHAI_DB_PASSWORD }}
          PROD_CLAUDE_API_KEY: ${{ secrets.PROD_CLAUDE_API_KEY }}
          PROD_MONGODB_ATLAS_URI: ${{ secrets.PROD_MONGODB_ATLAS_URI }}
          PROD_MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.PROD_MCP_HR_SERVICE_CLIENT_SECRET }}

        run: |
          mkdir -p secrets-export

          case "$SECRET_TYPE" in
            integration)
              # Integration test authentication (token exchange)
              [ -n "$MCP_INTEGRATION_RUNNER_SECRET" ] && echo "$MCP_INTEGRATION_RUNNER_SECRET" > secrets-export/MCP_INTEGRATION_RUNNER_SECRET
              ;;
            e2e)
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              [ -n "$CUSTOMER_USER_PASSWORD" ] && echo "$CUSTOMER_USER_PASSWORD" > secrets-export/CUSTOMER_USER_PASSWORD
              [ -n "$DEV_E2E_ADMIN_API_KEY" ] && echo "$DEV_E2E_ADMIN_API_KEY" > secrets-export/DEV_E2E_ADMIN_API_KEY
              ;;
            phoenix)
              # Secrets needed for Phoenix rebuild / DR evacuation
              [ -n "$TEST_USER_TOTP_SECRET_RAW" ] && echo "$TEST_USER_TOTP_SECRET_RAW" > secrets-export/TEST_USER_TOTP_SECRET_RAW
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              # PROD secrets for GCP
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              [ -n "$PROD_CLAUDE_API_KEY" ] && echo "$PROD_CLAUDE_API_KEY" > secrets-export/PROD_CLAUDE_API_KEY
              [ -n "$PROD_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$PROD_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/PROD_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$PROD_KEYCLOAK_DB_PASSWORD" ] && echo "$PROD_KEYCLOAK_DB_PASSWORD" > secrets-export/PROD_KEYCLOAK_DB_PASSWORD
              [ -n "$PROD_TAMSHAI_DB_PASSWORD" ] && echo "$PROD_TAMSHAI_DB_PASSWORD" > secrets-export/PROD_TAMSHAI_DB_PASSWORD
              [ -n "$PROD_MONGODB_ATLAS_URI" ] && echo "$PROD_MONGODB_ATLAS_URI" > secrets-export/PROD_MONGODB_ATLAS_URI
              [ -n "$PROD_MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$PROD_MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/PROD_MCP_HR_SERVICE_CLIENT_SECRET
              ;;
            keycloak)
              [ -n "$DEV_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$DEV_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/DEV_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$STAGE_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$STAGE_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/STAGE_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$PROD_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$PROD_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/PROD_KEYCLOAK_ADMIN_PASSWORD
              ;;
            user-passwords)
              [ -n "$DEV_USER_PASSWORD" ] && echo "$DEV_USER_PASSWORD" > secrets-export/DEV_USER_PASSWORD
              [ -n "$STAGE_USER_PASSWORD" ] && echo "$STAGE_USER_PASSWORD" > secrets-export/STAGE_USER_PASSWORD
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              ;;
            all)
              # -----------------------------------------------------------------
              # GLOBAL SECRETS
              # -----------------------------------------------------------------
              [ -n "$TEST_USER_PASSWORD" ] && echo "$TEST_USER_PASSWORD" > secrets-export/TEST_USER_PASSWORD
              [ -n "$TEST_USER_TOTP_SECRET" ] && echo "$TEST_USER_TOTP_SECRET" > secrets-export/TEST_USER_TOTP_SECRET
              [ -n "$TEST_USER_TOTP_SECRET_RAW" ] && echo "$TEST_USER_TOTP_SECRET_RAW" > secrets-export/TEST_USER_TOTP_SECRET_RAW
              [ -n "$CUSTOMER_USER_PASSWORD" ] && echo "$CUSTOMER_USER_PASSWORD" > secrets-export/CUSTOMER_USER_PASSWORD
              [ -n "$MCP_INTEGRATION_RUNNER_SECRET" ] && echo "$MCP_INTEGRATION_RUNNER_SECRET" > secrets-export/MCP_INTEGRATION_RUNNER_SECRET
              [ -n "$VPS_SSH_KEY" ] && echo "$VPS_SSH_KEY" > secrets-export/VPS_SSH_KEY
              [ -n "$VPS_HOST" ] && echo "$VPS_HOST" > secrets-export/VPS_HOST

              # -----------------------------------------------------------------
              # DEV ENVIRONMENT
              # -----------------------------------------------------------------
              [ -n "$DEV_USER_PASSWORD" ] && echo "$DEV_USER_PASSWORD" > secrets-export/DEV_USER_PASSWORD
              # Keycloak
              [ -n "$DEV_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$DEV_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/DEV_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$DEV_KEYCLOAK_DB_PASSWORD" ] && echo "$DEV_KEYCLOAK_DB_PASSWORD" > secrets-export/DEV_KEYCLOAK_DB_PASSWORD
              # Databases
              [ -n "$DEV_POSTGRES_PASSWORD" ] && echo "$DEV_POSTGRES_PASSWORD" > secrets-export/DEV_POSTGRES_PASSWORD
              [ -n "$DEV_TAMSHAI_DB_PASSWORD" ] && echo "$DEV_TAMSHAI_DB_PASSWORD" > secrets-export/DEV_TAMSHAI_DB_PASSWORD
              [ -n "$DEV_MONGODB_PASSWORD" ] && echo "$DEV_MONGODB_PASSWORD" > secrets-export/DEV_MONGODB_PASSWORD
              [ -n "$DEV_REDIS_PASSWORD" ] && echo "$DEV_REDIS_PASSWORD" > secrets-export/DEV_REDIS_PASSWORD
              # MCP secrets
              [ -n "$DEV_MCP_INTERNAL_SECRET" ] && echo "$DEV_MCP_INTERNAL_SECRET" > secrets-export/DEV_MCP_INTERNAL_SECRET
              [ -n "$DEV_MCP_GATEWAY_CLIENT_SECRET" ] && echo "$DEV_MCP_GATEWAY_CLIENT_SECRET" > secrets-export/DEV_MCP_GATEWAY_CLIENT_SECRET
              [ -n "$DEV_MCP_UI_CLIENT_SECRET" ] && echo "$DEV_MCP_UI_CLIENT_SECRET" > secrets-export/DEV_MCP_UI_CLIENT_SECRET
              [ -n "$DEV_MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$DEV_MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/DEV_MCP_HR_SERVICE_CLIENT_SECRET
              # Other services
              [ -n "$DEV_E2E_ADMIN_API_KEY" ] && echo "$DEV_E2E_ADMIN_API_KEY" > secrets-export/DEV_E2E_ADMIN_API_KEY
              [ -n "$DEV_ELASTIC_PASSWORD" ] && echo "$DEV_ELASTIC_PASSWORD" > secrets-export/DEV_ELASTIC_PASSWORD
              [ -n "$DEV_MINIO_ROOT_USER" ] && echo "$DEV_MINIO_ROOT_USER" > secrets-export/DEV_MINIO_ROOT_USER
              [ -n "$DEV_MINIO_ROOT_PASSWORD" ] && echo "$DEV_MINIO_ROOT_PASSWORD" > secrets-export/DEV_MINIO_ROOT_PASSWORD
              [ -n "$DEV_VAULT_ROOT_TOKEN" ] && echo "$DEV_VAULT_ROOT_TOKEN" > secrets-export/DEV_VAULT_ROOT_TOKEN
              # API keys
              [ -n "$DEV_GEMINI_API_KEY" ] && echo "$DEV_GEMINI_API_KEY" > secrets-export/DEV_GEMINI_API_KEY
              [ -n "$DEV_CLAUDE_API_KEY" ] && echo "$DEV_CLAUDE_API_KEY" > secrets-export/DEV_CLAUDE_API_KEY

              # -----------------------------------------------------------------
              # STAGE ENVIRONMENT
              # -----------------------------------------------------------------
              [ -n "$STAGE_USER_PASSWORD" ] && echo "$STAGE_USER_PASSWORD" > secrets-export/STAGE_USER_PASSWORD
              [ -n "$STAGE_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$STAGE_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/STAGE_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$STAGE_KEYCLOAK_DB_PASSWORD" ] && echo "$STAGE_KEYCLOAK_DB_PASSWORD" > secrets-export/STAGE_KEYCLOAK_DB_PASSWORD
              [ -n "$STAGE_POSTGRES_PASSWORD" ] && echo "$STAGE_POSTGRES_PASSWORD" > secrets-export/STAGE_POSTGRES_PASSWORD
              [ -n "$STAGE_TAMSHAI_DB_PASSWORD" ] && echo "$STAGE_TAMSHAI_DB_PASSWORD" > secrets-export/STAGE_TAMSHAI_DB_PASSWORD
              [ -n "$STAGE_MONGODB_PASSWORD" ] && echo "$STAGE_MONGODB_PASSWORD" > secrets-export/STAGE_MONGODB_PASSWORD
              [ -n "$STAGE_REDIS_PASSWORD" ] && echo "$STAGE_REDIS_PASSWORD" > secrets-export/STAGE_REDIS_PASSWORD
              [ -n "$STAGE_MCP_INTERNAL_SECRET" ] && echo "$STAGE_MCP_INTERNAL_SECRET" > secrets-export/STAGE_MCP_INTERNAL_SECRET
              [ -n "$STAGE_MCP_GATEWAY_CLIENT_SECRET" ] && echo "$STAGE_MCP_GATEWAY_CLIENT_SECRET" > secrets-export/STAGE_MCP_GATEWAY_CLIENT_SECRET
              [ -n "$STAGE_MCP_UI_CLIENT_SECRET" ] && echo "$STAGE_MCP_UI_CLIENT_SECRET" > secrets-export/STAGE_MCP_UI_CLIENT_SECRET
              [ -n "$STAGE_MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$STAGE_MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/STAGE_MCP_HR_SERVICE_CLIENT_SECRET

              # -----------------------------------------------------------------
              # PROD ENVIRONMENT
              # -----------------------------------------------------------------
              [ -n "$PROD_USER_PASSWORD" ] && echo "$PROD_USER_PASSWORD" > secrets-export/PROD_USER_PASSWORD
              [ -n "$PROD_KEYCLOAK_ADMIN_PASSWORD" ] && echo "$PROD_KEYCLOAK_ADMIN_PASSWORD" > secrets-export/PROD_KEYCLOAK_ADMIN_PASSWORD
              [ -n "$PROD_KEYCLOAK_DB_PASSWORD" ] && echo "$PROD_KEYCLOAK_DB_PASSWORD" > secrets-export/PROD_KEYCLOAK_DB_PASSWORD
              [ -n "$PROD_TAMSHAI_DB_PASSWORD" ] && echo "$PROD_TAMSHAI_DB_PASSWORD" > secrets-export/PROD_TAMSHAI_DB_PASSWORD
              [ -n "$PROD_CLAUDE_API_KEY" ] && echo "$PROD_CLAUDE_API_KEY" > secrets-export/PROD_CLAUDE_API_KEY
              [ -n "$PROD_MONGODB_ATLAS_URI" ] && echo "$PROD_MONGODB_ATLAS_URI" > secrets-export/PROD_MONGODB_ATLAS_URI
              [ -n "$PROD_MCP_HR_SERVICE_CLIENT_SECRET" ] && echo "$PROD_MCP_HR_SERVICE_CLIENT_SECRET" > secrets-export/PROD_MCP_HR_SERVICE_CLIENT_SECRET
              ;;
          esac

          echo "Exported secrets:"
          ls -la secrets-export/

      - name: Upload secrets artifact
        uses: actions/upload-artifact@v6
        with:
          name: secrets-export
          path: secrets-export/
          retention-days: 1
          if-no-files-found: error

      - name: Security reminder
        run: |
          echo "=================================================="
          echo "SECURITY REMINDER"
          echo "=================================================="
          echo "1. Download the artifact immediately"
          echo "2. Delete this workflow run after downloading"
          echo "3. Artifact auto-deletes after 24 hours"
          echo "=================================================="
