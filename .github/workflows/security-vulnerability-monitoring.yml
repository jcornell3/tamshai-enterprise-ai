name: Security Vulnerability Monitoring

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (weekly check)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - '.grype.yaml'
      - '**/package-lock.json'
      - '**/Dockerfile*'

permissions:
  contents: read
  issues: write  # For creating issues when ignores should be updated

jobs:
  check-grype-ignores:
    name: Re-evaluate Grype Ignores
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/mcp-gateway/package-lock.json

      - name: Install MCP Gateway dependencies
        working-directory: services/mcp-gateway
        run: npm ci

      - name: Run Grype ignore re-evaluation script
        id: check
        run: |
          chmod +x scripts/security/check-grype-ignores.sh
          ./scripts/security/check-grype-ignores.sh > grype-check-report.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

          # Display report in GitHub Actions log
          cat grype-check-report.txt

          exit $EXIT_CODE
        continue-on-error: true

      - name: Upload report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: grype-ignore-report
          path: grype-check-report.txt
          retention-days: 30

      - name: Create issue for outdated ignores
        if: steps.check.outputs.exit_code == '1' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('grype-check-report.txt', 'utf8');

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,vulnerability-monitoring'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Grype Ignores Need Re-evaluation')
            );

            if (existingIssue) {
              // Update existing issue with new report
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Re-evaluation Report\n\n**Date:** ${new Date().toISOString()}\n\n\`\`\`\n${report}\n\`\`\``
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Grype Ignores Need Re-evaluation',
                labels: ['security', 'vulnerability-monitoring', 'maintenance'],
                body: `## Grype Vulnerability Ignore Re-evaluation Required

            The automated vulnerability monitoring check has detected that some ignored vulnerabilities in \`.grype.yaml\` may no longer need to be ignored (patches are available).

            ### Re-evaluation Report

            \`\`\`
            ${report}
            \`\`\`

            ### Action Items

            1. Review the report above
            2. Update \`.grype.yaml\` to remove outdated ignores
            3. Run \`grype dir:.\` locally to verify no new critical vulnerabilities
            4. Update dependency versions if needed (npm update, apk upgrade)
            5. Close this issue once ignores are updated

            ### Resources

            - [Grype Configuration](.grype.yaml)
            - [Hono Security Advisories](https://github.com/honojs/hono/security/advisories)
            - [Alpine Linux Security](https://security.alpinelinux.org/)
            - [Re-evaluation Script](scripts/security/check-grype-ignores.sh)

            **Auto-generated by:** [Security Vulnerability Monitoring Workflow](.github/workflows/security-vulnerability-monitoring.yml)
            `
              });

              console.log('Created new issue for outdated Grype ignores');
            }

      - name: Fail workflow if ignores need update
        if: steps.check.outputs.exit_code == '1'
        run: |
          echo "::warning::Grype ignores need re-evaluation - see report artifact"
          # Don't fail on PRs or manual runs, only on schedule
          if [ "${{ github.event_name }}" = "schedule" ]; then
            exit 1
          fi

  scan-with-grype:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    needs: check-grype-ignores

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@7037fa011853d5a11690026fb85feee79f4c946c # v4
        id: scan
        with:
          path: "."
          fail-build: true
          severity-cutoff: critical
          output-format: sarif

      - name: Upload Grype scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}

      - name: Upload Grype scan results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: grype-scan-results
          path: ${{ steps.scan.outputs.sarif }}
          retention-days: 30

  check-alpine-updates:
    name: Monitor Alpine Security Advisories
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Check Alpine security advisories
        run: |
          echo "Checking Alpine Linux security advisories for CVE-2026-22184 and CVE-2025-60876..."

          # Extract Alpine version from Dockerfiles
          ALPINE_VERSION=$(grep -E '^FROM node:[0-9]+-alpine' services/mcp-gateway/Dockerfile | head -1 | sed -E 's/.*node:([0-9]+)-alpine.*/\1/')
          echo "Using Node.js ${ALPINE_VERSION} Alpine base image"

          # Check Alpine security database (note: 2026 CVEs may not exist yet)
          echo ""
          echo "Alpine Security Resources:"
          echo "  â€¢ https://security.alpinelinux.org/vulnerabilities"
          echo "  â€¢ https://secdb.alpinelinux.org/v1/advisories"
          echo ""

          # Verify apk upgrade is present in Dockerfiles
          echo "Verifying 'apk upgrade' is present in Dockerfiles..."
          if grep -r "apk.*upgrade" services/*/Dockerfile clients/*/Dockerfile 2>/dev/null | grep -v "^Binary"; then
            echo "âœ“ apk upgrade found in Dockerfiles"
          else
            echo "âš  WARNING: apk upgrade not found in some Dockerfiles"
            exit 1
          fi

      - name: Create Alpine monitoring summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Alpine Security Monitoring

          ### Monitored CVEs
          - **CVE-2026-22184** (CRITICAL) - zlib vulnerability
          - **CVE-2025-60876** (MEDIUM) - busybox vulnerability

          ### Current Status
          âœ“ All Dockerfiles include `apk update && apk upgrade --no-cache`

          ### Action Required When Patches Available
          1. Verify patches with: `docker run --rm node:20-alpine apk list --upgradable`
          2. Rebuild containers to apply patches
          3. Remove CVE ignores from `.grype.yaml`
          4. Run Grype scan to verify fixes

          ### Resources
          - [Alpine Security Advisories](https://security.alpinelinux.org/)
          - [Grype Configuration](.grype.yaml)
          EOF
