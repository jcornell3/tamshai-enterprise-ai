# Tamshai Enterprise AI - VPS Deployment Workflow
#
# This workflow deploys changes to the VPS without manual SSH access.
# It uses SSH keys stored in GitHub Secrets to connect and deploy.
#
# Required Secrets:
#   VPS_HOST          - VPS IP address or hostname
#   VPS_SSH_KEY       - Private SSH key for deployment (raw PEM format)
#   VPS_SSH_USER      - SSH username (usually 'root' or 'tamshai')
#
# Optional Secrets:
#   SLACK_WEBHOOK_URL - For deployment notifications
#   VAULT_ADDR        - (Future) Vault address for SSH certificate auth
#
# Triggers:
#   - Push to main branch (auto-deploy)
#   - Manual trigger with options
#   - Release published

name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.specify/**'

  release:
    types: [published]

  # Note: This workflow does NOT run on pull_request or Dependabot branches
  # because it requires VPS deployment secrets which are not available to forks/PRs

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
      build:
        description: 'Rebuild containers'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  DEPLOY_BRANCH: ${{ github.event.inputs.branch || 'main' }}
  BUILD_FLAG: ${{ github.event.inputs.build && '--build' || '' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

# Minimal permissions - deployment uses SSH keys
permissions:
  contents: read
  deployments: write
  packages: none
  statuses: write
  actions: none
  checks: none
  pages: none
  pull-requests: none
  repository-projects: none
  security-events: none

jobs:
  # =============================================================================
  # PRE-DEPLOYMENT CHECKS
  # =============================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Check for deployment secrets
        id: check
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "::warning::VPS_HOST secret is not configured - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "::warning::VPS_SSH_KEY secret is not configured - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Validate docker-compose.yml
        env:
          # Default values for CI validation only (not used in real deployment)
          COMPOSE_PROJECT_NAME: tamshai-vps
          KEYCLOAK_MODE: start
          TAMSHAI_DB_PASSWORD: ci_test_value
          POSTGRES_PASSWORD: ci_test_value
          KEYCLOAK_DB_PASSWORD: ci_test_value
          MONGODB_PASSWORD: ci_test_value
          MINIO_ROOT_PASSWORD: ci_test_value
          KEYCLOAK_ADMIN_PASSWORD: ci_test_value
          KEYCLOAK_ISSUER: http://localhost:8080/realms/tamshai
          KEYCLOAK_URL: http://localhost:8080
          KC_HOSTNAME: localhost
          VITE_MCP_GATEWAY_URL: http://localhost:3100
          VITE_KEYCLOAK_URL: http://localhost:8180
        run: |
          # Validate docker-compose configuration (uses env vars above for syntax check)
          docker compose config --quiet

  # =============================================================================
  # BUILD AND TEST
  # =============================================================================
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/mcp-gateway/package-lock.json

      - name: Install dependencies
        working-directory: services/mcp-gateway
        run: npm ci

      - name: Run type check
        working-directory: services/mcp-gateway
        run: npm run typecheck

      - name: Run tests
        working-directory: services/mcp-gateway
        run: npm test

      - name: Build check
        working-directory: services/mcp-gateway
        run: npm run build

  # =============================================================================
  # DEPLOY TO VPS
  # =============================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [pre-deploy, build-test]
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    permissions:
      contents: read
      deployments: write
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Validate key format
          ssh-keygen -y -f ~/.ssh/id_ed25519 > /dev/null 2>&1 || {
            echo "::error::SSH key format is invalid"
            exit 1
          }
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "::warning::Could not scan host keys, continuing anyway"
          }
          echo "SSH key configured"

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_SSH_USER || 'root' }}
        run: |
          echo "[DEPLOY] Deploying to $ENVIRONMENT environment..."
          echo "   Host: $VPS_HOST"
          echo "   Branch: $DEPLOY_BRANCH"
          echo "   Build: $BUILD_FLAG"

          ssh -o ConnectTimeout=30 -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes $VPS_USER@$VPS_HOST << 'DEPLOY_SCRIPT'
          set -e

          cd /opt/tamshai

          echo "=== Pulling latest code ==="
          git config --global --add safe.directory /opt/tamshai
          git fetch origin
          git checkout ${{ env.DEPLOY_BRANCH }}
          git reset --hard origin/${{ env.DEPLOY_BRANCH }}

          echo "=== Loading environment ==="
          export $(cat .env | grep -v '^#' | xargs)

          echo "=== Building and deploying services ==="
          # Always build images on VPS (no container registry configured yet)
          # Uses root docker-compose.yml with VPS environment variables
          docker compose up -d --build

          echo "=== Cleaning up ==="
          docker image prune -f

          echo "=== Waiting for services ==="
          sleep 45

          echo "=== Health check ==="
          curl -sf http://localhost:3100/health && echo "[OK] MCP Gateway: healthy" || echo "[WARN] MCP Gateway: still starting..."
          curl -sf http://localhost:8080/auth/health/ready && echo "[OK] Keycloak: healthy" || echo "[WARN] Keycloak: still starting..."

          echo "=== Waiting for Keycloak to be ready ==="
          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:8080/auth/health/ready >/dev/null 2>&1; then
              echo "[OK] Keycloak is ready"
              break
            fi
            echo "Waiting for Keycloak... attempt $i/5"
            sleep 15
          done

          echo "=== Syncing Keycloak configuration ==="
          # Copy sync script and fix permissions using root user
          docker cp /opt/tamshai/keycloak/scripts/sync-realm.sh tamshai-keycloak:/tmp/sync-realm.sh
          docker exec -u 0 tamshai-keycloak bash -c 'sed -i "s/\r$//" /tmp/sync-realm.sh && chmod 755 /tmp/sync-realm.sh' || true
          # Run as keycloak user (non-fatal - deployment succeeds even if sync fails)
          # Pass both KEYCLOAK_ADMIN_PASSWORD and MCP_HR_SERVICE_CLIENT_SECRET to container
          docker exec \
            -e KEYCLOAK_ADMIN_PASSWORD="$KEYCLOAK_ADMIN_PASSWORD" \
            -e MCP_HR_SERVICE_CLIENT_SECRET="$MCP_HR_SERVICE_CLIENT_SECRET" \
            tamshai-keycloak /tmp/sync-realm.sh stage || {
              echo "[WARN] Keycloak sync failed - clients may need manual configuration"
              echo "Run: ./keycloak/scripts/docker-sync-realm.sh stage tamshai-keycloak"
            }

          echo "=== Syncing HR users to Keycloak ==="
          # Run identity-sync to provision HR employees as Keycloak users
          # This must run AFTER realm sync to ensure mcp-hr-service client exists
          # Use --build to ensure latest code is used (image may be cached)
          docker compose run --rm --build identity-sync || {
            echo "[WARN] Identity sync failed - users may need manual provisioning"
            echo "Check logs: docker logs tamshai-identity-sync"
          }

          echo "=== Deployment complete ==="
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          echo "Verifying external endpoints..."
          DOMAIN="${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}"

          # Wait for services to be fully ready
          sleep 10

          # Check main endpoints (path-based routing)
          for path in "" "/auth" "/api"; do
            url="https://${DOMAIN}${path}"
            if curl -sf -o /dev/null --max-time 30 "$url"; then
              echo "[OK] $url - OK"
            else
              echo "[WARN] $url - Not reachable (may still be starting)"
            fi
          done

      - name: Notify on success
        if: success()
        continue-on-error: true
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"[SUCCESS] Tamshai deployed successfully to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nCommit: ${{ github.sha }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure()
        continue-on-error: true
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"[FAILED] Tamshai deployment FAILED to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nSee: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

  # =============================================================================
  # POST-DEPLOYMENT
  # =============================================================================
  post-deploy:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Create deployment record
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment_url: 'https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}',
              description: 'Deployment completed successfully'
            }).catch(() => console.log('Could not create deployment status'));

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ env.DEPLOY_BRANCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
