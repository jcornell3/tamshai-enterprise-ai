# Tamshai Enterprise AI - VPS Deployment Workflow
#
# This workflow deploys changes to the VPS without manual SSH access.
# It uses SSH keys stored in GitHub Secrets to connect and deploy.
#
# Required Secrets:
#   VPS_HOST               - VPS IP address or hostname
#   VPS_SSH_KEY            - Private SSH key for deployment (raw PEM format)
#   VPS_SSH_USER           - SSH username (usually 'root' or 'tamshai')
#   KEYCLOAK_VPS_ADMIN_PASSWORD - Keycloak admin password for VPS/stage realm management
#
# Optional Secrets (for E2E testing):
#   TEST_USER_PASSWORD         - Password for test-user.journey (E2E test service account)
#   TEST_USER_TOTP_SECRET_RAW_STAGE - Raw TOTP secret for stage (falls back to TEST_USER_TOTP_SECRET_RAW)
#   SLACK_WEBHOOK_URL          - For deployment notifications
#   VAULT_ADDR                 - (Future) Vault address for SSH certificate auth
#
# Triggers:
#   - Push to main branch (auto-deploy)
#   - Manual trigger with options
#   - Release published

name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.specify/**'

  release:
    types: [published]

  # Note: This workflow does NOT run on pull_request or Dependabot branches
  # because it requires VPS deployment secrets which are not available to forks/PRs

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
      build:
        description: 'Rebuild containers'
        required: false
        type: boolean
        default: false
      reseed_data:
        description: 'Re-seed sample data (Finance, Sales, Support)'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  DEPLOY_BRANCH: ${{ github.event.inputs.branch || 'main' }}
  BUILD_FLAG: ${{ github.event.inputs.build && '--build --no-cache' || '--build' }}
  RESEED_DATA: ${{ github.event.inputs.reseed_data || 'false' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

# Minimal permissions - deployment uses SSH keys
permissions:
  contents: read
  deployments: write
  packages: none
  statuses: write
  actions: none
  checks: none
  pages: none
  pull-requests: none
  repository-projects: none
  security-events: none

jobs:
  # =============================================================================
  # PRE-DEPLOYMENT CHECKS
  # =============================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Check for deployment secrets
        id: check
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "::warning::VPS_HOST secret is not configured - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "::warning::VPS_SSH_KEY secret is not configured - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Validate docker-compose.yml
        env:
          # Default values for CI validation only (not used in real deployment)
          COMPOSE_PROJECT_NAME: tamshai-vps
          KEYCLOAK_MODE: start
          TAMSHAI_DB_PASSWORD: ci_test_value
          POSTGRES_PASSWORD: ci_test_value
          KEYCLOAK_DB_PASSWORD: ci_test_value
          MONGODB_PASSWORD: ci_test_value
          MINIO_ROOT_PASSWORD: ci_test_value
          KEYCLOAK_ADMIN_PASSWORD: ci_test_value
          KEYCLOAK_ISSUER: http://localhost:8080/realms/tamshai
          KEYCLOAK_URL: http://localhost:8080
          KC_HOSTNAME: localhost
          VITE_MCP_GATEWAY_URL: http://localhost:3100
          VITE_KEYCLOAK_URL: http://localhost:8180
        run: |
          # Validate docker-compose configuration (uses env vars above for syntax check)
          docker compose config --quiet

  # =============================================================================
  # BUILD AND TEST
  # =============================================================================
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/mcp-gateway/package-lock.json

      - name: Install dependencies
        working-directory: services/mcp-gateway
        run: npm ci

      - name: Run type check
        working-directory: services/mcp-gateway
        run: npm run typecheck

      - name: Run tests
        working-directory: services/mcp-gateway
        run: npm test

      - name: Build check
        working-directory: services/mcp-gateway
        run: npm run build

  # =============================================================================
  # DEPLOY TO VPS
  # =============================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [pre-deploy, build-test]
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    permissions:
      contents: read
      deployments: write
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # Validate key format
          ssh-keygen -y -f ~/.ssh/id_ed25519 > /dev/null 2>&1 || {
            echo "::error::SSH key format is invalid"
            exit 1
          }
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "::warning::Could not scan host keys, continuing anyway"
          }
          echo "SSH key configured"

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_SSH_USER || 'root' }}
        run: |
          echo "[DEPLOY] Deploying to $ENVIRONMENT environment..."
          echo "   Host: $VPS_HOST"
          echo "   Branch: $DEPLOY_BRANCH"
          echo "   Build: $BUILD_FLAG"

          ssh -o ConnectTimeout=30 -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes $VPS_USER@$VPS_HOST << 'DEPLOY_SCRIPT'
          set -e
          set +H  # Disable history expansion to handle passwords with special characters like !

          cd /opt/tamshai

          echo "=== Pulling latest code ==="
          git config --global --add safe.directory /opt/tamshai
          git fetch origin
          git checkout ${{ env.DEPLOY_BRANCH }}
          git reset --hard origin/${{ env.DEPLOY_BRANCH }}

          echo "=== Loading environment ==="
          export $(cat .env | grep -v '^#' | xargs)

          echo "=== Building and deploying services ==="
          # Build images on VPS (no container registry configured yet)
          # Uses root docker-compose.yml with VPS environment variables
          if [ "${{ github.event.inputs.build }}" = "true" ]; then
            echo "Force rebuilding with --no-cache..."
            # Stop containers to prevent cache reuse
            docker compose down
            # Remove web app images to force complete rebuild
            docker rmi -f web-finance:latest web-sales:latest web-portal:latest 2>/dev/null || true
            # Build without cache
            docker compose build --no-cache
            # Start containers
            docker compose up -d
          else
            # Normal deployment with build
            docker compose up -d --build
          fi

          echo "=== Cleaning up ==="
          docker image prune -f

          echo "=== Waiting for services ==="
          sleep 45

          echo "=== Health check ==="
          curl -sf http://localhost:3100/health && echo "[OK] MCP Gateway: healthy" || echo "[WARN] MCP Gateway: still starting..."
          curl -sf http://localhost:8080/auth/health/ready && echo "[OK] Keycloak: healthy" || echo "[WARN] Keycloak: still starting..."

          echo "=== Waiting for Keycloak to be ready ==="
          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:8080/auth/health/ready >/dev/null 2>&1; then
              echo "[OK] Keycloak is ready"
              break
            fi
            echo "Waiting for Keycloak... attempt $i/5"
            sleep 15
          done

          # Re-seed sample data if requested (DROP and RELOAD for clean data)
          # NOTE: Run this BEFORE Keycloak sync to avoid heredoc termination issues
          if [ "${{ env.RESEED_DATA }}" = "true" ]; then
            echo "=== Re-seeding sample data (clean reload) ==="

            echo "  [1/4] Stopping MCP services..."
            docker stop tamshai-mcp-finance tamshai-mcp-sales tamshai-mcp-support || true

            echo "  [2/4] Reloading Finance data (PostgreSQL)..."
            docker exec tamshai-postgres psql -U postgres -c "DROP DATABASE IF EXISTS tamshai_finance;" && \
            docker exec tamshai-postgres psql -U postgres -c "CREATE DATABASE tamshai_finance OWNER tamshai;" && \
            docker exec -i tamshai-postgres psql -U tamshai -d tamshai_finance < sample-data/finance-data.sql && \
              echo "  [OK] Finance database dropped and reloaded" || \
              echo "  [ERROR] Finance data reload failed"

            echo "  [3/4] Reloading Sales data (MongoDB)..."
            # Get MongoDB password from environment
            MONGODB_PASSWORD=$(grep '^MONGODB_PASSWORD=' .env | cut -d= -f2)
            docker exec -i tamshai-mongodb mongosh -u tamshai -p "$MONGODB_PASSWORD" --authenticationDatabase admin < sample-data/sales-data.js && \
              echo "  [OK] Sales data reloaded (MongoDB script handles drop/recreate)" || \
              echo "  [ERROR] Sales data reload failed"

            echo "  [4/4] Reloading Support data (Elasticsearch)..."
            # Delete existing indexes
            docker exec tamshai-elasticsearch curl -X DELETE "http://localhost:9200/support_tickets,knowledge_base" 2>/dev/null || true
            # Bulk load fresh data
            cat sample-data/support-data.ndjson | docker exec -i tamshai-elasticsearch curl -X POST "http://localhost:9200/_bulk" \
              -H "Content-Type: application/x-ndjson" --data-binary @- 2>/dev/null && \
              echo "  [OK] Support indexes deleted and reloaded" || \
              echo "  [ERROR] Support data reload failed"

            echo "=== Restarting MCP services ==="
            docker start tamshai-mcp-finance tamshai-mcp-sales tamshai-mcp-support
            docker restart tamshai-mcp-gateway
            sleep 10

            echo "=== Verifying data counts ==="
            echo "  Finance budgets (FY2025):"
            docker exec tamshai-postgres psql -U tamshai -d tamshai_finance -c "SELECT fiscal_year, COUNT(*) FROM finance.department_budgets GROUP BY fiscal_year ORDER BY fiscal_year;" || true
            echo "  Sales deals:"
            docker exec tamshai-mongodb mongosh -u tamshai -p "$MONGODB_PASSWORD" --authenticationDatabase admin tamshai_sales --quiet --eval "db.deals.countDocuments()" || true
            echo "  Support tickets:"
            docker exec tamshai-elasticsearch curl -s "http://localhost:9200/support_tickets/_count" | grep -o '"count":[0-9]*' || true
            echo "  Knowledge base articles:"
            docker exec tamshai-elasticsearch curl -s "http://localhost:9200/knowledge_base/_count" | grep -o '"count":[0-9]*' || true
          else
            echo "=== Skipping sample data re-seed (use reseed_data=true to enable) ==="
          fi

          echo "=== Syncing Keycloak configuration ==="
          # Copy sync script and fix permissions using root user
          docker cp /opt/tamshai/keycloak/scripts/sync-realm.sh tamshai-keycloak:/tmp/sync-realm.sh
          docker exec -u 0 tamshai-keycloak bash -c 'sed -i "s/\r$//" /tmp/sync-realm.sh && chmod 755 /tmp/sync-realm.sh' || true
          # Run as keycloak user (non-fatal - deployment succeeds even if sync fails)
          # Pass both KEYCLOAK_ADMIN_PASSWORD and MCP_HR_SERVICE_CLIENT_SECRET to container
          docker exec \
            -e KEYCLOAK_ADMIN_PASSWORD="$KEYCLOAK_ADMIN_PASSWORD" \
            -e MCP_HR_SERVICE_CLIENT_SECRET="$MCP_HR_SERVICE_CLIENT_SECRET" \
            tamshai-keycloak /tmp/sync-realm.sh stage || {
              echo "[WARN] Keycloak sync failed - clients may need manual configuration"
              echo "Run: ./keycloak/scripts/docker-sync-realm.sh stage tamshai-keycloak"
            }

          echo "=== Syncing HR users to Keycloak ==="
          # Run identity-sync to provision HR employees as Keycloak users
          # This must run AFTER realm sync to ensure mcp-hr-service client exists
          # Use --build to ensure latest code is used (image may be cached)
          # Use -T to disable TTY allocation (prevents consuming heredoc stdin)
          docker compose run -T --rm --build identity-sync || {
            echo "[WARN] Identity sync failed - users may need manual provisioning"
            echo "Check logs: docker logs tamshai-identity-sync"
          }

          echo "=== Deployment complete ==="
          DEPLOY_SCRIPT

      # =========================================================================
      # Configure test-user.journey credentials (aligned with deploy-to-gcp.yml)
      # See docs/testing/TEST_USER_JOURNEY.md for details
      # =========================================================================
      - name: Configure test-user.journey credentials
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_SSH_USER || 'root' }}
          KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_VPS_ADMIN_PASSWORD }}
          TEST_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_USER_TOTP_SECRET_RAW: ${{ secrets.TEST_USER_TOTP_SECRET_RAW }}
        run: |
          echo "Configuring test-user.journey credentials..."

          # Validate required secrets (aligned with prod - fail if missing)
          if [ -z "$TEST_PASSWORD" ]; then
            echo "ERROR: TEST_USER_PASSWORD secret not set"
            echo "See docs/testing/TEST_USER_JOURNEY.md for setup instructions"
            exit 1
          fi

          if [ -z "$TEST_USER_TOTP_SECRET_RAW" ]; then
            echo "ERROR: TEST_USER_TOTP_SECRET_RAW secret not set"
            echo "See docs/testing/TEST_USER_JOURNEY.md for setup instructions"
            exit 1
          fi

          ssh -o ConnectTimeout=30 -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes $VPS_USER@$VPS_HOST << CONFIGURE_SCRIPT
          set -e
          set +H

          # Wait for Keycloak to be ready (up to 90 seconds)
          echo "Waiting for Keycloak to be ready..."
          KEYCLOAK_READY=false
          for i in {1..18}; do
            if curl -sf -o /dev/null "http://localhost/auth/realms/master"; then
              echo "[OK] Keycloak is ready"
              KEYCLOAK_READY=true
              break
            fi
            echo "   Attempt \$i/18: Keycloak not ready, waiting 5 seconds..."
            sleep 5
          done

          if [ "\$KEYCLOAK_READY" = "false" ]; then
            echo "ERROR: Keycloak not ready after 90 seconds"
            exit 1
          fi

          # Get admin token
          echo "Getting Keycloak admin token..."
          TOKEN=\$(curl -sf -X POST "http://localhost/auth/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" \
            -d "username=admin" \
            -d "password=${KEYCLOAK_ADMIN_PASSWORD}" \
            -d "grant_type=password" | jq -r '.access_token')

          if [ -z "\$TOKEN" ] || [ "\$TOKEN" = "null" ]; then
            echo "ERROR: Could not get admin token - check KEYCLOAK_ADMIN_PASSWORD secret"
            exit 1
          fi
          echo "[OK] Admin token obtained"

          # Get test-user.journey ID
          USER_ID=\$(curl -sf "http://localhost/auth/admin/realms/tamshai-corp/users?username=test-user.journey" \
            -H "Authorization: Bearer \$TOKEN" | jq -r '.[0].id')

          if [ -z "\$USER_ID" ] || [ "\$USER_ID" = "null" ]; then
            echo "ERROR: test-user.journey not found in Keycloak"
            exit 1
          fi
          echo "[OK] Found test-user.journey (ID: \$USER_ID)"

          # Reset password
          echo "Resetting password for test-user.journey..."
          RESET_CODE=\$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            "http://localhost/auth/admin/realms/tamshai-corp/users/\${USER_ID}/reset-password" \
            -H "Authorization: Bearer \$TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"type":"password","value":"${TEST_PASSWORD}","temporary":false}')

          if [ "\$RESET_CODE" = "204" ]; then
            echo "[OK] Password reset successful"
          else
            echo "ERROR: Password reset failed (HTTP \$RESET_CODE)"
            exit 1
          fi

          # Configure TOTP credentials (aligned with prod approach)
          echo "Configuring TOTP credentials..."

          # Remove existing OTP credentials
          EXISTING_CREDS=\$(curl -sf "http://localhost/auth/admin/realms/tamshai-corp/users/\${USER_ID}/credentials" \
            -H "Authorization: Bearer \$TOKEN")
          echo "Existing credentials: \$(echo \$EXISTING_CREDS | jq -r '[.[].type]')"

          # Delete existing OTP credentials
          for CRED_ID in \$(echo \$EXISTING_CREDS | jq -r '.[] | select(.type=="otp") | .id'); do
            echo "Deleting OTP credential: \$CRED_ID"
            curl -sf -X DELETE "http://localhost/auth/admin/realms/tamshai-corp/users/\${USER_ID}/credentials/\${CRED_ID}" \
              -H "Authorization: Bearer \$TOKEN"
          done

          # Clear required actions so user doesn't see TOTP setup page
          echo "Clearing required actions..."
          curl -sf -X PUT \
            "http://localhost/auth/admin/realms/tamshai-corp/users/\${USER_ID}" \
            -H "Authorization: Bearer \$TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"requiredActions":[]}' > /dev/null || true

          echo "[OK] test-user.journey configured successfully"
          CONFIGURE_SCRIPT

      - name: Verify deployment
        run: |
          echo "Verifying external endpoints..."
          DOMAIN="${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}"

          # Wait for services to be fully ready
          sleep 10

          # Check main endpoints (path-based routing)
          for path in "" "/auth" "/api"; do
            url="https://${DOMAIN}${path}"
            if curl -sf -o /dev/null --max-time 30 "$url"; then
              echo "[OK] $url - OK"
            else
              echo "[WARN] $url - Not reachable (may still be starting)"
            fi
          done

      - name: Notify on success
        if: success()
        continue-on-error: true
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"[SUCCESS] Tamshai deployed successfully to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nCommit: ${{ github.sha }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure()
        continue-on-error: true
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"[FAILED] Tamshai deployment FAILED to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nSee: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

  # =============================================================================
  # POST-DEPLOYMENT
  # =============================================================================
  post-deploy:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Create deployment record
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment_url: 'https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}',
              description: 'Deployment completed successfully'
            }).catch(() => console.log('Could not create deployment status'));

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ env.DEPLOY_BRANCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
