# Tamshai Enterprise AI - VPS Deployment Workflow
#
# This workflow deploys changes to the VPS without manual SSH access.
# It uses SSH keys stored in GitHub Secrets to connect and deploy.
#
# Required Secrets:
#   VPS_HOST          - VPS IP address or hostname
#   VPS_SSH_KEY       - Private SSH key for deployment
#   VPS_SSH_USER      - SSH username (usually 'root' or 'tamshai')
#
# Optional Secrets:
#   SLACK_WEBHOOK_URL - For deployment notifications
#
# Triggers:
#   - Push to main branch (auto-deploy)
#   - Manual trigger with options
#   - Release published

name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.specify/**'

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
      build:
        description: 'Rebuild containers'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  DEPLOY_BRANCH: ${{ github.event.inputs.branch || 'main' }}
  BUILD_FLAG: ${{ github.event.inputs.build && '--build' || '' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

jobs:
  # =============================================================================
  # PRE-DEPLOYMENT CHECKS
  # =============================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for deployment secrets
        id: check
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "::error::VPS_HOST secret is not configured"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "::error::VPS_SSH_KEY secret is not configured"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Validate docker-compose.vps.yml
        run: |
          docker compose -f docker-compose.vps.yml config --quiet

  # =============================================================================
  # BUILD AND TEST
  # =============================================================================
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/mcp-gateway/package-lock.json

      - name: Install dependencies
        working-directory: services/mcp-gateway
        run: npm ci

      - name: Run type check
        working-directory: services/mcp-gateway
        run: npm run typecheck

      - name: Run tests
        working-directory: services/mcp-gateway
        run: npm test

      - name: Build check
        working-directory: services/mcp-gateway
        run: npm run build

  # =============================================================================
  # DEPLOY TO VPS
  # =============================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [pre-deploy, build-test]
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_SSH_USER || 'root' }}
        run: |
          echo "ðŸš€ Deploying to $ENVIRONMENT environment..."
          echo "   Host: $VPS_HOST"
          echo "   Branch: $DEPLOY_BRANCH"
          echo "   Build: $BUILD_FLAG"

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            $VPS_USER@$VPS_HOST << 'DEPLOY_SCRIPT'
          set -e

          cd /opt/tamshai

          echo "=== Pulling latest code ==="
          git fetch origin
          git checkout ${{ env.DEPLOY_BRANCH }}
          git pull origin ${{ env.DEPLOY_BRANCH }}

          echo "=== Loading environment ==="
          export $(cat .env | grep -v '^#' | xargs)

          echo "=== Pulling Docker images ==="
          docker compose -f docker-compose.vps.yml pull

          echo "=== Deploying services ==="
          docker compose -f docker-compose.vps.yml up -d ${{ env.BUILD_FLAG }}

          echo "=== Cleaning up ==="
          docker image prune -f

          echo "=== Waiting for services ==="
          sleep 30

          echo "=== Health check ==="
          curl -sf http://localhost:3100/health && echo "âœ“ MCP Gateway: healthy" || echo "âœ— MCP Gateway: unhealthy"
          curl -sf http://localhost:8080/auth/health/ready && echo "âœ“ Keycloak: healthy" || echo "âœ— Keycloak: unhealthy"

          echo "=== Deployment complete ==="
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          echo "Verifying external endpoints..."
          DOMAIN="${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}"

          # Wait for services to be fully ready
          sleep 10

          # Check main endpoints (path-based routing)
          for path in "" "/auth" "/api"; do
            url="https://${DOMAIN}${path}"
            if curl -sf -o /dev/null --max-time 30 "$url"; then
              echo "âœ… $url - OK"
            else
              echo "âš ï¸ $url - Not reachable (may still be starting)"
            fi
          done

      - name: Notify on success
        if: success() && secrets.SLACK_WEBHOOK_URL
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âœ… Tamshai deployed successfully to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nCommit: ${{ github.sha }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âŒ Tamshai deployment FAILED to ${{ env.ENVIRONMENT }}\nBranch: ${{ env.DEPLOY_BRANCH }}\nSee: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

  # =============================================================================
  # POST-DEPLOYMENT
  # =============================================================================
  post-deploy:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment_url: 'https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }}',
              description: 'Deployment completed successfully'
            }).catch(() => console.log('Could not create deployment status'));

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ env.DEPLOY_BRANCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${{ secrets.VPS_DOMAIN || secrets.VPS_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
