name: Deploy to GCP Production

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'clients/web/**'
      - 'keycloak/**'
      - 'apps/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gateway
          - hr
          - finance
          - sales
          - support
          - keycloak
          - web
          - website

# Prevent concurrent deployments to production
# New deployments will wait in queue until current deployment completes
concurrency:
  group: deploy-to-gcp-production
  cancel-in-progress: false

env:
  GCP_REGION: us-central1
  AR_REPO: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/tamshai

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.changes.outputs.gateway }}
      mcp-suite: ${{ steps.changes.outputs.mcp-suite }}
      keycloak: ${{ steps.changes.outputs.keycloak }}
      web: ${{ steps.changes.outputs.web }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            gateway:
              - 'services/mcp-gateway/**'
            mcp-suite:
              - 'services/mcp-hr/**'
              - 'services/mcp-finance/**'
              - 'services/mcp-sales/**'
              - 'services/mcp-support/**'
            keycloak:
              - 'keycloak/**'
            web:
              - 'clients/web/**'
              - 'apps/tamshai-website/**'

  deploy-gateway:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.gateway == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'gateway'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Image
        run: |
          docker build -t ${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/mcp-gateway:latest \
                       services/mcp-gateway
          docker push ${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/mcp-gateway:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy mcp-gateway \
            --image=${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-gateway@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300 \
            --set-secrets=CLAUDE_API_KEY=tamshai-prod-anthropic-api-key:latest \
            --set-env-vars="NODE_ENV=production,KEYCLOAK_URL=https://keycloak-1046947015464.us-central1.run.app/auth,KEYCLOAK_ISSUER=https://keycloak-1046947015464.us-central1.run.app/auth/realms/tamshai-corp,JWKS_URI=https://keycloak-1046947015464.us-central1.run.app/auth/realms/tamshai-corp/protocol/openid-connect/certs,MCP_HR_URL=https://mcp-hr-1046947015464.us-central1.run.app,MCP_FINANCE_URL=https://mcp-finance-1046947015464.us-central1.run.app,MCP_SALES_URL=https://mcp-sales-1046947015464.us-central1.run.app,MCP_SUPPORT_URL=https://mcp-support-1046947015464.us-central1.run.app,TOKEN_REVOCATION_FAIL_OPEN=true,MCP_READ_TIMEOUT_MS=30000,MCP_WRITE_TIMEOUT_MS=60000"

  deploy-mcp-postgres:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.mcp-suite == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'hr' ||
      github.event.inputs.service == 'finance'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [mcp-hr, mcp-finance]
        include:
          - service: mcp-hr
            port: 3101
            db_name: tamshai_hr
          - service: mcp-finance
            port: 3102
            db_name: tamshai_finance
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          docker build -t ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/${{ matrix.service }}:latest \
                       services/${{ matrix.service }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }} \
            --image=${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-servers@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --no-allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --add-cloudsql-instances=${{ secrets.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:tamshai-prod-postgres \
            --vpc-connector=tamshai-prod-connector \
            --vpc-egress=private-ranges-only \
            --set-secrets=POSTGRES_PASSWORD=tamshai-prod-db-password:latest,MONGODB_URI=tamshai-prod-mongodb-uri:latest \
            --set-env-vars="NODE_ENV=production,POSTGRES_HOST=/cloudsql/${{ secrets.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:tamshai-prod-postgres,POSTGRES_PORT=5432,POSTGRES_DB=${{ matrix.db_name }},POSTGRES_USER=tamshai"

  deploy-mcp-mongodb:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.mcp-suite == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'sales' ||
      github.event.inputs.service == 'support'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [mcp-sales, mcp-support]
        include:
          - service: mcp-sales
            port: 3103
            db_name: tamshai_sales
          - service: mcp-support
            port: 3104
            db_name: tamshai_support
            backend: mongodb
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          docker build -t ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/${{ matrix.service }}:latest \
                       services/${{ matrix.service }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:latest

      - name: Deploy to Cloud Run
        run: |
          # MongoDB services need all-traffic egress for MongoDB Atlas
          gcloud run deploy ${{ matrix.service }} \
            --image=${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-servers@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --no-allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --vpc-connector=tamshai-prod-connector \
            --vpc-egress=all-traffic \
            --set-secrets=MONGODB_URI=tamshai-prod-mongodb-uri:latest \
            --set-env-vars="NODE_ENV=production,MONGODB_DB=${{ matrix.db_name }}${{ matrix.backend && format(',SUPPORT_DATA_BACKEND={0}', matrix.backend) || '' }}"

  deploy-keycloak:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.keycloak == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'keycloak'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Inject TOTP Secret into Realm Export
        env:
          TEST_USER_TOTP_SECRET_RAW: ${{ secrets.TEST_USER_TOTP_SECRET_RAW }}
        run: |
          # Substitute placeholder with actual secret for test-user.journey TOTP
          # The secret is the RAW value (not BASE32) that Keycloak stores internally
          # See docs/testing/TEST_USER_JOURNEY.md for details on raw vs BASE32 secrets
          if [ -z "$TEST_USER_TOTP_SECRET_RAW" ]; then
            echo "ERROR: TEST_USER_TOTP_SECRET_RAW secret not set"
            exit 1
          fi
          sed -i "s/__TEST_USER_TOTP_SECRET__/${TEST_USER_TOTP_SECRET_RAW}/g" keycloak/realm-export.json

      - name: Build and Push
        run: |
          docker build -t ${{ env.AR_REPO }}/keycloak:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/keycloak:latest \
                       -t ${{ env.AR_REPO }}/keycloak:v2.0.0-postgres \
                       keycloak
          docker push ${{ env.AR_REPO }}/keycloak:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/keycloak:latest
          docker push ${{ env.AR_REPO }}/keycloak:v2.0.0-postgres

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy keycloak \
            --image=${{ env.AR_REPO }}/keycloak:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-keycloak@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=1 \
            --max-instances=2 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=600 \
            --vpc-connector=tamshai-prod-connector \
            --vpc-egress=private-ranges-only \
            --set-secrets=KEYCLOAK_ADMIN_PASSWORD=tamshai-prod-keycloak-admin-password:latest,KC_DB_PASSWORD=tamshai-prod-keycloak-db-password:latest \
            --set-env-vars="KEYCLOAK_ADMIN=admin,KC_DB=postgres,KC_DB_URL=jdbc:postgresql://10.194.0.3:5432/keycloak,KC_DB_USERNAME=keycloak,KC_HOSTNAME=auth.tamshai.com,KC_HOSTNAME_STRICT=false,KC_HTTP_PORT=8080,KC_PROXY=edge,KC_PROXY_HEADERS=xforwarded,KC_HTTP_RELATIVE_PATH=/auth,KC_DB_POOL_MAX_SIZE=10,KC_DB_POOL_MIN_SIZE=2"

  sync-keycloak-realm:
    needs: deploy-keycloak
    if: needs.deploy-keycloak.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Wait for Keycloak to be ready
        run: |
          echo "Waiting for Keycloak to be fully ready..."
          for i in {1..6}; do
            # Check master realm (always exists) - tamshai-corp may be deleted and reimported
            if curl -sf "https://auth.tamshai.com/auth/realms/master/.well-known/openid-configuration" > /dev/null 2>&1; then
              echo "Keycloak is ready!"
              break
            fi
            echo "Attempt $i/6: Keycloak not ready yet, waiting 10s..."
            sleep 10
          done

          # Final check
          if ! curl -sf "https://auth.tamshai.com/auth/realms/master/.well-known/openid-configuration" > /dev/null 2>&1; then
            echo "ERROR: Keycloak not ready after 60 seconds"
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Download Keycloak CLI Tools
        run: |
          echo "Downloading Keycloak CLI tools..."
          # Download Keycloak 25.0.0 (matches our deployed version)
          wget -q https://github.com/keycloak/keycloak/releases/download/25.0.0/keycloak-25.0.0.tar.gz
          tar -xzf keycloak-25.0.0.tar.gz
          echo "KEYCLOAK_HOME=$PWD/keycloak-25.0.0" >> $GITHUB_ENV
          echo "$PWD/keycloak-25.0.0/bin" >> $GITHUB_PATH
          echo "Keycloak CLI tools ready"

      - name: Configure credentials for test-user.journey
        env:
          TEST_USER_TOTP_SECRET_RAW: ${{ secrets.TEST_USER_TOTP_SECRET_RAW }}
          TEST_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          # Configure password and TOTP credentials for test-user.journey via Admin API
          # This is necessary because Keycloak's --import-realm doesn't update
          # credentials for existing users (only during initial realm creation)

          echo "Configuring credentials for test-user.journey..."

          # Fetch admin password from GCP Secret Manager
          echo "Fetching admin password from GCP Secret Manager..."
          KEYCLOAK_ADMIN_PASSWORD=$(gcloud secrets versions access latest --secret=tamshai-prod-keycloak-admin-password)
          if [ -z "$KEYCLOAK_ADMIN_PASSWORD" ]; then
            echo "ERROR: Could not fetch admin password from Secret Manager"
            exit 1
          fi
          echo "Admin password fetched successfully (length: ${#KEYCLOAK_ADMIN_PASSWORD})"

          # Get admin token with verbose error handling
          echo "Requesting admin token from Keycloak..."
          # URL-encode the password to handle special characters
          ENCODED_PASSWORD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${KEYCLOAK_ADMIN_PASSWORD}', safe=''))")
          TOKEN_RESPONSE=$(curl -s -X POST "https://auth.tamshai.com/auth/realms/master/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "username=admin" \
            --data-urlencode "password=${KEYCLOAK_ADMIN_PASSWORD}" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" 2>&1)

          TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')
          ERROR=$(echo "$TOKEN_RESPONSE" | jq -r '.error_description // .error // empty')

          if [ -z "$TOKEN" ]; then
            echo "ERROR: Could not get admin token"
            echo "Response: $TOKEN_RESPONSE"
            if [ -n "$ERROR" ]; then
              echo "Error details: $ERROR"
            fi
            exit 1
          fi
          echo "Admin token obtained successfully"

          # Get test-user.journey user ID
          USER_ID=$(curl -sf "https://auth.tamshai.com/auth/admin/realms/tamshai-corp/users?username=test-user.journey" \
            -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')

          if [ -z "$USER_ID" ] || [ "$USER_ID" = "null" ]; then
            echo "ERROR: Could not find test-user.journey user"
            exit 1
          fi
          echo "Found user ID: $USER_ID"

          # Reset password for test-user.journey
          echo "Resetting password for test-user.journey..."
          if [ -z "$TEST_PASSWORD" ]; then
            echo "ERROR: TEST_USER_PASSWORD secret not set"
            exit 1
          fi
          # Use jq for proper JSON encoding (handles special chars like @)
          PASSWORD_JSON=$(jq -n --arg pass "$TEST_PASSWORD" '{"type":"password","value":$pass,"temporary":false}')
          RESET_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "https://auth.tamshai.com/auth/admin/realms/tamshai-corp/users/${USER_ID}/reset-password" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PASSWORD_JSON")
          HTTP_CODE=$(echo "$RESET_RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "204" ]; then
            echo "ERROR: Failed to reset password (HTTP $HTTP_CODE)"
            echo "Response: $(echo "$RESET_RESPONSE" | head -n-1)"
            exit 1
          fi
          echo "Password reset successfully"

          # Remove existing OTP credentials
          EXISTING_CREDS=$(curl -sf "https://auth.tamshai.com/auth/admin/realms/tamshai-corp/users/${USER_ID}/credentials" \
            -H "Authorization: Bearer $TOKEN")
          echo "Existing credentials: $(echo $EXISTING_CREDS | jq -r '[.[].type]')"

          # Delete OTP credentials
          for CRED_ID in $(echo $EXISTING_CREDS | jq -r '.[] | select(.type=="otp") | .id'); do
            echo "Deleting OTP credential: $CRED_ID"
            curl -sf -X DELETE "https://auth.tamshai.com/auth/admin/realms/tamshai-corp/users/${USER_ID}/credentials/${CRED_ID}" \
              -H "Authorization: Bearer $TOKEN"
          done

          # Create new OTP credential with raw secret
          # IMPORTANT: secretData must ONLY contain "value" field - other fields go in credentialData
          # (Keycloak OTPSecretData class doesn't recognize period/digits/algorithm)
          OTP_CREDENTIAL=$(cat <<EOFCRED
          {
            "type": "otp",
            "secretData": "{\"value\":\"${TEST_USER_TOTP_SECRET_RAW}\"}",
            "credentialData": "{\"subType\":\"totp\",\"period\":30,\"digits\":6,\"algorithm\":\"HmacSHA1\"}"
          }
          EOFCRED
          )

          # Note: Keycloak Admin API doesn't support creating OTP credentials directly
          # Check if the realm needs to be deleted and reimported
          echo "Checking if realm reimport is needed..."

          # Test TOTP by checking if it's properly configured
          # If the user has OTP but no secretData, we need to reimport
          OTP_COUNT=$(echo "$EXISTING_CREDS" | jq '[.[] | select(.type=="otp")] | length')

          # We no longer delete the realm here - it causes issues because
          # Keycloak only imports realms on first container startup.
          # Instead, the realm-export.json should always have correct TOTP config
          # and deployment always creates a new container revision with the latest realm file.
          echo "TOTP configuration complete."
          echo "OTP credentials found: $OTP_COUNT"

      - name: Wait for Realm Reimport
        run: |
          echo "Waiting for Keycloak to reimport realm..."
          for i in {1..12}; do
            if curl -sf "https://auth.tamshai.com/auth/realms/tamshai-corp/.well-known/openid-configuration" > /dev/null 2>&1; then
              echo "Realm tamshai-corp is available!"
              break
            fi
            echo "Attempt $i/12: Realm not ready yet, waiting 10s..."
            sleep 10
          done

      - name: Sync Realm Configuration
        env:
          KEYCLOAK_URL: https://auth.tamshai.com/auth
          KEYCLOAK_ADMIN: admin
        run: |
          echo "Running realm sync directly from GitHub Actions runner..."
          echo "This eliminates Cloud Run Job overhead (container pull + JVM startup)"

          # Fetch secrets from GCP Secret Manager (single source of truth for prod)
          export KEYCLOAK_ADMIN_PASSWORD=$(gcloud secrets versions access latest --secret=tamshai-prod-keycloak-admin-password)
          export MCP_HR_SERVICE_CLIENT_SECRET=$(gcloud secrets versions access latest --secret=mcp-hr-service-client-secret)

          # Make script executable and run it
          chmod +x keycloak/scripts/sync-realm.sh

          # Run sync with error handling
          if keycloak/scripts/sync-realm.sh prod; then
            echo "Realm sync completed successfully!"
          else
            echo "WARNING: Realm sync had errors but continuing deployment"
            # Don't fail the deployment - sync errors are usually recoverable
          fi

  deploy-static-website:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'web' ||
      github.event.inputs.service == 'website'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Marketing Website to GCS
        run: |
          # Deploy public marketing website at root (excluding markdown files)
          gcloud storage rsync --recursive apps/tamshai-website/src gs://prod.tamshai.com --exclude='\.md$'

          # Set cache control for index.html
          gcloud storage objects update gs://prod.tamshai.com/index.html --cache-control="no-cache,must-revalidate"

  deploy-web-portal:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'web'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Web Apps Image
        env:
          VITE_RELEASE_TAG: v1.0.0
          VITE_KEYCLOAK_URL: https://auth.tamshai.com/auth/realms/tamshai-corp
          VITE_KEYCLOAK_CLIENT_ID: web-portal
          VITE_API_GATEWAY_URL: https://mcp-gateway-fn44nd7wba-uc.a.run.app
          VITE_MCP_GATEWAY_URL: https://mcp-gateway-fn44nd7wba-uc.a.run.app
        run: |
          # Build ALL web apps (portal, hr, finance, sales, support) using unified Dockerfile
          docker build \
            -f clients/web/Dockerfile.prod \
            -t ${{ env.AR_REPO }}/web-portal:${{ github.sha }} \
            -t ${{ env.AR_REPO }}/web-portal:latest \
            --build-arg VITE_KEYCLOAK_URL=$VITE_KEYCLOAK_URL \
            --build-arg VITE_KEYCLOAK_CLIENT_ID=$VITE_KEYCLOAK_CLIENT_ID \
            --build-arg VITE_API_GATEWAY_URL=$VITE_API_GATEWAY_URL \
            --build-arg VITE_MCP_GATEWAY_URL=$VITE_MCP_GATEWAY_URL \
            .
          docker push ${{ env.AR_REPO }}/web-portal:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/web-portal:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy web-portal \
            --image=${{ env.AR_REPO }}/web-portal:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-gateway@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60 \
            --port=80

  notify:
    needs: [deploy-gateway, deploy-mcp-postgres, deploy-mcp-mongodb, deploy-keycloak, deploy-static-website, deploy-web-portal]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ needs.deploy-gateway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP PostgreSQL (HR, Finance) | ${{ needs.deploy-mcp-postgres.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP MongoDB (Sales, Support) | ${{ needs.deploy-mcp-mongodb.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Keycloak | ${{ needs.deploy-keycloak.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Website | ${{ needs.deploy-static-website.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Portal | ${{ needs.deploy-web-portal.result }} |" >> $GITHUB_STEP_SUMMARY
