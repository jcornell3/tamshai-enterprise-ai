name: Deploy to GCP Production

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'clients/web/**'
      - 'keycloak/**'
      - 'apps/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gateway
          - hr
          - finance
          - sales
          - support
          - keycloak
          - web
          - website

# Prevent concurrent deployments to production
# New deployments will wait in queue until current deployment completes
concurrency:
  group: deploy-to-gcp-production
  cancel-in-progress: false

env:
  GCP_REGION: us-central1
  AR_REPO: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/tamshai

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.changes.outputs.gateway }}
      mcp-suite: ${{ steps.changes.outputs.mcp-suite }}
      keycloak: ${{ steps.changes.outputs.keycloak }}
      web: ${{ steps.changes.outputs.web }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            gateway:
              - 'services/mcp-gateway/**'
            mcp-suite:
              - 'services/mcp-hr/**'
              - 'services/mcp-finance/**'
              - 'services/mcp-sales/**'
              - 'services/mcp-support/**'
            keycloak:
              - 'keycloak/**'
            web:
              - 'clients/web/**'
              - 'apps/tamshai-website/**'

  deploy-gateway:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.gateway == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'gateway'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Image
        run: |
          docker build -t ${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/mcp-gateway:latest \
                       services/mcp-gateway
          docker push ${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/mcp-gateway:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy mcp-gateway \
            --image=${{ env.AR_REPO }}/mcp-gateway:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-gateway@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300 \
            --set-secrets=CLAUDE_API_KEY=tamshai-prod-anthropic-api-key:latest \
            --set-env-vars="NODE_ENV=production,KEYCLOAK_URL=https://auth.tamshai.com/auth,KEYCLOAK_ISSUER=https://auth.tamshai.com/auth/realms/tamshai-corp,JWKS_URI=https://auth.tamshai.com/auth/realms/tamshai-corp/protocol/openid-connect/certs,MCP_HR_URL=https://mcp-hr-fn44nd7wba-uc.a.run.app,MCP_FINANCE_URL=https://mcp-finance-fn44nd7wba-uc.a.run.app,MCP_SALES_URL=https://mcp-sales-fn44nd7wba-uc.a.run.app,MCP_SUPPORT_URL=https://mcp-support-fn44nd7wba-uc.a.run.app,TOKEN_REVOCATION_FAIL_OPEN=true"

  deploy-mcp-suite:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.mcp-suite == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'hr' ||
      github.event.inputs.service == 'finance' ||
      github.event.inputs.service == 'sales' ||
      github.event.inputs.service == 'support'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [mcp-hr, mcp-finance, mcp-sales, mcp-support]
        include:
          - service: mcp-hr
            port: 3101
            db_name: tamshai_hr
          - service: mcp-finance
            port: 3102
            db_name: tamshai_finance
          - service: mcp-sales
            port: 3103
            db_name: tamshai_sales
          - service: mcp-support
            port: 3104
            db_name: tamshai_support
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          docker build -t ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/${{ matrix.service }}:latest \
                       services/${{ matrix.service }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/${{ matrix.service }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }} \
            --image=${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-servers@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --no-allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --vpc-connector=tamshai-prod-connector \
            --vpc-egress=private-ranges-only \
            --set-secrets=POSTGRES_PASSWORD=tamshai-prod-db-password:latest \
            --set-env-vars="NODE_ENV=production,POSTGRES_HOST=10.180.0.3,POSTGRES_PORT=5432,POSTGRES_DB=${{ matrix.db_name }},POSTGRES_USER=tamshai,PGSSLMODE=require"

  deploy-keycloak:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.keycloak == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'keycloak'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          docker build -t ${{ env.AR_REPO }}/keycloak:${{ github.sha }} \
                       -t ${{ env.AR_REPO }}/keycloak:latest \
                       keycloak
          docker push ${{ env.AR_REPO }}/keycloak:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/keycloak:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy keycloak \
            --image=${{ env.AR_REPO }}/keycloak:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-keycloak@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=4 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=600 \
            --vpc-connector=tamshai-prod-connector \
            --vpc-egress=private-ranges-only \
            --set-secrets=KEYCLOAK_ADMIN_PASSWORD=tamshai-prod-keycloak-admin-password:latest,KC_DB_PASSWORD=tamshai-prod-keycloak-db-password:latest \
            --set-env-vars="KEYCLOAK_ADMIN=admin,KC_DB=postgres,KC_DB_URL=jdbc:postgresql://10.180.0.3:5432/keycloak,KC_DB_USERNAME=keycloak,KC_HOSTNAME=auth.tamshai.com,KC_HOSTNAME_STRICT=false,KC_HTTP_PORT=8080,KC_PROXY=edge,KC_PROXY_HEADERS=xforwarded,KC_HTTP_RELATIVE_PATH=/auth"

  sync-keycloak-realm:
    needs: deploy-keycloak
    if: needs.deploy-keycloak.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Wait for Keycloak to be ready
        run: |
          echo "Waiting for Keycloak to be fully ready..."
          for i in {1..6}; do
            # Check realm endpoint instead of /health/ready which doesn't exist
            if curl -sf "https://auth.tamshai.com/auth/realms/tamshai-corp/.well-known/openid-configuration" > /dev/null 2>&1; then
              echo "Keycloak is ready!"
              break
            fi
            echo "Attempt $i/6: Keycloak not ready yet, waiting 10s..."
            sleep 10
          done

          # Final check
          if ! curl -sf "https://auth.tamshai.com/auth/realms/tamshai-corp/.well-known/openid-configuration" > /dev/null 2>&1; then
            echo "ERROR: Keycloak not ready after 60 seconds"
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Download Keycloak CLI Tools
        run: |
          echo "Downloading Keycloak CLI tools..."
          # Download Keycloak 25.0.0 (matches our deployed version)
          wget -q https://github.com/keycloak/keycloak/releases/download/25.0.0/keycloak-25.0.0.tar.gz
          tar -xzf keycloak-25.0.0.tar.gz
          echo "KEYCLOAK_HOME=$PWD/keycloak-25.0.0" >> $GITHUB_ENV
          echo "$PWD/keycloak-25.0.0/bin" >> $GITHUB_PATH
          echo "Keycloak CLI tools ready"

      - name: Sync Realm Configuration
        env:
          KEYCLOAK_URL: https://auth.tamshai.com/auth
          KEYCLOAK_ADMIN: admin
        run: |
          echo "Running realm sync directly from GitHub Actions runner..."
          echo "This eliminates Cloud Run Job overhead (container pull + JVM startup)"

          # Fetch admin password from GCP Secret Manager
          export KEYCLOAK_ADMIN_PASSWORD=$(gcloud secrets versions access latest --secret=tamshai-prod-keycloak-admin-password)

          # Make script executable and run it
          chmod +x keycloak/scripts/sync-realm.sh

          # Run sync with error handling
          if keycloak/scripts/sync-realm.sh prod; then
            echo "Realm sync completed successfully!"
          else
            echo "WARNING: Realm sync had errors but continuing deployment"
            # Don't fail the deployment - sync errors are usually recoverable
          fi

  deploy-static-website:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'web' ||
      github.event.inputs.service == 'website'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Marketing Website to GCS
        run: |
          # Deploy public marketing website at root (excluding markdown files)
          gcloud storage rsync --recursive apps/tamshai-website/src gs://prod.tamshai.com --exclude='\.md$'

          # Set cache control for index.html
          gcloud storage objects update gs://prod.tamshai.com/index.html --cache-control="no-cache,must-revalidate"

  deploy-web-portal:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      github.event.inputs.service == 'all' ||
      github.event.inputs.service == 'web'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Web Apps Image
        env:
          VITE_RELEASE_TAG: v1.0.0
          VITE_KEYCLOAK_URL: https://auth.tamshai.com/auth/realms/tamshai-corp
          VITE_KEYCLOAK_CLIENT_ID: web-portal
          VITE_API_GATEWAY_URL: https://mcp-gateway-fn44nd7wba-uc.a.run.app
          VITE_MCP_GATEWAY_URL: https://mcp-gateway-fn44nd7wba-uc.a.run.app
        run: |
          # Build ALL web apps (portal, hr, finance, sales, support) using unified Dockerfile
          docker build \
            -f clients/web/Dockerfile.prod \
            -t ${{ env.AR_REPO }}/web-portal:${{ github.sha }} \
            -t ${{ env.AR_REPO }}/web-portal:latest \
            --build-arg VITE_KEYCLOAK_URL=$VITE_KEYCLOAK_URL \
            --build-arg VITE_KEYCLOAK_CLIENT_ID=$VITE_KEYCLOAK_CLIENT_ID \
            --build-arg VITE_API_GATEWAY_URL=$VITE_API_GATEWAY_URL \
            --build-arg VITE_MCP_GATEWAY_URL=$VITE_MCP_GATEWAY_URL \
            .
          docker push ${{ env.AR_REPO }}/web-portal:${{ github.sha }}
          docker push ${{ env.AR_REPO }}/web-portal:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy web-portal \
            --image=${{ env.AR_REPO }}/web-portal:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --service-account=tamshai-prod-mcp-gateway@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60 \
            --port=80

  notify:
    needs: [deploy-gateway, deploy-mcp-suite, deploy-keycloak, deploy-static-website, deploy-web-portal]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ needs.deploy-gateway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Suite | ${{ needs.deploy-mcp-suite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Keycloak | ${{ needs.deploy-keycloak.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Website | ${{ needs.deploy-static-website.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Portal | ${{ needs.deploy-web-portal.result }} |" >> $GITHUB_STEP_SUMMARY
