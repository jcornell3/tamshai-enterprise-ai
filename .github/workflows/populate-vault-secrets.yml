# Populate Vault Secrets
#
# Populates Host Vault with application secrets from GitHub Secrets.
# Mirrors the dev environment setup in infrastructure/docker/vault/init-dev.sh
#
# This workflow should be run after setup-vault.yml to complete Vault configuration.
#
# Secrets stored:
#   - tamshai/mcp-gateway (claude_api_key, keycloak_client_secret)
#   - tamshai/databases (postgres_password, mongodb_password, keycloak_db_password, tamshai_db_password)
#   - tamshai/keycloak (admin_password)
#   - tamshai/storage (minio_root_password)

name: Populate Vault Secrets

on:
  workflow_dispatch:
    inputs:
      confirm_populate:
        description: 'Type "POPULATE" to confirm secrets population'
        required: true
        type: string
      force_update:
        description: 'Force update existing secrets'
        required: false
        type: boolean
        default: false

concurrency:
  group: populate-vault-secrets
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  populate-secrets:
    name: Populate Vault with Application Secrets
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm_populate == 'POPULATE' }}
    environment: staging

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm_populate != 'POPULATE' }}
        run: |
          echo "::error::You must type 'POPULATE' to confirm"
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Verify Vault is running and unsealed
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          VAULT_STATUS=$(ssh $VPS_USER@$VPS_HOST "VAULT_ADDR='https://127.0.0.1:8200' VAULT_SKIP_VERIFY=1 vault status -format=json 2>/dev/null" || echo '{"sealed":true}')
          SEALED=$(echo "$VAULT_STATUS" | jq -r '.sealed')

          if [ "$SEALED" = "true" ]; then
            echo "::error::Vault is sealed. Please unseal Vault first."
            exit 1
          fi

          echo "Vault is unsealed and ready"

      - name: Enable KV secrets engine
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Enabling KV v2 secrets engine at tamshai/..."
          vault secrets enable -path=tamshai kv-v2 2>/dev/null && echo "KV engine enabled" || echo "KV engine already enabled"

          echo "KV secrets engine ready"
          EOF

      - name: Populate MCP Gateway secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY_STAGE }}
          MCP_GATEWAY_CLIENT_SECRET: ${{ secrets.MCP_GATEWAY_CLIENT_SECRET }}
          MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.MCP_HR_SERVICE_CLIENT_SECRET }}
        run: |
          ssh $VPS_USER@$VPS_HOST "CLAUDE_API_KEY='$CLAUDE_API_KEY' MCP_GATEWAY_CLIENT_SECRET='$MCP_GATEWAY_CLIENT_SECRET' MCP_HR_SERVICE_CLIENT_SECRET='$MCP_HR_SERVICE_CLIENT_SECRET' bash -s" << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Storing MCP Gateway secrets..."
          vault kv put tamshai/mcp-gateway \
              claude_api_key="$CLAUDE_API_KEY" \
              keycloak_client_secret="$MCP_GATEWAY_CLIENT_SECRET" \
              hr_service_client_secret="$MCP_HR_SERVICE_CLIENT_SECRET"

          echo "MCP Gateway secrets stored"
          EOF

      - name: Populate database secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          TAMSHAI_DB_PASSWORD: ${{ secrets.TAMSHAI_DB_PASSWORD }}
          KEYCLOAK_DB_PASSWORD: ${{ secrets.KEYCLOAK_DB_PASSWORD }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
        run: |
          ssh $VPS_USER@$VPS_HOST "POSTGRES_PASSWORD='$POSTGRES_PASSWORD' TAMSHAI_DB_PASSWORD='$TAMSHAI_DB_PASSWORD' KEYCLOAK_DB_PASSWORD='$KEYCLOAK_DB_PASSWORD' MONGODB_PASSWORD='$MONGODB_PASSWORD' bash -s" << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Storing database secrets..."
          vault kv put tamshai/databases \
              postgres_password="$POSTGRES_PASSWORD" \
              tamshai_db_password="$TAMSHAI_DB_PASSWORD" \
              keycloak_db_password="$KEYCLOAK_DB_PASSWORD" \
              mongodb_password="$MONGODB_PASSWORD"

          echo "Database secrets stored"
          EOF

      - name: Populate Keycloak secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
        run: |
          ssh $VPS_USER@$VPS_HOST "KEYCLOAK_ADMIN_PASSWORD='$KEYCLOAK_ADMIN_PASSWORD' bash -s" << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Storing Keycloak secrets..."
          vault kv put tamshai/keycloak \
              admin_password="$KEYCLOAK_ADMIN_PASSWORD"

          echo "Keycloak secrets stored"
          EOF

      - name: Populate storage secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
        run: |
          ssh $VPS_USER@$VPS_HOST "MINIO_ROOT_PASSWORD='$MINIO_ROOT_PASSWORD' bash -s" << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Storing storage secrets..."
          vault kv put tamshai/storage \
              minio_root_user="minioadmin" \
              minio_root_password="$MINIO_ROOT_PASSWORD"

          echo "Storage secrets stored"
          EOF

      - name: Create Vault policies
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Creating MCP service policy..."
          vault policy write mcp-service - <<POLICY
          # Read-only access to MCP Gateway secrets
          path "tamshai/data/mcp-gateway" {
            capabilities = ["read"]
          }

          # Read-only access to database credentials
          path "tamshai/data/databases" {
            capabilities = ["read"]
          }
          POLICY

          echo "Creating Keycloak service policy..."
          vault policy write keycloak-service - <<POLICY
          # Read-only access to Keycloak secrets
          path "tamshai/data/keycloak" {
            capabilities = ["read"]
          }

          # Read-only access to database credentials
          path "tamshai/data/databases" {
            capabilities = ["read"]
          }
          POLICY

          echo "Creating storage service policy..."
          vault policy write storage-service - <<POLICY
          # Read-only access to storage secrets
          path "tamshai/data/storage" {
            capabilities = ["read"]
          }
          POLICY

          echo "Policies created"
          EOF

      - name: Enable AppRole authentication
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "Enabling AppRole auth..."
          vault auth enable approle 2>/dev/null && echo "AppRole enabled" || echo "AppRole already enabled"

          echo "Creating MCP Gateway AppRole..."
          vault write auth/approle/role/mcp-gateway \
              secret_id_ttl=24h \
              token_policies="mcp-service" \
              token_ttl=1h \
              token_max_ttl=4h

          echo "Creating Keycloak AppRole..."
          vault write auth/approle/role/keycloak \
              secret_id_ttl=24h \
              token_policies="keycloak-service" \
              token_ttl=1h \
              token_max_ttl=4h

          echo "AppRole authentication configured"
          EOF

      - name: Verify secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=1
          export VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault-init.txt | awk '{print $NF}')

          echo "=== Verifying Vault Configuration ==="
          echo ""
          echo "Secrets engines:"
          vault secrets list
          echo ""
          echo "Auth methods:"
          vault auth list
          echo ""
          echo "Policies:"
          vault policy list
          echo ""
          echo "KV secrets (keys only):"
          vault kv list tamshai/
          echo ""
          echo "AppRole roles:"
          vault list auth/approle/role
          EOF

      - name: Summary
        run: |
          echo "## Vault Secrets Population Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Stored" >> $GITHUB_STEP_SUMMARY
          echo "| Path | Contents |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`tamshai/mcp-gateway\` | claude_api_key, keycloak_client_secret, hr_service_client_secret |" >> $GITHUB_STEP_SUMMARY
          echo "| \`tamshai/databases\` | postgres_password, tamshai_db_password, keycloak_db_password, mongodb_password |" >> $GITHUB_STEP_SUMMARY
          echo "| \`tamshai/keycloak\` | admin_password |" >> $GITHUB_STEP_SUMMARY
          echo "| \`tamshai/storage\` | minio_root_user, minio_root_password |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Policies Created" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcp-service\` - Read access to mcp-gateway and databases" >> $GITHUB_STEP_SUMMARY
          echo "- \`keycloak-service\` - Read access to keycloak and databases" >> $GITHUB_STEP_SUMMARY
          echo "- \`storage-service\` - Read access to storage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AppRole Roles" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcp-gateway\` - For MCP Gateway service" >> $GITHUB_STEP_SUMMARY
          echo "- \`keycloak\` - For Keycloak service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Services can now authenticate via AppRole to read secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`bootstrap-vps.yml\` to restart services (still uses .env for now)" >> $GITHUB_STEP_SUMMARY
          echo "3. Future: Modify services to read directly from Vault" >> $GITHUB_STEP_SUMMARY
