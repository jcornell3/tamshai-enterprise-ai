# =============================================================================
# Provision Production Users
# =============================================================================
#
# This workflow provisions users in GCP production by executing the Cloud Run
# provision-users job, which runs inside the VPC and can access Cloud SQL
# via private IP.
#
# Architecture:
#   GitHub Actions -> executes Cloud Run Job -> Cloud SQL (private IP)
#
# The provision-users Cloud Run Job:
#   - Runs inside VPC via VPC connector
#   - Uses Cloud SQL Proxy with --private-ip flag
#   - Has access to all required secrets
#   - Supports: verify-only, load-hr-data, sync-users, all
#
# Usage:
#   1. Go to Actions > "Provision Production Users"
#   2. Click "Run workflow"
#   3. Select action and options
#   4. Review results in workflow logs
#
# =============================================================================

name: Provision Production Users

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - verify-only
          - load-hr-data
          - sync-users
          - all
        default: verify-only
      dry_run:
        description: 'Dry run (preview only, no changes)'
        required: false
        type: boolean
        default: true
      force_password_reset:
        description: 'Reset passwords for existing users'
        required: false
        type: boolean
        default: false
      region:
        description: 'GCP region (leave empty for production default)'
        required: false
        type: string
        default: ''
      cloud_sql_instance:
        description: 'Cloud SQL instance name (leave empty for production default)'
        required: false
        type: string
        default: ''

env:
  GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  # Bug #28 fix: Allow region override for DR or region changes
  GCP_REGION: ${{ github.event.inputs.region || vars.GCP_REGION }}
  CLOUD_SQL_INSTANCE: ${{ github.event.inputs.cloud_sql_instance || 'tamshai-prod-postgres' }}
  # KEYCLOAK_URL is discovered dynamically via gcloud in the Final Verification job
  KEYCLOAK_REALM: tamshai-corp

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    steps:
      - name: Display configuration
        run: |
          echo "=============================================="
          echo "Provision Production Users"
          echo "=============================================="
          echo "Action:              ${{ github.event.inputs.action }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo "Force Password Reset: ${{ github.event.inputs.force_password_reset }}"
          echo "GCP Project:         ${{ env.GCP_PROJECT }}"
          echo "Cloud SQL Instance:  ${{ env.CLOUD_SQL_INSTANCE }}"
          echo "Keycloak URL:        ${{ env.KEYCLOAK_URL }}"
          echo "=============================================="

  # ===========================================================================
  # Execute Provision Job (Cloud Run)
  # ===========================================================================
  execute-provision-job:
    name: Execute Provision Job
    runs-on: ubuntu-latest
    needs: preflight
    outputs:
      execution_name: ${{ steps.execute.outputs.execution_name }}
      job_result: ${{ steps.wait.outputs.result }}
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Execute provision-users Cloud Run Job
        id: execute
        run: |
          echo "=== Executing provision-users Cloud Run Job ==="
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "Force Password Reset: ${{ github.event.inputs.force_password_reset }}"
          echo ""

          # Execute the Cloud Run Job with environment variable overrides
          EXECUTION=$(gcloud run jobs execute provision-users \
            --region=${{ env.GCP_REGION }} \
            --update-env-vars="ACTION=${{ github.event.inputs.action }},DRY_RUN=${{ github.event.inputs.dry_run }},FORCE_PASSWORD_RESET=${{ github.event.inputs.force_password_reset }}" \
            --format="value(metadata.name)" \
            --async)

          echo "Execution started: $EXECUTION"
          echo "execution_name=$EXECUTION" >> $GITHUB_OUTPUT

      - name: Wait for job completion
        id: wait
        run: |
          EXECUTION="${{ steps.execute.outputs.execution_name }}"
          echo "Waiting for execution: $EXECUTION"
          echo ""

          # Poll for completion (max 20 minutes)
          MAX_WAIT=1200
          INTERVAL=10
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud run jobs executions describe "$EXECUTION" \
              --region=${{ env.GCP_REGION }} \
              --format="value(status.conditions[0].type,status.conditions[0].status)" 2>/dev/null || echo "Unknown Unknown")

            CONDITION_TYPE=$(echo "$STATUS" | awk '{print $1}')
            CONDITION_STATUS=$(echo "$STATUS" | awk '{print $2}')

            echo "[$ELAPSED s] Condition: $CONDITION_TYPE = $CONDITION_STATUS"

            if [ "$CONDITION_TYPE" = "Completed" ]; then
              if [ "$CONDITION_STATUS" = "True" ]; then
                echo ""
                echo "[OK] Job completed successfully"
                echo "result=success" >> $GITHUB_OUTPUT
                break
              elif [ "$CONDITION_STATUS" = "False" ]; then
                echo ""
                echo "[ERROR] Job failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                break
              fi
              # Unknown = still running, continue waiting
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo ""
            echo "[ERROR] Job timed out after $MAX_WAIT seconds"
            echo "result=timeout" >> $GITHUB_OUTPUT
          fi

      - name: Get job logs
        if: always()
        run: |
          EXECUTION="${{ steps.execute.outputs.execution_name }}"
          echo "=== Job Logs ==="
          echo ""

          # Get the task name
          TASK=$(gcloud run jobs executions describe "$EXECUTION" \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.runningCount,status.succeededCount,status.failedCount)" 2>/dev/null || echo "")

          echo "Task status: $TASK"
          echo ""

          # Get logs from Cloud Logging
          gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=provision-users AND labels.execution_name=$EXECUTION" \
            --limit=100 \
            --format="value(textPayload)" \
            --order=asc \
            2>/dev/null || echo "[WARN] Could not retrieve logs"

  # ===========================================================================
  # Final Verification
  # ===========================================================================
  final-verification:
    name: Final Verification
    runs-on: ubuntu-latest
    needs: [execute-provision-job]
    if: always()
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Discover Keycloak URL
        id: discover-url
        run: |
          KEYCLOAK_URL=$(gcloud run services describe keycloak \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.url)" 2>/dev/null || echo "")
          if [ -z "$KEYCLOAK_URL" ]; then
            echo "[WARN] Could not discover Keycloak URL"
          else
            echo "Keycloak URL: $KEYCLOAK_URL"
          fi
          echo "KEYCLOAK_URL=$KEYCLOAK_URL" >> $GITHUB_ENV

      - name: Verify Keycloak Users
        id: verify-keycloak
        run: |
          echo "=== Final Keycloak Verification ==="

          if [ -z "$KEYCLOAK_URL" ]; then
            echo "[WARN] Keycloak URL not discovered - skipping verification"
            echo "user_count=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get admin password from Secret Manager
          KC_ADMIN_PASSWORD=$(gcloud secrets versions access latest --secret="tamshai-prod-keycloak-admin-password" 2>/dev/null || echo "")

          if [ -z "$KC_ADMIN_PASSWORD" ]; then
            echo "[WARN] No Keycloak admin password - skipping verification"
            echo "user_count=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get admin token
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o "$RESPONSE_FILE" \
            -X POST "${{ env.KEYCLOAK_URL }}/realms/master/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=admin" \
            -d "password=$KC_ADMIN_PASSWORD" \
            -d "grant_type=password" \
            -d "client_id=admin-cli")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "[WARN] Keycloak auth failed with HTTP $HTTP_CODE"
            echo "user_count=unknown" >> $GITHUB_OUTPUT
            rm -f "$RESPONSE_FILE"
            exit 0
          fi

          TOKEN=$(jq -r '.access_token' "$RESPONSE_FILE" 2>/dev/null || echo "")
          rm -f "$RESPONSE_FILE"

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "[WARN] Could not extract token from response"
            echo "user_count=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get user count
          USERS=$(curl -s "${{ env.KEYCLOAK_URL }}/admin/realms/${{ env.KEYCLOAK_REALM }}/users?max=1000" \
            -H "Authorization: Bearer $TOKEN")

          USER_COUNT=$(echo "$USERS" | jq 'length')
          echo "[INFO] Users in Keycloak: $USER_COUNT"
          echo "user_count=$USER_COUNT" >> $GITHUB_OUTPUT

          # Check for key users
          echo ""
          echo "=== Key Users ==="
          for user in "test-user.journey" "eve.thompson" "alice.chen" "bob.martinez"; do
            EXISTS=$(echo "$USERS" | jq -r ".[] | select(.username == \"$user\") | .username")
            if [ -n "$EXISTS" ]; then
              echo "[OK] $user exists"
            else
              echo "[MISSING] $user not found"
            fi
          done

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "PROVISIONING SUMMARY"
          echo "=============================================="
          echo "Action:              ${{ github.event.inputs.action }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo "Force Password Reset: ${{ github.event.inputs.force_password_reset }}"
          echo ""
          echo "Cloud Run Job Result: ${{ needs.execute-provision-job.outputs.job_result }}"
          echo "Keycloak Users:       ${{ steps.verify-keycloak.outputs.user_count }}"
          echo "=============================================="

          # Fail if job failed
          if [ "${{ needs.execute-provision-job.outputs.job_result }}" = "failure" ]; then
            echo ""
            echo "[ERROR] Provision job failed - check logs above"
            exit 1
          fi

          if [ "${{ needs.execute-provision-job.outputs.job_result }}" = "timeout" ]; then
            echo ""
            echo "[ERROR] Provision job timed out"
            exit 1
          fi
