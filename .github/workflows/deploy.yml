# Complete GitHub Actions CI/CD Workflow
# Tamshai Enterprise AI - DevSecOps Pipeline
#
# Features:
# - Security scanning (SAST, dependency, container)
# - Terraform Cloud integration
# - HashiCorp Vault secrets management
# - Automated deployment to Hetzner VPS
# - Comprehensive audit logging

name: Tamshai DevSecOps Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  # NOTE: Disabled for pull requests - this is a deployment pipeline, not CI
  # CI checks are handled by ci.yml workflow
  # pull_request:
  #   branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  TERRAFORM_VERSION: '1.10.3'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # =============================================================================
  # STAGE 1: CODE QUALITY & SECURITY SCANNING
  # =============================================================================
  
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pylint black flake8 mypy
      
      - name: Run Black (formatter check)
        run: black --check .
      
      - name: Run Flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: Run Pylint
        run: pylint **/*.py --exit-zero
      
      - name: Run MyPy (type checking)
        continue-on-error: true  # Non-blocking - type hints are aspirational
        run: mypy . --ignore-missing-imports

  security-scan-code:
    name: Security - Code Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Secret scanning
      - name: GitGuardian Scan
        continue-on-error: true
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
      
      # SAST scanning
      - name: Run Semgrep
        continue-on-error: true  # Non-blocking - security findings require review
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/docker
            p/ci
      
      # Dependency scanning
      - name: Run Safety (Python)
        run: |
          pip install safety
          safety check --json --continue-on-error
      
      - name: Snyk Security Scan
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  security-scan-containers:
    name: Security - Container Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker images
        working-directory: ./infrastructure/docker
        # Use --no-cache --pull to ensure:
        # 1. apk upgrade runs fresh and applies latest security patches
        # 2. Latest node:20-alpine base image is pulled
        run: docker compose build --no-cache --pull
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mcp-gateway:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Grype
        run: |
          # Install Grype
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

          # Run Grype with config file (ignores fixed CVEs listed in .grype.yaml)
          grype mcp-gateway:latest --config .grype.yaml --fail-on high -o sarif > grype-results.sarif || {
            echo "Grype found vulnerabilities above threshold"
            cat grype-results.sarif | jq '.runs[].results[] | {ruleId: .ruleId, message: .message.text}' 2>/dev/null || true
            exit 1
          }
          echo "Grype scan passed"

  # =============================================================================
  # STAGE 2: INFRASTRUCTURE SECURITY
  # =============================================================================
  
  terraform-security:
    name: Terraform Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infrastructure/terraform

      - name: Terraform Init (Keycloak)
        run: terraform -chdir=./infrastructure/terraform/keycloak init -input=false -backend=false

      - name: Terraform Validate (Keycloak)
        run: terraform -chdir=./infrastructure/terraform/keycloak validate
      
      - name: tfsec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ./infrastructure/terraform
          soft_fail: false
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkov Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./infrastructure/terraform
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: checkov.sarif
      
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

  # =============================================================================
  # STAGE 3: BUILD & TEST
  # =============================================================================
  
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan-code]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/mcp-gateway/package-lock.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        working-directory: ./infrastructure/docker
        run: |
          docker compose build mcp-gateway

      - name: Install dependencies
        working-directory: ./services/mcp-gateway
        run: npm ci

      - name: Run unit tests
        working-directory: ./services/mcp-gateway
        run: npm test -- --coverage --coverageReporters=cobertura

      # NOTE: Integration tests are skipped in DevSecOps pipeline.
      # They are comprehensively covered by the CI workflow (ci.yml) which has:
      # - Proper GitHub Actions services with health checks
      # - Keycloak setup via Terraform
      # - MCP servers startup with proper environment
      # This pipeline focuses on security scanning and deployment.
      - name: Integration tests (skipped)
        run: |
          echo "â­ï¸ Integration tests are handled by CI workflow (ci.yml)"
          echo "   See: gateway-lint-test, integration-tests jobs"
          echo "   This pipeline focuses on security scanning and deployment."

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./services/mcp-gateway/coverage/coverage.xml
          fail_ci_if_error: false

  # =============================================================================
  # STAGE 4: TERRAFORM PLAN
  # =============================================================================
  
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-security, build-and-test]
    outputs:
      plan_status: ${{ steps.plan.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init & Plan (Keycloak)
        id: plan
        env:
          TF_VAR_test_user_password: ${{ secrets.DEV_USER_PASSWORD }}
        run: |
          terraform -chdir=./infrastructure/terraform/keycloak init -input=false -backend=false
          terraform -chdir=./infrastructure/terraform/keycloak validate
          terraform -chdir=./infrastructure/terraform/keycloak plan -input=false -no-color -var-file=environments/ci.tfvars -out=keycloak.tfplan
          terraform -chdir=./infrastructure/terraform/keycloak show -no-color keycloak.tfplan > keycloak-plan.txt

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infrastructure/terraform/keycloak/keycloak.tfplan
          retention-days: 5
      
      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/terraform/keycloak/keycloak-plan.txt', 'utf8');
            const output = `#### Terraform Plan ðŸ“– (Keycloak)

            <details><summary>Show Plan</summary>

            \`\`\`
            ${plan}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # =============================================================================
  # STAGE 5: DEPLOY TO STAGING (Auto for develop branch)
  # =============================================================================
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: github.ref == 'refs/heads/develop' && needs.terraform-plan.outputs.plan_status == 'success'
    environment:
      name: staging
      url: https://staging.tamshai.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get secrets from Vault
        uses: hashicorp/vault-action@v2
        id: vault
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            kv/data/staging/database password | DB_PASSWORD ;
            kv/data/staging/database host | DB_HOST ;
            kv/data/staging/keycloak client_secret | KEYCLOAK_SECRET ;
            kv/data/staging/api-keys anthropic_api_key | ANTHROPIC_API_KEY ;
            kv/data/staging/api-keys pinecone_api_key | PINECONE_API_KEY
      
      - name: Deploy to Staging VPS
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ steps.vault.outputs.DB_PASSWORD }}
          DB_HOST: ${{ steps.vault.outputs.DB_HOST }}
          KEYCLOAK_SECRET: ${{ steps.vault.outputs.KEYCLOAK_SECRET }}
          ANTHROPIC_API_KEY: ${{ steps.vault.outputs.ANTHROPIC_API_KEY }}
          PINECONE_API_KEY: ${{ steps.vault.outputs.PINECONE_API_KEY }}
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_PASSWORD,DB_HOST,KEYCLOAK_SECRET,ANTHROPIC_API_KEY,PINECONE_API_KEY
          script: |
            cd /opt/tamshai-staging
            
            # Create .env file from Vault secrets
            cat > .env <<EOF
            DB_PASSWORD=${DB_PASSWORD}
            DB_HOST=${DB_HOST}
            KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_SECRET}
            ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
            PINECONE_API_KEY=${PINECONE_API_KEY}
            EOF
            
            # Pull latest images
            docker compose pull

            # Deploy
            docker compose up -d
            
            # Health check
            sleep 10
            curl -f http://localhost:8000/health || exit 1
            
            # Cleanup
            docker system prune -af

  # =============================================================================
  # STAGE 6: DEPLOY TO PRODUCTION (Manual approval required)
  # =============================================================================
  
  # NOTE: Production deployment is disabled until production infrastructure is ready.
  # The terraform plan validates configuration but cannot be applied against localhost.
  # When production Keycloak is set up:
  # 1. Create production.tfvars with actual production Keycloak URL
  # 2. Configure Vault secrets for production
  # 3. Set PRODUCTION_HOST secret
  # 4. Remove 'false &&' from the condition below
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: false && github.ref == 'refs/heads/main' && needs.terraform-plan.outputs.plan_status == 'success'
    environment:
      name: production
      url: https://tamshai.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Download Terraform plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: infrastructure/terraform/keycloak/

      - name: Terraform Apply (Keycloak)
        run: |
          terraform -chdir=./infrastructure/terraform/keycloak init -input=false -backend=false
          terraform -chdir=./infrastructure/terraform/keycloak apply -auto-approve keycloak.tfplan

      - name: Get production secrets from Vault
        uses: hashicorp/vault-action@v2
        id: vault
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            kv/data/production/database password | DB_PASSWORD ;
            kv/data/production/database host | DB_HOST ;
            kv/data/production/keycloak client_secret | KEYCLOAK_SECRET ;
            kv/data/production/api-keys anthropic_api_key | ANTHROPIC_API_KEY ;
            kv/data/production/api-keys pinecone_api_key | PINECONE_API_KEY ;
            kv/data/production/api-keys supabase_key | SUPABASE_KEY

      - name: Deploy to Production VPS
        uses: appleboy/ssh-action@master
        env:
          DB_PASSWORD: ${{ steps.vault.outputs.DB_PASSWORD }}
          DB_HOST: ${{ steps.vault.outputs.DB_HOST }}
          KEYCLOAK_SECRET: ${{ steps.vault.outputs.KEYCLOAK_SECRET }}
          ANTHROPIC_API_KEY: ${{ steps.vault.outputs.ANTHROPIC_API_KEY }}
          PINECONE_API_KEY: ${{ steps.vault.outputs.PINECONE_API_KEY }}
          SUPABASE_KEY: ${{ steps.vault.outputs.SUPABASE_KEY }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_PASSWORD,DB_HOST,KEYCLOAK_SECRET,ANTHROPIC_API_KEY,PINECONE_API_KEY,SUPABASE_KEY,COMMIT_SHA
          script: |
            cd /opt/tamshai

            # Backup current version
            docker compose exec -T postgres pg_dump -U tamshai tamshai > backup_$(date +%Y%m%d_%H%M%S).sql

            # Create .env file from Vault secrets
            cat > .env <<EOF
            DB_PASSWORD=${DB_PASSWORD}
            DB_HOST=${DB_HOST}
            KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_SECRET}
            ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
            PINECONE_API_KEY=${PINECONE_API_KEY}
            SUPABASE_KEY=${SUPABASE_KEY}
            COMMIT_SHA=${COMMIT_SHA}
            EOF

            # Pull latest images
            docker compose pull

            # Blue-green deployment
            docker compose up -d --no-deps --build mcp-gateway

            # Health check
            sleep 15
            if ! curl -f http://localhost:3100/health; then
              echo "Health check failed, rolling back"
              docker compose rollback mcp-gateway
              exit 1
            fi

            # Update remaining services
            docker compose up -d

            # Cleanup old images
            docker image prune -af --filter "until=24h"

            # Log deployment
            echo "$(date -u) - Deployed commit ${COMMIT_SHA} by ${{ github.actor }}" >> /var/log/deployments.log

      - name: Run smoke tests
        run: |
          sleep 30
          curl -f https://tamshai.com/health
          curl -f https://tamshai.com/api/v1/status

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: ${{ job.status }}
          text: |
            Production deployment ${{ job.status }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

  # =============================================================================
  # STAGE 7: POST-DEPLOYMENT VERIFICATION
  # =============================================================================
  
  post-deployment-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run E2E tests against production
        run: |
          pip install pytest requests
          pytest tests/e2e/ --base-url=https://tamshai.com -v
      
      - name: Security scan production
        run: |
          # DAST scanning
          docker run --rm \
            -v $(pwd):/zap/wrk/:rw \
            -t owasp/zap2docker-stable zap-baseline.py \
            -t https://tamshai.com \
            -r zap-report.html
      
      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap-report.html

  # =============================================================================
  # AUDIT & COMPLIANCE
  # =============================================================================
  
  audit-log:
    name: Audit Logging
    runs-on: ubuntu-latest
    needs: [terraform-plan, build-and-test]
    if: always()
    steps:
      - name: Create audit log entry
        run: |
          cat > audit-log.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "security_scan",
            "environment": "ci",
            "actor": "${{ github.actor }}",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "terraform_plan_status": "${{ needs.terraform-plan.outputs.plan_status }}",
            "build_test_status": "${{ needs.build-and-test.result }}",
            "status": "${{ job.status }}"
          }
          EOF

      - name: Send to audit system
        run: |
          curl -X POST https://audit.tamshai.com/events \
            -H "Content-Type: application/json" \
            -d @audit-log.json \
            || echo "Audit log failed (non-critical)"
