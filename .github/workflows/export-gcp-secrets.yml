name: Export GCP Secrets to Terraform Variables

# This workflow exports GitHub secrets to a terraform.tfvars file
# The file is encrypted and available as a downloadable artifact
#
# Security: Only runs manually, requires repository maintainer approval

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "EXPORT_SECRETS" to confirm'
        required: true
        type: string

jobs:
  export-secrets:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'EXPORT_SECRETS'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create terraform.tfvars from secrets
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          MONGODB_ATLAS_URI_PROD: ${{ secrets.MONGODB_ATLAS_URI_PROD }}
        run: |
          cat > terraform.tfvars <<EOF
          # GCP Phase 1 Production - Terraform Variables
          #
          # ⚠️ IMPORTANT: This file contains sensitive values and is gitignored
          # NEVER commit this file to version control
          #
          # Generated from GitHub secrets on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # =============================================================================
          # PROJECT CONFIGURATION
          # =============================================================================

          project_id = "$GCP_PROJECT_ID"
          region = "us-central1"
          zone = "us-central1-a"

          # =============================================================================
          # NETWORKING
          # =============================================================================

          subnet_cidr = "10.0.0.0/24"
          serverless_connector_cidr = "10.8.0.0/28"

          # =============================================================================
          # DATABASE
          # =============================================================================

          database_tier = "db-f1-micro"
          mongodb_atlas_uri = "$MONGODB_ATLAS_URI_PROD"

          # =============================================================================
          # COMPUTE
          # =============================================================================

          enable_utility_vm = true
          keycloak_min_instances = "0"

          # =============================================================================
          # DOMAIN CONFIGURATION
          # =============================================================================

          keycloak_domain = "auth.tamshai.com"
          static_website_domain = "prod.tamshai.com"
          EOF

      - name: Display secret metadata (NOT values)
        run: |
          echo "✅ terraform.tfvars created with the following secrets:"
          echo "   - GCP_PROJECT_ID: ${#GCP_PROJECT_ID} characters"
          echo "   - MONGODB_ATLAS_URI_PROD: ${#MONGODB_ATLAS_URI_PROD} characters"
          echo ""
          echo "⚠️  IMPORTANT: Download the artifact and place it at:"
          echo "   infrastructure/terraform/gcp/terraform.tfvars"

      - name: Upload terraform.tfvars as artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-tfvars-gcp-prod
          path: terraform.tfvars
          retention-days: 1
          if-no-files-found: error

      - name: Security reminder
        run: |
          echo "=================================================="
          echo "⚠️  SECURITY REMINDER"
          echo "=================================================="
          echo ""
          echo "1. Download the artifact immediately"
          echo "2. Move it to: infrastructure/terraform/gcp/"
          echo "3. Delete the artifact from GitHub Actions"
          echo "4. Never commit terraform.tfvars to git"
          echo ""
          echo "The artifact will auto-delete after 24 hours."
          echo "=================================================="
