name: Export GCP Secrets to Terraform Variables

# This workflow exports GitHub secrets to a terraform.tfvars file
# The file is encrypted and available as a downloadable artifact
#
# Security: Only runs manually, requires repository maintainer approval

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "EXPORT_SECRETS" to confirm'
        required: true
        type: string

jobs:
  export-secrets:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'EXPORT_SECRETS'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create terraform.tfvars and service account key
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION }}
          MONGODB_ATLAS_URI_PROD: ${{ secrets.MONGODB_ATLAS_URI_PROD }}
          CLAUDE_API_KEY_PROD: ${{ secrets.CLAUDE_API_KEY_PROD }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY_PROD }}
        run: |
          # Create service account key file
          echo "$GCP_SA_KEY" > gcp-sa-key.json

          # Create terraform.tfvars
          cat > terraform.tfvars <<EOF
          # GCP Phase 1 Production - Terraform Variables
          #
          # ⚠️ IMPORTANT: This file contains sensitive values and is gitignored
          # NEVER commit this file to version control
          #
          # Generated from GitHub secrets on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # =============================================================================
          # PROJECT CONFIGURATION
          # =============================================================================

          project_id = "$GCP_PROJECT_ID"
          region = "$GCP_REGION"
          zone = "${GCP_REGION}-a"

          # =============================================================================
          # NETWORKING
          # =============================================================================

          subnet_cidr = "10.0.0.0/24"
          serverless_connector_cidr = "10.8.0.0/28"

          # =============================================================================
          # DATABASE
          # =============================================================================

          database_tier = "db-f1-micro"
          mongodb_atlas_uri = "$MONGODB_ATLAS_URI_PROD"
          claude_api_key = "$CLAUDE_API_KEY_PROD"

          # =============================================================================
          # COMPUTE
          # =============================================================================

          enable_utility_vm = true
          keycloak_min_instances = "0"

          # =============================================================================
          # DOMAIN CONFIGURATION
          # =============================================================================

          keycloak_domain = "auth.tamshai.com"
          static_website_domain = "prod.tamshai.com"
          api_domain            = "api.tamshai.com"
          app_domain            = "app.tamshai.com"
          EOF

      - name: Display secret metadata (NOT values)
        run: |
          echo "✅ Files created:"
          echo "   - terraform.tfvars (GCP_PROJECT_ID, MONGODB_ATLAS_URI_PROD, CLAUDE_API_KEY_PROD)"
          echo "   - gcp-sa-key.json (GCP service account credentials)"
          echo ""
          echo "⚠️  IMPORTANT: Download the artifact and place files at:"
          echo "   - infrastructure/terraform/gcp/terraform.tfvars"
          echo "   - infrastructure/terraform/gcp/gcp-sa-key.json"

      - name: Upload terraform config files as artifact
        uses: actions/upload-artifact@v6
        with:
          name: terraform-tfvars-gcp-prod
          path: |
            terraform.tfvars
            gcp-sa-key.json
          retention-days: 1
          if-no-files-found: error

      - name: Security reminder
        run: |
          echo "=================================================="
          echo "⚠️  SECURITY REMINDER"
          echo "=================================================="
          echo ""
          echo "1. Download the artifact immediately"
          echo "2. Move it to: infrastructure/terraform/gcp/"
          echo "3. Delete the artifact from GitHub Actions"
          echo "4. Never commit terraform.tfvars to git"
          echo ""
          echo "The artifact will auto-delete after 24 hours."
          echo "=================================================="
