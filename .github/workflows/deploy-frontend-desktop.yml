# Flutter Desktop App Build Workflow
#
# This workflow builds the Flutter unified desktop app for web.
# The actual deployment happens via the VPS deployment workflow.
#
# Strategy:
#   1. Build Flutter web app (flutter build web --release)
#   2. Upload build artifacts for inspection/download
#   3. VPS deployment handles serving the app
#
# Build Time: 2-3 minutes

name: Build Flutter Desktop App

on:
  push:
    branches: [main]
    paths:
      - 'clients/unified_flutter/**'
      - '.github/workflows/deploy-frontend-desktop.yml'

  pull_request:
    branches: [main]
    paths:
      - 'clients/unified_flutter/**'

  workflow_dispatch:

concurrency:
  group: build-flutter-desktop-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.38.0'  # Dart 3.7+ required for flutter_appauth ^11.0.0

permissions:
  contents: read

jobs:
  build:
    name: Build Flutter Web App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: clients/unified_flutter
        run: flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build web app
        working-directory: clients/unified_flutter
        run: flutter build web --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: flutter-web-build
          path: clients/unified_flutter/build/web
          retention-days: 7

      - name: Build summary
        run: |
          echo "## Flutter Web Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build artifacts**: Available for 7 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The web app is deployed to VPS via the Deploy to VPS workflow." >> $GITHUB_STEP_SUMMARY
