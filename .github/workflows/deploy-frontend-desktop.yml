# Incremental Deployment: Flutter Desktop App (Static Assets)
#
# This workflow builds and deploys the Flutter unified desktop app
# as static assets to Cloudflare Pages or CDN.
#
# Strategy:
#   1. Build Flutter web app (flutter build web --release)
#   2. Deploy to Cloudflare Pages
#   3. Invalidate cache
#   4. No downtime (CDN serves new version immediately)
#
# Deployment Time: 2-3 minutes
# Downtime: 0 seconds (CDN cutover)

name: Deploy Frontend - Desktop App

on:
  push:
    branches: [main]
    paths:
      - 'clients/unified_flutter/**'
      - '.github/workflows/deploy-frontend-desktop.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

concurrency:
  group: deploy-frontend-desktop-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
  FLUTTER_VERSION: '3.24.0'

permissions:
  contents: read
  deployments: write

jobs:
  build-and-deploy:
    name: Build and Deploy Flutter Desktop App
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: clients/unified_flutter
        run: flutter pub get

      - name: Generate code (Freezed, JSON serialization)
        working-directory: clients/unified_flutter
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build web app
        working-directory: clients/unified_flutter
        run: flutter build web --release --web-renderer canvaskit

      - name: Deploy to Cloudflare Pages (Staging)
        if: env.ENVIRONMENT == 'staging'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: tamshai-desktop-staging
          directory: clients/unified_flutter/build/web
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Cloudflare Pages (Production)
        if: env.ENVIRONMENT == 'production'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: tamshai-desktop-production
          directory: clients/unified_flutter/build/web
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Deployment summary
        if: success()
        run: |
          echo "## ✅ Flutter Desktop App Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**App**: Flutter Unified Desktop" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.ENVIRONMENT }}" == "staging" ]; then
            echo "**URL**: https://tamshai-desktop-staging.pages.dev" >> $GITHUB_STEP_SUMMARY
          else
            echo "**URL**: https://desktop.tamshai.com" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment failed
        if: failure()
        run: |
          echo "## ❌ Flutter Desktop App Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**App**: Flutter Unified Desktop" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
