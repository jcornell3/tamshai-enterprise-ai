# Environment Promotion: Staging â†’ Production
#
# This workflow promotes code from staging to production environment.
#
# IMPORTANT: Production deployment requires manual approval.
#   - Review smoke test results before approving
#   - Production deployment is IRREVERSIBLE (use rollback workflows if needed)
#   - All services restarted (5-10 minute downtime)
#
# Strategy:
#   1. Run comprehensive pre-deployment tests
#   2. Create Git tag for production release
#   3. Wait for manual approval (GitHub Environment protection)
#   4. Deploy to production VPS
#   5. Run production smoke tests
#   6. Notify team of promotion
#
# Approval: Manual approval required (GitHub Environment protection)
# Deployment Time: 5-10 minutes (full stack deployment)

name: Promote Staging to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.4.0)'
        required: true
        type: string
      services:
        description: 'Services to promote (comma-separated, or "all")'
        required: true
        default: 'all'
        type: string
      skip_tests:
        description: 'Skip pre-deployment tests (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false

concurrency:
  group: promote-staging-to-production
  cancel-in-progress: false

permissions:
  contents: write
  deployments: write

jobs:
  pre-deployment-tests:
    name: Pre-Deployment Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Run staging smoke tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: |
          echo "ðŸ§ª Running staging smoke tests..."

          # MCP Gateway
          if curl -sf $STAGING_URL:3100/health | jq -e '.status == "healthy"'; then
            echo "âœ… MCP Gateway healthy"
          else
            echo "âŒ MCP Gateway health check failed"
            exit 1
          fi

          # Keycloak
          if curl -sf $STAGING_URL:8180/health/ready; then
            echo "âœ… Keycloak healthy"
          else
            echo "âŒ Keycloak health check failed"
            exit 1
          fi

          # Kong
          if curl -sf $STAGING_URL:8100/api/health; then
            echo "âœ… Kong healthy"
          else
            echo "âŒ Kong health check failed"
            exit 1
          fi

          echo "âœ… All staging smoke tests passed"

      - name: Validate version tag
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version tag format. Expected: v1.4.0 (no -staging suffix)"
            exit 1
          fi
          echo "âœ… Version tag valid: ${{ github.event.inputs.version }}"

  promote:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-tests
    if: always() && (needs.pre-deployment-tests.result == 'success' || github.event.inputs.skip_tests == 'true')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          fetch-depth: 0

      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git tag -a ${{ github.event.inputs.version }} -m "Production release ${{ github.event.inputs.version }}"
          git push origin ${{ github.event.inputs.version }}

          echo "âœ… Git tag created: ${{ github.event.inputs.version }}"

      - name: Setup SSH
        env:
          PROD_VPS_HOST: ${{ secrets.PROD_VPS_HOST }}
          PROD_VPS_USER: ${{ secrets.PROD_VPS_USER }}
          PROD_SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$PROD_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $PROD_VPS_HOST >> ~/.ssh/known_hosts

      - name: Promote services to production
        env:
          PROD_VPS_HOST: ${{ secrets.PROD_VPS_HOST }}
          PROD_VPS_USER: ${{ secrets.PROD_VPS_USER }}
          VERSION: ${{ github.event.inputs.version }}
          SERVICES: ${{ github.event.inputs.services }}
        run: |
          ssh $PROD_VPS_USER@$PROD_VPS_HOST << EOF
          set -e
          cd /opt/tamshai

          echo "ðŸš€ Promoting to PRODUCTION: $VERSION"
          echo "âš ï¸  WARNING: Production deployment in progress"
          echo "ðŸ“¦ Services: $SERVICES"

          # Pull latest code
          git fetch --all --tags
          git checkout $VERSION

          if [ "$SERVICES" == "all" ]; then
            echo "ðŸ“¦ Deploying all services..."
            docker compose -f docker-compose.prod.yml build
            docker compose -f docker-compose.prod.yml up -d
          else
            echo "ðŸ“¦ Deploying selected services: $SERVICES"
            IFS=',' read -ra SVC_ARRAY <<< "$SERVICES"
            for svc in "\${SVC_ARRAY[@]}"; do
              echo "  - Deploying \$svc..."
              docker compose -f docker-compose.prod.yml build \$svc
              docker compose -f docker-compose.prod.yml up -d --no-deps \$svc
            done
          fi

          echo "âœ… Production deployment complete"
          EOF

      - name: Run production smoke tests
        env:
          PROD_VPS_HOST: ${{ secrets.PROD_VPS_HOST }}
        run: |
          echo "ðŸ§ª Running production smoke tests..."

          # MCP Gateway
          if curl -sf http://$PROD_VPS_HOST:3100/health | jq -e '.status == "healthy"'; then
            echo "âœ… MCP Gateway healthy"
          else
            echo "âŒ MCP Gateway health check failed"
            exit 1
          fi

          # Keycloak
          if curl -sf http://$PROD_VPS_HOST:8180/health/ready; then
            echo "âœ… Keycloak healthy"
          else
            echo "âŒ Keycloak health check failed"
            exit 1
          fi

          # Kong
          if curl -sf http://$PROD_VPS_HOST:8100/api/health; then
            echo "âœ… Kong healthy"
          else
            echo "âŒ Kong health check failed"
            exit 1
          fi

          echo "âœ… All production smoke tests passed"

      - name: Promotion summary
        if: success()
        run: |
          echo "## âœ… Production Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Services**: ${{ github.event.inputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Production Smoke Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL**: https://app.tamshai.com" >> $GITHUB_STEP_SUMMARY

      - name: Promotion failed
        if: failure()
        run: |
          echo "## âŒ Production Promotion Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Services**: ${{ github.event.inputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: CRITICAL - Production deployment failed" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**: Use rollback workflows to restore previous version" >> $GITHUB_STEP_SUMMARY
