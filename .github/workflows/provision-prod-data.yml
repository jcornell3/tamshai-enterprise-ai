# =============================================================================
# Provision Production Sample Data
# =============================================================================
#
# This workflow loads Finance, Sales, and Support sample data into production
# databases. It should be run after provision-prod-users.yml in the Phoenix
# rebuild process.
#
# Phoenix Rebuild Sequence:
#   1. terraform destroy + apply
#   2. deploy-to-gcp.yml (deploys all services)
#   3. provision-prod-users.yml (loads HR data, syncs users to Keycloak)
#   4. provision-prod-data.yml (this workflow - loads Finance, Sales, Support)
#
# Data Targets:
#   - Finance: Cloud SQL PostgreSQL (tamshai_finance database)
#   - Sales: MongoDB Atlas (tamshai_sales database)
#   - Support: MongoDB Atlas (tamshai_support database)
#
# Usage:
#   1. Go to Actions > "Provision Production Data"
#   2. Click "Run workflow"
#   3. Select which data to load (all, finance, sales, support)
#   4. Enable/disable dry-run mode
#   5. Review results in workflow logs
#
# =============================================================================

name: Provision Production Data

on:
  workflow_dispatch:
    inputs:
      data_set:
        description: 'Data set to load'
        required: true
        type: choice
        options:
          - all
          - finance
          - sales
          - support
        default: all
      dry_run:
        description: 'Dry run (preview only, no changes)'
        required: false
        type: boolean
        default: true

env:
  GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  CLOUD_SQL_INSTANCE: tamshai-prod-postgres

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      load_finance: ${{ steps.check.outputs.load_finance }}
      load_sales: ${{ steps.check.outputs.load_sales }}
      load_support: ${{ steps.check.outputs.load_support }}
    steps:
      - name: Determine data sets to load
        id: check
        run: |
          DATA_SET="${{ github.event.inputs.data_set }}"

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "finance" ]; then
            echo "load_finance=true" >> $GITHUB_OUTPUT
          else
            echo "load_finance=false" >> $GITHUB_OUTPUT
          fi

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "sales" ]; then
            echo "load_sales=true" >> $GITHUB_OUTPUT
          else
            echo "load_sales=false" >> $GITHUB_OUTPUT
          fi

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "support" ]; then
            echo "load_support=true" >> $GITHUB_OUTPUT
          else
            echo "load_support=false" >> $GITHUB_OUTPUT
          fi

      - name: Display configuration
        run: |
          echo "=============================================="
          echo "Provision Production Data"
          echo "=============================================="
          echo "Data Set:            ${{ github.event.inputs.data_set }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo "GCP Project:         ${{ env.GCP_PROJECT }}"
          echo "Cloud SQL Instance:  ${{ env.CLOUD_SQL_INSTANCE }}"
          echo ""
          echo "Data to load:"
          echo "  - Finance (Cloud SQL): ${{ steps.check.outputs.load_finance }}"
          echo "  - Sales (MongoDB):     ${{ steps.check.outputs.load_sales }}"
          echo "  - Support (MongoDB):   ${{ steps.check.outputs.load_support }}"
          echo "=============================================="

  # ===========================================================================
  # Load Finance Data (Cloud SQL via Cloud Run Job)
  # ===========================================================================
  # NOTE: Cloud SQL has private IP only - cannot connect from GitHub Actions.
  # We use the existing Cloud Run Job which has VPC connector access.
  # ===========================================================================
  load-finance-data:
    name: Load Finance Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_finance == 'true'
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Load Finance Data via Cloud Run Job
        run: |
          echo "=== Loading Finance Sample Data via Cloud Run Job ==="
          echo "[INFO] Cloud SQL has private IP only - using Cloud Run Job with VPC connector"

          DRY_RUN_VAL="${{ github.event.inputs.dry_run }}"

          if [ "$DRY_RUN_VAL" = "true" ]; then
            echo "[DRY RUN] Would execute Cloud Run Job with ACTION=load-finance-data"
            echo "[DRY RUN] Job: provision-users"
            echo "[DRY RUN] Region: ${{ env.GCP_REGION }}"
            exit 0
          fi

          # Execute the Cloud Run Job with load-finance-data action
          echo "[INFO] Executing Cloud Run Job..."
          gcloud run jobs execute provision-users \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT }} \
            --update-env-vars="ACTION=load-finance-data,DRY_RUN=false" \
            --wait

          echo "[OK] Finance data loaded via Cloud Run Job"

      - name: Verify Finance Data Loaded
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "=== Verifying Finance Data ==="
          echo "[INFO] Check Cloud Run Job logs for detailed output:"
          echo "  gcloud logging read 'resource.type=cloud_run_job AND resource.labels.job_name=provision-users' --limit=50"

  # ===========================================================================
  # Load Sales Data (MongoDB Atlas)
  # ===========================================================================
  load-sales-data:
    name: Load Sales Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_sales == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install MongoDB Shell
        run: |
          wget -qO- https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

      - name: Get MongoDB URI
        id: get-mongodb-uri
        run: |
          MONGODB_URI=$(gcloud secrets versions access latest --secret="tamshai-prod-mongodb-uri")
          echo "::add-mask::$MONGODB_URI"
          echo "mongodb_uri=$MONGODB_URI" >> $GITHUB_OUTPUT

      - name: Verify Sales Database State (Before)
        id: verify-before
        run: |
          echo "=== Sales Database State (Before) ==="

          CUSTOMER_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').customers.countDocuments()" 2>/dev/null || echo "0")
          OPPORTUNITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').opportunities.countDocuments()" 2>/dev/null || echo "0")

          echo "[INFO] Customers: $CUSTOMER_COUNT"
          echo "[INFO] Opportunities: $OPPORTUNITY_COUNT"
          echo "customer_count=$CUSTOMER_COUNT" >> $GITHUB_OUTPUT
          echo "opportunity_count=$OPPORTUNITY_COUNT" >> $GITHUB_OUTPUT

      - name: Load Sales Sample Data
        run: |
          echo "=== Loading Sales Sample Data ==="

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would load sample-data/sales-data.js into tamshai_sales"
            echo "[DRY RUN] File size: $(wc -l < sample-data/sales-data.js) lines"
            exit 0
          fi

          # Load the data
          mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --file sample-data/sales-data.js

          echo "[OK] Sales data loaded successfully"

      - name: Verify Sales Database State (After)
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "=== Sales Database State (After) ==="

          CUSTOMER_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').customers.countDocuments()")
          OPPORTUNITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').opportunities.countDocuments()")
          ACTIVITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').activities.countDocuments()")

          echo "[OK] Customers: $CUSTOMER_COUNT"
          echo "[OK] Opportunities: $OPPORTUNITY_COUNT"
          echo "[OK] Activities: $ACTIVITY_COUNT"

  # ===========================================================================
  # Load Support Data (MongoDB Atlas)
  # ===========================================================================
  load-support-data:
    name: Load Support Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_support == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install MongoDB Shell
        run: |
          wget -qO- https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

      - name: Get MongoDB URI
        id: get-mongodb-uri
        run: |
          MONGODB_URI=$(gcloud secrets versions access latest --secret="tamshai-prod-mongodb-uri")
          echo "::add-mask::$MONGODB_URI"
          echo "mongodb_uri=$MONGODB_URI" >> $GITHUB_OUTPUT

      - name: Verify Support Database State (Before)
        id: verify-before
        run: |
          echo "=== Support Database State (Before) ==="

          TICKET_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').tickets.countDocuments()" 2>/dev/null || echo "0")
          KB_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').articles.countDocuments()" 2>/dev/null || echo "0")

          echo "[INFO] Tickets: $TICKET_COUNT"
          echo "[INFO] KB Articles: $KB_COUNT"
          echo "ticket_count=$TICKET_COUNT" >> $GITHUB_OUTPUT
          echo "kb_count=$KB_COUNT" >> $GITHUB_OUTPUT

      - name: Load Support Sample Data
        run: |
          echo "=== Loading Support Sample Data ==="

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would load sample-data/support-data.js into tamshai_support"
            echo "[DRY RUN] File size: $(wc -l < sample-data/support-data.js) lines"
            exit 0
          fi

          # Load the data
          mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --file sample-data/support-data.js

          echo "[OK] Support data loaded successfully"

      - name: Verify Support Database State (After)
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "=== Support Database State (After) ==="

          TICKET_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').tickets.countDocuments()")
          KB_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').articles.countDocuments()")

          echo "[OK] Tickets: $TICKET_COUNT"
          echo "[OK] KB Articles: $KB_COUNT"

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Provisioning Summary
    runs-on: ubuntu-latest
    needs: [preflight, load-finance-data, load-sales-data, load-support-data]
    if: always()
    steps:
      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "PROVISIONING SUMMARY"
          echo "=============================================="
          echo "Data Set:            ${{ github.event.inputs.data_set }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo ""
          echo "JOB RESULTS:"
          echo "  Load Finance Data: ${{ needs.load-finance-data.result }}"
          echo "  Load Sales Data:   ${{ needs.load-sales-data.result }}"
          echo "  Load Support Data: ${{ needs.load-support-data.result }}"
          echo "=============================================="

          # Write to job summary
          echo "## Provision Production Data Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Data Set | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Finance (Cloud SQL) | ${{ needs.load-finance-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sales (MongoDB) | ${{ needs.load-sales-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Support (MongoDB) | ${{ needs.load-support-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
