# =============================================================================
# Provision Production Sample Data
# =============================================================================
#
# This workflow loads Finance, Sales, and Support sample data into production
# databases. It should be run after provision-prod-users.yml in the Phoenix
# rebuild process.
#
# Phoenix Rebuild Sequence:
#   1. terraform destroy + apply
#   2. deploy-to-gcp.yml (deploys all services)
#   3. provision-prod-users.yml (loads HR data, syncs users to Keycloak)
#   4. provision-prod-data.yml (this workflow - loads Finance, Sales, Support)
#
# Data Targets:
#   - Finance: Cloud SQL PostgreSQL (tamshai_finance database)
#   - Sales: MongoDB Atlas (tamshai_sales database)
#   - Support: MongoDB Atlas (tamshai_support database)
#
# Usage:
#   1. Go to Actions > "Provision Production Data"
#   2. Click "Run workflow"
#   3. Select which data to load (all, finance, sales, support)
#   4. Enable/disable dry-run mode
#   5. Review results in workflow logs
#
# =============================================================================

name: Provision Production Data

on:
  workflow_dispatch:
    inputs:
      data_set:
        description: 'Data set to load'
        required: true
        type: choice
        options:
          - all
          - finance
          - sales
          - support
        default: all
      dry_run:
        description: 'Dry run (preview only, no changes)'
        required: false
        type: boolean
        default: true

env:
  GCP_PROJECT: gen-lang-client-0553641830
  GCP_REGION: us-central1
  CLOUD_SQL_INSTANCE: tamshai-prod-postgres

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      load_finance: ${{ steps.check.outputs.load_finance }}
      load_sales: ${{ steps.check.outputs.load_sales }}
      load_support: ${{ steps.check.outputs.load_support }}
    steps:
      - name: Determine data sets to load
        id: check
        run: |
          DATA_SET="${{ github.event.inputs.data_set }}"

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "finance" ]; then
            echo "load_finance=true" >> $GITHUB_OUTPUT
          else
            echo "load_finance=false" >> $GITHUB_OUTPUT
          fi

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "sales" ]; then
            echo "load_sales=true" >> $GITHUB_OUTPUT
          else
            echo "load_sales=false" >> $GITHUB_OUTPUT
          fi

          if [ "$DATA_SET" = "all" ] || [ "$DATA_SET" = "support" ]; then
            echo "load_support=true" >> $GITHUB_OUTPUT
          else
            echo "load_support=false" >> $GITHUB_OUTPUT
          fi

      - name: Display configuration
        run: |
          echo "=============================================="
          echo "Provision Production Data"
          echo "=============================================="
          echo "Data Set:            ${{ github.event.inputs.data_set }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo "GCP Project:         ${{ env.GCP_PROJECT }}"
          echo "Cloud SQL Instance:  ${{ env.CLOUD_SQL_INSTANCE }}"
          echo ""
          echo "Data to load:"
          echo "  - Finance (Cloud SQL): ${{ steps.check.outputs.load_finance }}"
          echo "  - Sales (MongoDB):     ${{ steps.check.outputs.load_sales }}"
          echo "  - Support (MongoDB):   ${{ steps.check.outputs.load_support }}"
          echo "=============================================="

  # ===========================================================================
  # Load Finance Data (Cloud SQL)
  # ===========================================================================
  load-finance-data:
    name: Load Finance Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_finance == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          sudo mv cloud-sql-proxy /usr/local/bin/

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Get database password
        id: get-db-password
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret="tamshai-prod-db-password")
          echo "::add-mask::$DB_PASSWORD"
          echo "db_password=$DB_PASSWORD" >> $GITHUB_OUTPUT

      - name: Start Cloud SQL Proxy and verify connection
        env:
          PGPASSWORD: ${{ steps.get-db-password.outputs.db_password }}
        run: |
          echo "[INFO] Starting Cloud SQL Proxy..."
          cloud-sql-proxy ${{ env.GCP_PROJECT }}:${{ env.GCP_REGION }}:${{ env.CLOUD_SQL_INSTANCE }} \
            --port=5432 &
          PROXY_PID=$!

          echo "[INFO] Waiting for proxy to be ready..."
          for i in {1..30}; do
            if psql -h localhost -p 5432 -U tamshai -d postgres -c "SELECT 1;" > /dev/null 2>&1; then
              echo "[OK] Cloud SQL Proxy ready after ${i}s"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "[ERROR] Cloud SQL Proxy failed to connect after 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Verify Finance Database State (Before)
        id: verify-before
        env:
          PGPASSWORD: ${{ steps.get-db-password.outputs.db_password }}
        run: |
          echo "=== Finance Database State (Before) ==="

          # Check if database exists
          DB_EXISTS=$(psql -h localhost -p 5432 -U tamshai -d postgres -t -c \
            "SELECT COUNT(*) FROM pg_database WHERE datname = 'tamshai_finance';" | tr -d ' ')

          if [ "$DB_EXISTS" = "0" ]; then
            echo "[WARN] tamshai_finance database does not exist"
            echo "invoice_count=0" >> $GITHUB_OUTPUT
            echo "expense_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if finance schema exists
          SCHEMA_EXISTS=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM information_schema.schemata WHERE schema_name = 'finance';" | tr -d ' ')

          if [ "$SCHEMA_EXISTS" = "0" ]; then
            echo "[INFO] finance schema does not exist yet"
            echo "invoice_count=0" >> $GITHUB_OUTPUT
            echo "expense_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count records
          INVOICE_COUNT=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM finance.invoices;" 2>/dev/null | tr -d ' ' || echo "0")
          EXPENSE_COUNT=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM finance.expense_reports;" 2>/dev/null | tr -d ' ' || echo "0")

          echo "[INFO] Invoices: $INVOICE_COUNT"
          echo "[INFO] Expense Reports: $EXPENSE_COUNT"
          echo "invoice_count=$INVOICE_COUNT" >> $GITHUB_OUTPUT
          echo "expense_count=$EXPENSE_COUNT" >> $GITHUB_OUTPUT

      - name: Load Finance Sample Data
        env:
          PGPASSWORD: ${{ steps.get-db-password.outputs.db_password }}
        run: |
          echo "=== Loading Finance Sample Data ==="

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would load sample-data/finance-data.sql into tamshai_finance"
            echo "[DRY RUN] File size: $(wc -l < sample-data/finance-data.sql) lines"
            exit 0
          fi

          # Create database if it doesn't exist
          psql -h localhost -p 5432 -U tamshai -d postgres -c \
            "SELECT 'CREATE DATABASE tamshai_finance' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'tamshai_finance')\gexec"

          # Load the data
          psql -h localhost -p 5432 -U tamshai -d postgres -f sample-data/finance-data.sql

          echo "[OK] Finance data loaded successfully"

      - name: Verify Finance Database State (After)
        if: github.event.inputs.dry_run != 'true'
        env:
          PGPASSWORD: ${{ steps.get-db-password.outputs.db_password }}
        run: |
          echo "=== Finance Database State (After) ==="

          INVOICE_COUNT=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM finance.invoices;" | tr -d ' ')
          EXPENSE_COUNT=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM finance.expense_reports;" | tr -d ' ')
          BUDGET_COUNT=$(psql -h localhost -p 5432 -U tamshai -d tamshai_finance -t -c \
            "SELECT COUNT(*) FROM finance.budgets;" | tr -d ' ')

          echo "[OK] Invoices: $INVOICE_COUNT"
          echo "[OK] Expense Reports: $EXPENSE_COUNT"
          echo "[OK] Budgets: $BUDGET_COUNT"

  # ===========================================================================
  # Load Sales Data (MongoDB Atlas)
  # ===========================================================================
  load-sales-data:
    name: Load Sales Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_sales == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install MongoDB Shell
        run: |
          wget -qO- https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

      - name: Get MongoDB URI
        id: get-mongodb-uri
        run: |
          MONGODB_URI=$(gcloud secrets versions access latest --secret="tamshai-prod-mongodb-uri")
          echo "::add-mask::$MONGODB_URI"
          echo "mongodb_uri=$MONGODB_URI" >> $GITHUB_OUTPUT

      - name: Verify Sales Database State (Before)
        id: verify-before
        run: |
          echo "=== Sales Database State (Before) ==="

          CUSTOMER_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').customers.countDocuments()" 2>/dev/null || echo "0")
          OPPORTUNITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').opportunities.countDocuments()" 2>/dev/null || echo "0")

          echo "[INFO] Customers: $CUSTOMER_COUNT"
          echo "[INFO] Opportunities: $OPPORTUNITY_COUNT"
          echo "customer_count=$CUSTOMER_COUNT" >> $GITHUB_OUTPUT
          echo "opportunity_count=$OPPORTUNITY_COUNT" >> $GITHUB_OUTPUT

      - name: Load Sales Sample Data
        run: |
          echo "=== Loading Sales Sample Data ==="

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would load sample-data/sales-data.js into tamshai_sales"
            echo "[DRY RUN] File size: $(wc -l < sample-data/sales-data.js) lines"
            exit 0
          fi

          # Load the data
          mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --file sample-data/sales-data.js

          echo "[OK] Sales data loaded successfully"

      - name: Verify Sales Database State (After)
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "=== Sales Database State (After) ==="

          CUSTOMER_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').customers.countDocuments()")
          OPPORTUNITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').opportunities.countDocuments()")
          ACTIVITY_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_sales').activities.countDocuments()")

          echo "[OK] Customers: $CUSTOMER_COUNT"
          echo "[OK] Opportunities: $OPPORTUNITY_COUNT"
          echo "[OK] Activities: $ACTIVITY_COUNT"

  # ===========================================================================
  # Load Support Data (MongoDB Atlas)
  # ===========================================================================
  load-support-data:
    name: Load Support Data
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.load_support == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install MongoDB Shell
        run: |
          wget -qO- https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

      - name: Get MongoDB URI
        id: get-mongodb-uri
        run: |
          MONGODB_URI=$(gcloud secrets versions access latest --secret="tamshai-prod-mongodb-uri")
          echo "::add-mask::$MONGODB_URI"
          echo "mongodb_uri=$MONGODB_URI" >> $GITHUB_OUTPUT

      - name: Verify Support Database State (Before)
        id: verify-before
        run: |
          echo "=== Support Database State (Before) ==="

          TICKET_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').tickets.countDocuments()" 2>/dev/null || echo "0")
          KB_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').articles.countDocuments()" 2>/dev/null || echo "0")

          echo "[INFO] Tickets: $TICKET_COUNT"
          echo "[INFO] KB Articles: $KB_COUNT"
          echo "ticket_count=$TICKET_COUNT" >> $GITHUB_OUTPUT
          echo "kb_count=$KB_COUNT" >> $GITHUB_OUTPUT

      - name: Load Support Sample Data
        run: |
          echo "=== Loading Support Sample Data ==="

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would load sample-data/support-data.js into tamshai_support"
            echo "[DRY RUN] File size: $(wc -l < sample-data/support-data.js) lines"
            exit 0
          fi

          # Load the data
          mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --file sample-data/support-data.js

          echo "[OK] Support data loaded successfully"

      - name: Verify Support Database State (After)
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "=== Support Database State (After) ==="

          TICKET_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').tickets.countDocuments()")
          KB_COUNT=$(mongosh "${{ steps.get-mongodb-uri.outputs.mongodb_uri }}" --quiet --eval \
            "db.getSiblingDB('tamshai_support').articles.countDocuments()")

          echo "[OK] Tickets: $TICKET_COUNT"
          echo "[OK] KB Articles: $KB_COUNT"

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Provisioning Summary
    runs-on: ubuntu-latest
    needs: [preflight, load-finance-data, load-sales-data, load-support-data]
    if: always()
    steps:
      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "PROVISIONING SUMMARY"
          echo "=============================================="
          echo "Data Set:            ${{ github.event.inputs.data_set }}"
          echo "Dry Run:             ${{ github.event.inputs.dry_run }}"
          echo ""
          echo "JOB RESULTS:"
          echo "  Load Finance Data: ${{ needs.load-finance-data.result }}"
          echo "  Load Sales Data:   ${{ needs.load-sales-data.result }}"
          echo "  Load Support Data: ${{ needs.load-support-data.result }}"
          echo "=============================================="

          # Write to job summary
          echo "## Provision Production Data Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Data Set | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Finance (Cloud SQL) | ${{ needs.load-finance-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sales (MongoDB) | ${{ needs.load-sales-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Support (MongoDB) | ${{ needs.load-support-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
