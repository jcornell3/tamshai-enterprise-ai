# Bootstrap VPS: Start All Services
name: Bootstrap VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      rebuild:
        description: 'Force rebuild all images'
        required: false
        type: boolean
        default: false
      fresh_start:
        description: 'Delete all data volumes (DESTRUCTIVE)'
        required: false
        type: boolean
        default: false
      pull_latest:
        description: 'Pull latest code before starting'
        required: false
        type: boolean
        default: true

concurrency:
  group: bootstrap-vps-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

permissions:
  contents: read
  deployments: write

jobs:
  bootstrap:
    name: Bootstrap VPS (${{ github.event.inputs.environment || 'staging' }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Check VPS connectivity
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Testing SSH connection..."
          ssh $VPS_USER@$VPS_HOST "echo 'SSH connection successful' && hostname && uptime"

      - name: Create .env file from GitHub secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          KEYCLOAK_DB_PASSWORD: ${{ secrets.KEYCLOAK_DB_PASSWORD }}
          TAMSHAI_DB_PASSWORD: ${{ secrets.TAMSHAI_DB_PASSWORD }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MCP_GATEWAY_CLIENT_SECRET: ${{ secrets.MCP_GATEWAY_CLIENT_SECRET }}
          MCP_HR_SERVICE_CLIENT_SECRET: ${{ secrets.MCP_HR_SERVICE_CLIENT_SECRET }}
          STAGE_TESTING_PASSWORD: ${{ secrets.STAGE_TESTING_PASSWORD }}
        run: |
          echo "Creating .env file on VPS..."
          ssh $VPS_USER@$VPS_HOST "cat > /opt/tamshai/.env << ENVEOF
          # Tamshai Enterprise AI - VPS Environment Configuration
          # Project name for docker compose
          COMPOSE_PROJECT_NAME=tamshai-vps
          # Keycloak settings
          KEYCLOAK_MODE=start
          KEYCLOAK_ADMIN=admin
          KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD
          KC_HOSTNAME=www.tamshai.com
          KC_HTTP_RELATIVE_PATH=/auth
          KEYCLOAK_URL=https://www.tamshai.com/auth
          KEYCLOAK_ISSUER=https://www.tamshai.com/auth/realms/tamshai-corp
          KEYCLOAK_INTERNAL_URL=http://keycloak:8080/auth
          # Caddyfile location (stage config with Cloudflare proxy support)
          CADDYFILE=./infrastructure/docker/Caddyfile.stage
          KONG_CONFIG=./infrastructure/kong/kong.vps.yml
          # API keys
          CLAUDE_API_KEY=$CLAUDE_API_KEY
          # Database passwords
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          KEYCLOAK_DB_PASSWORD=$KEYCLOAK_DB_PASSWORD
          TAMSHAI_DB_PASSWORD=$TAMSHAI_DB_PASSWORD
          MONGODB_PASSWORD=$MONGODB_PASSWORD
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
          # Client secrets
          MCP_GATEWAY_CLIENT_SECRET=$MCP_GATEWAY_CLIENT_SECRET
          MCP_HR_SERVICE_CLIENT_SECRET=$MCP_HR_SERVICE_CLIENT_SECRET
          # Keycloak realm (stage uses pre-seeded users with group assignments)
          KEYCLOAK_REALM=./keycloak/realm-export-stage.json
          # Web Apps (VITE_* are build-time variables for OAuth)
          VITE_KEYCLOAK_URL=https://www.tamshai.com/auth/realms/tamshai-corp
          VITE_KEYCLOAK_CLIENT_ID=web-portal
          VITE_MCP_GATEWAY_URL=https://www.tamshai.com/api
          # Stage Testing - Fixed password for synced users (NOT for production!)
          STAGE_TESTING_PASSWORD=$STAGE_TESTING_PASSWORD
          # Environment
          NODE_ENV=production
          LOG_LEVEL=info
          IMAGE_TAG=latest
          IMAGE_PREFIX=tamshai/
          ENVEOF"
          echo "Created .env file"

      - name: Bootstrap all services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          REBUILD: ${{ github.event.inputs.rebuild }}
          PULL_LATEST: ${{ github.event.inputs.pull_latest }}
          FRESH_START: ${{ github.event.inputs.fresh_start }}
        run: |
          echo "Starting bootstrap with PULL_LATEST=$PULL_LATEST, REBUILD=$REBUILD, FRESH_START=$FRESH_START"
          ssh $VPS_USER@$VPS_HOST "cd /opt/tamshai && \
            git config --global --add safe.directory /opt/tamshai && \
            if [ '$PULL_LATEST' = 'true' ]; then git fetch origin && git reset --hard origin/main; fi && \
            echo 'Stopping all tamshai containers...' && \
            docker ps -aq --filter 'name=tamshai' | xargs -r docker stop || true && \
            docker ps -aq --filter 'name=tamshai' | xargs -r docker rm -f || true && \
            docker compose down --remove-orphans || true && \
            if [ '$FRESH_START' = 'true' ]; then docker compose down -v || true; fi && \
            if [ '$REBUILD' = 'true' ]; then docker image prune -f && docker compose build --no-cache; fi && \
            docker compose up -d"

      - name: Wait for services
        run: |
          echo "Waiting 60 seconds for services to initialize..."
          sleep 60

      - name: Health check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Running health checks..."
          ssh $VPS_USER@$VPS_HOST "cd /opt/tamshai && \
            docker compose ps && \
            echo '' && \
            echo 'Health Checks:' && \
            docker exec tamshai-redis redis-cli ping && \
            docker exec tamshai-postgres pg_isready -U postgres && \
            docker exec tamshai-kong kong health && echo 'Kong: healthy' || echo 'Kong: not ready' && \
            docker exec tamshai-mcp-gateway wget -q -O- http://localhost:3100/health || echo 'MCP Gateway not ready'"

      - name: Verify MCP Gateway
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Waiting 30 seconds for services to stabilize..."
          sleep 30
          ssh $VPS_USER@$VPS_HOST "for i in 1 2 3 4 5 6 7 8 9 10; do \
            docker exec tamshai-mcp-gateway wget -q -O- http://localhost:3100/health 2>/dev/null | grep -q status && echo 'MCP Gateway healthy' && exit 0; \
            echo 'Attempt \$i - waiting...'; \
            sleep 5; \
            done; \
            echo 'MCP Gateway not responding'; \
            exit 1"

      - name: Bootstrap summary
        if: success()
        run: |
          echo "## VPS Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY

      - name: Bootstrap failed
        if: failure()
        run: |
          echo "## VPS Bootstrap Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
