# Bootstrap VPS: Start All Services
#
# This workflow starts ALL services on the VPS for:
#   - Initial deployment after Terraform provisioning
#   - Disaster recovery after VPS restart
#   - Manual service restart after maintenance
#
# Use Case:
#   Run this ONCE before using incremental deployment workflows.
#   Incremental workflows (deploy-mcp-*.yml) use --no-deps and assume
#   dependencies are already running.
#
# Services Started (12 total):
#   1. postgres (with sample data)
#   2. mongodb (with sample data)
#   3. elasticsearch
#   4. redis
#   5. keycloak (with realm import)
#   6. mcp-gateway
#   7. mcp-hr
#   8. mcp-finance
#   9. mcp-sales
#   10. mcp-support
#   11. tamshai-website
#   12. caddy (reverse proxy)
#
# Estimated Time: 5-10 minutes (first run with image builds)
#                 2-3 minutes (subsequent runs with cached images)

name: Bootstrap VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      rebuild:
        description: 'Force rebuild all images (--build flag)'
        required: false
        type: boolean
        default: false
      fresh_start:
        description: 'Delete all data volumes (DESTRUCTIVE - loses all data!)'
        required: false
        type: boolean
        default: false
      pull_latest:
        description: 'Pull latest code before starting'
        required: false
        type: boolean
        default: true

concurrency:
  group: bootstrap-vps-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}

permissions:
  contents: read
  deployments: write

jobs:
  bootstrap:
    name: Bootstrap VPS (${{ github.event.inputs.environment || 'staging' }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Check VPS connectivity
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Testing SSH connection..."
          ssh $VPS_USER@$VPS_HOST "echo 'SSH connection successful' && hostname && uptime"

      - name: Create .env file from GitHub secrets
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Creating .env file on VPS..."
          ssh $VPS_USER@$VPS_HOST "cat > /opt/tamshai/.env" << 'ENVFILE'
# Tamshai Enterprise AI - VPS Environment Configuration
# Auto-generated by GitHub Actions bootstrap workflow

# CLAUDE API (Required)
CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}

# KEYCLOAK
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
KC_HOSTNAME=${{ secrets.VPS_HOST }}
KC_HTTP_RELATIVE_PATH=/auth
KEYCLOAK_URL=http://keycloak:8080
KEYCLOAK_ISSUER=http://keycloak:8080/auth/realms/tamshai-corp

# DATABASE PASSWORDS
POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
KEYCLOAK_DB_PASSWORD=${{ secrets.KEYCLOAK_DB_PASSWORD }}
TAMSHAI_DB_PASSWORD=${{ secrets.TAMSHAI_DB_PASSWORD }}
MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }}

# MINIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}

# MCP GATEWAY
MCP_GATEWAY_CLIENT_SECRET=${{ secrets.MCP_GATEWAY_CLIENT_SECRET }}

# RUNTIME
LOG_LEVEL=info
IMAGE_TAG=latest
ENVFILE
          echo "‚úÖ .env file created"

      - name: Bootstrap all services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          REBUILD: ${{ github.event.inputs.rebuild }}
          PULL_LATEST: ${{ github.event.inputs.pull_latest }}
          FRESH_START: ${{ github.event.inputs.fresh_start }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          set -e  # Exit on error

          cd /opt/tamshai

          echo "=========================================="
          echo "üöÄ Bootstrap VPS - Starting All Services"
          echo "=========================================="
          echo ""

          # Fix git ownership check
          git config --global --add safe.directory /opt/tamshai

          # Pull latest code if requested
          if [ "$PULL_LATEST" = "true" ]; then
            echo "üì• Pulling latest code..."
            git pull origin main
            echo ""
          fi

          # Check if .env file exists
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è  Warning: .env file not found"
            echo "   Creating from .env.example..."
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "   ‚úÖ Created .env from .env.example"
              echo "   ‚ö†Ô∏è  Please update .env with production secrets!"
            else
              echo "   ‚ùå No .env.example found - services may fail to start"
            fi
            echo ""
          fi

          # Determine build flags
          BUILD_FLAG=""
          if [ "$REBUILD" = "true" ]; then
            BUILD_FLAG="--build"
            echo "üî® Force rebuild enabled"
          fi

          # Stop any running services first (clean state)
          echo "üõë Stopping any existing services..."
          docker compose -f docker-compose.vps.yml down --remove-orphans || true

          # Fresh start - delete all volumes (DESTRUCTIVE)
          if [ "$FRESH_START" = "true" ]; then
            echo "‚ö†Ô∏è  FRESH START: Deleting all data volumes..."
            docker compose -f docker-compose.vps.yml down -v || true
            echo "‚úÖ All volumes deleted"
          fi
          echo ""

          # Start all services
          echo "üöÄ Starting all services..."
          docker compose -f docker-compose.vps.yml up -d $BUILD_FLAG
          echo ""

          # Wait for services to initialize
          echo "‚è≥ Waiting for services to initialize (60 seconds)..."
          sleep 60
          echo ""

          # Show service status
          echo "üìä Service Status:"
          echo "=========================================="
          docker compose -f docker-compose.vps.yml ps
          echo ""

          # Health checks
          echo "üè• Health Checks:"
          echo "=========================================="

          # Redis
          if docker exec tamshai-redis redis-cli ping | grep -q PONG; then
            echo "‚úÖ Redis: healthy"
          else
            echo "‚ùå Redis: unhealthy"
          fi

          # PostgreSQL
          if docker exec tamshai-postgres pg_isready -U postgres > /dev/null 2>&1; then
            echo "‚úÖ PostgreSQL: healthy"
          else
            echo "‚ùå PostgreSQL: unhealthy"
          fi

          # MongoDB
          if docker exec tamshai-mongodb mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
            echo "‚úÖ MongoDB: healthy"
          else
            echo "‚ùå MongoDB: unhealthy"
          fi

          # Elasticsearch
          if curl -sf http://localhost:9200/_cluster/health > /dev/null 2>&1; then
            echo "‚úÖ Elasticsearch: healthy"
          else
            echo "‚è≥ Elasticsearch: still initializing (may take 2-3 minutes)"
          fi

          # Keycloak
          if docker exec tamshai-keycloak bash -c 'exec 3<>/dev/tcp/localhost/8080' 2>/dev/null; then
            echo "‚úÖ Keycloak: healthy"
          else
            echo "‚è≥ Keycloak: still initializing (may take 1-2 minutes)"
          fi

          # MCP Gateway (use docker exec - ports not exposed to host)
          if docker exec tamshai-mcp-gateway wget -q -O- http://localhost:3100/health 2>/dev/null | grep -q '"status"'; then
            echo "‚úÖ MCP Gateway: healthy"
          else
            echo "‚è≥ MCP Gateway: waiting for dependencies"
          fi

          # MCP HR
          if docker exec tamshai-mcp-hr wget -q -O- http://localhost:3101/health 2>/dev/null | grep -q '"status"'; then
            echo "‚úÖ MCP HR: healthy"
          else
            echo "‚è≥ MCP HR: waiting for dependencies"
          fi

          # MCP Finance
          if docker exec tamshai-mcp-finance wget -q -O- http://localhost:3102/health 2>/dev/null | grep -q '"status"'; then
            echo "‚úÖ MCP Finance: healthy"
          else
            echo "‚è≥ MCP Finance: waiting for dependencies"
          fi

          # MCP Sales
          if docker exec tamshai-mcp-sales wget -q -O- http://localhost:3103/health 2>/dev/null | grep -q '"status"'; then
            echo "‚úÖ MCP Sales: healthy"
          else
            echo "‚è≥ MCP Sales: waiting for dependencies"
          fi

          # MCP Support
          if docker exec tamshai-mcp-support wget -q -O- http://localhost:3104/health 2>/dev/null | grep -q '"status"'; then
            echo "‚úÖ MCP Support: healthy"
          else
            echo "‚è≥ MCP Support: waiting for dependencies"
          fi

          echo ""
          echo "=========================================="
          echo "‚úÖ Bootstrap complete!"
          echo ""
          echo "Next steps:"
          echo "  1. Wait 2-3 minutes for all services to fully initialize"
          echo "  2. Run incremental deployment workflows as needed"
          echo "  3. Test via: curl https://<domain>/api/health"
          echo "=========================================="
          EOF

      - name: Verify critical services
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Waiting 30 seconds for services to stabilize..."
          sleep 30

          ssh $VPS_USER@$VPS_HOST << 'EOF'
          cd /opt/tamshai

          echo "Final health check verification..."

          # Check MCP Gateway (critical path) - use docker exec since ports not exposed
          RETRIES=10
          for i in $(seq 1 $RETRIES); do
            if docker exec tamshai-mcp-gateway wget -q -O- http://localhost:3100/health 2>/dev/null | grep -q '"status"'; then
              echo "‚úÖ MCP Gateway verified healthy"
              exit 0
            fi
            echo "Attempt $i/$RETRIES - waiting..."
            sleep 5
          done

          echo "‚ö†Ô∏è MCP Gateway not responding after $RETRIES attempts"
          echo "Check logs with: docker compose -f docker-compose.vps.yml logs mcp-gateway"
          exit 1
          EOF

      - name: Bootstrap summary
        if: success()
        run: |
          echo "## ‚úÖ VPS Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rebuild**: ${{ github.event.inputs.rebuild }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Latest**: ${{ github.event.inputs.pull_latest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Started" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL (with sample data)" >> $GITHUB_STEP_SUMMARY
          echo "- MongoDB (with sample data)" >> $GITHUB_STEP_SUMMARY
          echo "- Elasticsearch" >> $GITHUB_STEP_SUMMARY
          echo "- Redis" >> $GITHUB_STEP_SUMMARY
          echo "- Keycloak" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Gateway" >> $GITHUB_STEP_SUMMARY
          echo "- MCP HR" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Finance" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Sales" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Support" >> $GITHUB_STEP_SUMMARY
          echo "- Tamshai Website" >> $GITHUB_STEP_SUMMARY
          echo "- Caddy (reverse proxy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test API: \`curl https://<domain>/api/health\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Use incremental workflows for future deployments" >> $GITHUB_STEP_SUMMARY

      - name: Bootstrap failed
        if: failure()
        run: |
          echo "## ‚ùå VPS Bootstrap Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH to VPS: \`ssh root@<VPS_IP>\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check logs: \`docker compose -f docker-compose.vps.yml logs\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check .env file exists and has required secrets" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify disk space: \`df -h\`" >> $GITHUB_STEP_SUMMARY
# Workflow refresh Thu, Jan  1, 2026 12:58:45 PM
