# =============================================================================
# Keycloak Secret Rotation Workflow (H4 - Automated Secret Rotation)
# =============================================================================
#
# Rotates Keycloak client secrets on a monthly schedule and triggers deployment.
# This workflow automates the H4 security hardening requirement for regular
# secret rotation.
#
# Schedule: 1st of every month at 3:00 AM UTC
#
# Rotated Clients:
#   - mcp-gateway (MCP_GATEWAY_CLIENT_SECRET)
#   - mcp-hr-service (MCP_HR_SERVICE_CLIENT_SECRET)
#   - mcp-ui (MCP_UI_CLIENT_SECRET)
#   - mcp-integration-runner (MCP_INTEGRATION_RUNNER_SECRET)
#
# =============================================================================

name: Secret Rotation (H4)

on:
  schedule:
    # Run on the 1st of every month at 3:00 AM UTC
    - cron: '0 3 1 * *'
  workflow_dispatch:
    inputs:
      client:
        description: 'Specific client to rotate (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode - show what would be rotated without making changes'
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        type: choice
        options:
          - stage
          - dev
        default: stage

env:
  REPO: jcornell3/tamshai-enterprise-ai

jobs:
  rotate-keycloak-secrets:
    name: Rotate Keycloak Secrets
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH for VPS access
        if: ${{ inputs.environment == 'stage' || github.event.schedule }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Determine environment and flags
        id: config
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" = "schedule" ]; then
            ENV="stage"
          else
            ENV="${{ inputs.environment || 'stage' }}"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Determine dry-run flag
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "dry_run_flag=--dry-run" >> $GITHUB_OUTPUT
          else
            echo "dry_run_flag=" >> $GITHUB_OUTPUT
          fi

          # Determine client flag
          if [ -n "${{ inputs.client }}" ]; then
            echo "client_flag=--client ${{ inputs.client }}" >> $GITHUB_OUTPUT
          else
            echo "client_flag=" >> $GITHUB_OUTPUT
          fi

      - name: Rotate secrets on Stage VPS
        if: steps.config.outputs.environment == 'stage'
        env:
          KEYCLOAK_VPS_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_VPS_ADMIN_PASSWORD }}
        run: |
          echo "=== Rotating Keycloak secrets on Stage VPS ==="

          # Upload rotation script
          scp -i ~/.ssh/id_ed25519 scripts/secrets/rotate-keycloak-secrets.sh \
            ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }}:/tmp/

          # Execute rotation via SSH
          # Note: Pass --yes to auto-confirm (non-interactive)
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }} \
            "chmod +x /tmp/rotate-keycloak-secrets.sh && \
             KEYCLOAK_VPS_ADMIN_PASSWORD='$KEYCLOAK_VPS_ADMIN_PASSWORD' \
             /tmp/rotate-keycloak-secrets.sh \
               --env stage \
               --yes \
               ${{ steps.config.outputs.dry_run_flag }} \
               ${{ steps.config.outputs.client_flag }}"

          # Cleanup
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }} \
            "rm -f /tmp/rotate-keycloak-secrets.sh"

      - name: Rotate secrets on Dev (local)
        if: steps.config.outputs.environment == 'dev'
        env:
          KEYCLOAK_DEV_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_DEV_ADMIN_PASSWORD }}
        run: |
          # Use default password if secret not set
          export KEYCLOAK_DEV_ADMIN_PASSWORD="${KEYCLOAK_DEV_ADMIN_PASSWORD:-admin}"

          echo "=== Rotating Keycloak secrets on Dev ==="
          echo "Note: Dev rotation requires local Keycloak to be running"

          # For dev, we run locally (this typically fails in CI without Keycloak)
          chmod +x scripts/secrets/rotate-keycloak-secrets.sh

          ./scripts/secrets/rotate-keycloak-secrets.sh \
            --env dev \
            --yes \
            ${{ steps.config.outputs.dry_run_flag }} \
            ${{ steps.config.outputs.client_flag }}

  trigger-deployment:
    name: Trigger Deployment
    needs: rotate-keycloak-secrets
    if: ${{ !inputs.dry_run && github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Trigger VPS deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.JCORNELL_GH_TOKEN }}
          script: |
            console.log('Triggering deploy-vps.yml workflow...');

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-vps.yml',
              ref: 'main'
            });

            console.log('Deployment triggered successfully');

  notify:
    name: Send Notification
    needs: [rotate-keycloak-secrets, trigger-deployment]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.rotate-keycloak-secrets.result }}" = "success" ]; then
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "emoji=\ud83d\udd0d" >> $GITHUB_OUTPUT
              echo "status=Dry Run Complete" >> $GITHUB_OUTPUT
            else
              echo "emoji=\u2705" >> $GITHUB_OUTPUT
              echo "status=Success" >> $GITHUB_OUTPUT
            fi
          else
            echo "emoji=\u274c" >> $GITHUB_OUTPUT
            echo "status=Failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Skip if webhook URL not configured
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi

          EMOJI="${{ steps.status.outputs.emoji }}"
          STATUS="${{ steps.status.outputs.status }}"
          ENV="${{ github.event.inputs.environment || 'stage' }}"
          TRIGGER="${{ github.event_name == 'schedule' && 'Scheduled (monthly)' || 'Manual' }}"

          # Build message
          MESSAGE="$EMOJI **Secret Rotation: $STATUS**\n\n"
          MESSAGE+="- Environment: $ENV\n"
          MESSAGE+="- Trigger: $TRIGGER\n"
          MESSAGE+="- Workflow: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Send to Discord
          curl -sf -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$MESSAGE\"}" || true
