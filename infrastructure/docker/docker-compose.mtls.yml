# =============================================================================
# Docker Compose mTLS Overlay for Tamshai Enterprise AI
# =============================================================================
#
# This overlay file adds mutual TLS (mTLS) configuration to internal services.
#
# Usage:
#   1. Generate certificates: ./scripts/generate-mtls-certs.sh
#   2. Start with mTLS: docker compose -f docker-compose.yml -f docker-compose.mtls.yml up -d
#
# Prerequisites:
#   - Run generate-mtls-certs.sh to create certificates in ./certs/
#   - Ensure certs/ directory is NOT committed to git
#
# =============================================================================

services:
  # ===========================================================================
  # MCP Gateway with mTLS (Client Mode - connects to MCP servers)
  # ===========================================================================
  mcp-gateway:
    environment:
      # Enable TLS for outbound connections to MCP servers
      MCP_TLS_ENABLED: "true"
      MCP_CA_CERT: /certs/ca.crt
      MCP_CLIENT_CERT: /certs/mcp-gateway.crt
      MCP_CLIENT_KEY: /certs/mcp-gateway.key
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
      # Update MCP server URLs to use HTTPS
      MCP_HR_URL: https://mcp-hr:3101
      MCP_FINANCE_URL: https://mcp-finance:3102
      MCP_SALES_URL: https://mcp-sales:3103
      MCP_SUPPORT_URL: https://mcp-support:3104
      MCP_PAYROLL_URL: https://mcp-payroll:3106
      MCP_TAX_URL: https://mcp-tax:3107
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-gateway.crt:/certs/mcp-gateway.crt:ro
      - ./certs/mcp-gateway.key:/certs/mcp-gateway.key:ro

  # ===========================================================================
  # MCP HR Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-hr:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-hr.crt
      MCP_SERVER_KEY: /certs/mcp-hr.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-hr.crt:/certs/mcp-hr.crt:ro
      - ./certs/mcp-hr.key:/certs/mcp-hr.key:ro

  # ===========================================================================
  # MCP Finance Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-finance:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-finance.crt
      MCP_SERVER_KEY: /certs/mcp-finance.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-finance.crt:/certs/mcp-finance.crt:ro
      - ./certs/mcp-finance.key:/certs/mcp-finance.key:ro

  # ===========================================================================
  # MCP Sales Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-sales:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-sales.crt
      MCP_SERVER_KEY: /certs/mcp-sales.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-sales.crt:/certs/mcp-sales.crt:ro
      - ./certs/mcp-sales.key:/certs/mcp-sales.key:ro

  # ===========================================================================
  # MCP Support Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-support:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-support.crt
      MCP_SERVER_KEY: /certs/mcp-support.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-support.crt:/certs/mcp-support.crt:ro
      - ./certs/mcp-support.key:/certs/mcp-support.key:ro

  # ===========================================================================
  # MCP Payroll Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-payroll:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-payroll.crt
      MCP_SERVER_KEY: /certs/mcp-payroll.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-payroll.crt:/certs/mcp-payroll.crt:ro
      - ./certs/mcp-payroll.key:/certs/mcp-payroll.key:ro

  # ===========================================================================
  # MCP Tax Server with mTLS (Server Mode)
  # ===========================================================================
  mcp-tax:
    environment:
      MCP_TLS_ENABLED: "true"
      MCP_SERVER_CERT: /certs/mcp-tax.crt
      MCP_SERVER_KEY: /certs/mcp-tax.key
      MCP_CA_CERT: /certs/ca.crt
      MCP_TLS_REJECT_UNAUTHORIZED: "true"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mcp-tax.crt:/certs/mcp-tax.crt:ro
      - ./certs/mcp-tax.key:/certs/mcp-tax.key:ro

  # ===========================================================================
  # PostgreSQL with TLS
  # ===========================================================================
  postgres:
    command:
      - "postgres"
      - "-c"
      - "ssl=on"
      - "-c"
      - "ssl_cert_file=/certs/postgres.crt"
      - "-c"
      - "ssl_key_file=/certs/postgres.key"
      - "-c"
      - "ssl_ca_file=/certs/ca.crt"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/postgres.crt:/certs/postgres.crt:ro
      - ./certs/postgres.key:/certs/postgres.key:ro

  # ===========================================================================
  # Redis with TLS
  # ===========================================================================
  redis:
    command:
      - "redis-server"
      - "--tls-port"
      - "6379"
      - "--port"
      - "0"
      - "--tls-cert-file"
      - "/certs/redis.crt"
      - "--tls-key-file"
      - "/certs/redis.key"
      - "--tls-ca-cert-file"
      - "/certs/ca.crt"
      - "--tls-auth-clients"
      - "yes"
      - "--requirepass"
      - "${REDIS_PASSWORD:-redis123}"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/redis.crt:/certs/redis.crt:ro
      - ./certs/redis.key:/certs/redis.key:ro

  # ===========================================================================
  # MongoDB with TLS
  # ===========================================================================
  mongodb:
    command:
      - "mongod"
      - "--tlsMode"
      - "requireTLS"
      - "--tlsCertificateKeyFile"
      - "/certs/mongodb.pem"
      - "--tlsCAFile"
      - "/certs/ca.crt"
      - "--bind_ip_all"
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/mongodb.pem:/certs/mongodb.pem:ro

  # ===========================================================================
  # Keycloak with TLS (for internal service communication)
  # ===========================================================================
  keycloak:
    environment:
      KC_HTTPS_CERTIFICATE_FILE: /certs/keycloak.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /certs/keycloak.key
      KC_HTTPS_TRUST_STORE_FILE: /certs/ca.crt
    volumes:
      - ./certs/ca.crt:/certs/ca.crt:ro
      - ./certs/keycloak.crt:/certs/keycloak.crt:ro
      - ./certs/keycloak.key:/certs/keycloak.key:ro

# =============================================================================
# Notes:
# =============================================================================
#
# 1. Certificate Rotation:
#    - Service certificates should be rotated annually
#    - Run generate-mtls-certs.sh --force to regenerate all certs
#    - Restart services after rotation: docker compose restart
#
# 2. Production Considerations:
#    - Use a proper PKI or HashiCorp Vault for certificate management
#    - Implement automated certificate rotation
#    - Monitor certificate expiration with alerting
#
# 3. Troubleshooting:
#    - Check certificate validity: openssl x509 -in cert.crt -text -noout
#    - Test TLS connection: openssl s_client -connect host:port -CAfile ca.crt
#    - View container logs: docker compose logs <service>
#
# =============================================================================
