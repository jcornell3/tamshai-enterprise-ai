# Kong Gateway Declarative Configuration
# Tamshai Corp Enterprise AI

_format_version: "3.0"
_transform: true

# =============================================================================
# SERVICES
# =============================================================================
services:
  # MCP Gateway Service
  - name: mcp-gateway-service
    url: http://mcp-gateway:3100
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Keycloak Service (for token introspection)
  - name: keycloak-service
    url: http://keycloak:8080
    connect_timeout: 10000
    write_timeout: 10000
    read_timeout: 10000

# =============================================================================
# ROUTES
# =============================================================================
routes:
  # SSE Query Endpoint (v1.4 - Section 6.1)
  # GET /api/query?q=...&token=... for streaming AI responses
  - name: sse-query-route
    service: mcp-gateway-service
    paths:
      - /api/query
    methods:
      - GET
      - OPTIONS
    strip_path: false
    preserve_host: true

  # AI Query Endpoints (protected) - POST version
  - name: ai-query-route
    service: mcp-gateway-service
    paths:
      - /api/ai
    methods:
      - POST
      - OPTIONS
    strip_path: false
    preserve_host: true

  # Confirmation Endpoint (v1.4 - Section 5.6)
  # POST /api/confirm/:id for human-in-the-loop approvals
  - name: confirm-route
    service: mcp-gateway-service
    paths:
      - ~/api/confirm/.*
    methods:
      - POST
      - OPTIONS
    strip_path: false
    preserve_host: true

  # Health Check (unprotected)
  - name: health-route
    service: mcp-gateway-service
    paths:
      - /api/health
      - /health
    methods:
      - GET
    strip_path: false

  # MCP Tool Proxy Endpoints (protected) - v1.4
  # Matches all /api/mcp/* paths including /api/mcp/tools and /api/mcp/:server/:tool
  - name: mcp-tool-proxy-route
    service: mcp-gateway-service
    paths:
      - ~/api/mcp/.*
    methods:
      - GET
      - POST
      - OPTIONS
    strip_path: false
    preserve_host: true

  # User Info (protected)
  - name: user-info-route
    service: mcp-gateway-service
    paths:
      - /api/user
    methods:
      - GET
    strip_path: false

# =============================================================================
# PLUGINS
# =============================================================================
plugins:
  # CORS - Allow cross-origin requests from desktop/mobile clients and web apps
  - name: cors
    config:
      origins:
        - http://localhost:3100
        - http://localhost:4000
        - http://localhost:4001
        - http://localhost:4002
        - tamshai-ai://*
        - com.tamshai.ai://*
      methods:
        - GET
        - POST
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600

  # Rate Limiting - Per user
  - name: rate-limiting
    route: ai-query-route
    config:
      minute: 60
      hour: 500
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      redis_ssl: false

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  # Response Transformer - Add security headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Referrer-Policy: strict-origin-when-cross-origin"

  # HTTP Log - Audit logging
  - name: http-log
    route: ai-query-route
    config:
      http_endpoint: http://mcp-gateway:3000/internal/audit
      method: POST
      timeout: 10000
      keepalive: 60000
      flush_timeout: 2
      retry_count: 3
      content_type: application/json
      custom_fields_by_lua:
        user_id: "return kong.request.get_header('X-User-ID') or 'anonymous'"

  # Request Termination - REMOVED
  # The global request-termination plugin was causing all routes to return 404
  # Kong naturally returns 404 for unmatched routes without this plugin

# =============================================================================
# CONSUMERS (for future API key support)
# =============================================================================
consumers:
  - username: mcp-gateway-internal
    custom_id: mcp-gateway-service-account

# =============================================================================
# UPSTREAMS (for load balancing in production)
# =============================================================================
upstreams:
  - name: mcp-gateway-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 3
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
    targets:
      - target: mcp-gateway:3100
        weight: 100
