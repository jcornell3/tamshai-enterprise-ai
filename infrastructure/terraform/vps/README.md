# Tamshai Enterprise AI - VPS Deployment

Automated VPS deployment with no manual SSH login required.

## Overview

This Terraform configuration provisions a single VPS with:
- Docker and Docker Compose
- All Tamshai services (Keycloak, MCP Gateway, databases)
- Caddy reverse proxy with automatic Let's Encrypt TLS
- **Path-based routing** (single domain, no subdomains required)
- Automatic secret generation
- GitHub Actions CI/CD integration

## Supported Cloud Providers

- **DigitalOcean** (default) - $24-48/month
- **Hetzner Cloud** - $5-18/month (more cost-effective)

## Prerequisites

1. **Terraform** (v1.5+): [Install guide](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)
2. **Cloud provider account** with API token:
   - DigitalOcean: https://cloud.digitalocean.com/account/api/tokens
   - Hetzner: https://console.hetzner.cloud/ (project > API Tokens)
3. **Domain name** with DNS access
4. **Claude API key**: https://console.anthropic.com/settings/keys

## Quick Start

### 1. Configure Variables

```bash
cd infrastructure/terraform/vps
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars`:

```hcl
# Cloud Provider
cloud_provider = "digitalocean"  # or "hetzner"
do_token = "dop_v1_your_token_here"

# Required
domain = "tamshai.yourdomain.com"
email = "admin@yourdomain.com"
claude_api_key = "sk-ant-api03-..."

# Optional
region = "nyc1"  # DO: nyc1, sfo3, ams3 | Hetzner: nbg1, fsn1, ash
vps_size = "s-4vcpu-8gb"  # 8GB recommended
environment = "staging"
```

### 2. Deploy

```bash
terraform init
terraform plan
terraform apply
```

### 3. Configure DNS

After deployment, Terraform outputs the required DNS record:

```
Create this DNS record pointing to <VPS_IP>:

Type  Name                 Value
A     vps.tamshai.com      <VPS_IP>
```

That's it - just one A record. All services use path-based routing:
- `vps.tamshai.com/` - Main portal
- `vps.tamshai.com/auth` - Keycloak
- `vps.tamshai.com/api` - MCP Gateway
- `vps.tamshai.com/hr` - HR App
- `vps.tamshai.com/finance` - Finance App
- `vps.tamshai.com/sales` - Sales App
- `vps.tamshai.com/support` - Support App

### 4. Wait for Initialization

The VPS takes 5-10 minutes to fully initialize (Docker install, service startup).

Check status:
```bash
# From local machine
./scripts/deploy-vps.sh --status
```

## Remote Updates (No SSH Required)

### Option 1: GitHub Actions (Recommended)

Configure these GitHub Secrets in your repository:

| Secret | Description | How to Get |
|--------|-------------|------------|
| `VPS_HOST` | VPS IP address | Terraform output: `vps_ip` |
| `VPS_SSH_KEY` | Deploy private key | Contents of `.keys/deploy_key` |
| `VPS_SSH_USER` | SSH username | `root` (default) |

Then deployments happen automatically:
- Push to `main` branch triggers deployment
- Manual trigger: Actions > Deploy to VPS > Run workflow

### Option 2: Local Script

If you enabled SSH access (`allowed_ssh_ips` is set):

```bash
# Deploy latest code
./scripts/deploy-vps.sh

# Rebuild containers
./scripts/deploy-vps.sh --build

# Deploy specific branch
./scripts/deploy-vps.sh --branch feature-branch

# Check status only
./scripts/deploy-vps.sh --status
```

## Architecture

```
                Internet
                    |
            [Caddy Reverse Proxy]
             ports 80, 443 (TLS)
             path-based routing
                    |
        +-----------+-----------+
        |           |           |
   [Keycloak]  [MCP Gateway]  [Web Apps]
    /auth        /api         /hr /finance...
        |           |           |
        +-----------+-----------+
                    |
            [Internal Network]
                    |
    +-------+-------+-------+-------+
    |       |       |       |       |
[Postgres] [MongoDB] [ES] [Redis] [MinIO]
  (no external ports - internal only)
```

## Security Features

- **TLS**: Automatic Let's Encrypt certificates via Caddy
- **Firewall**: Only ports 80, 443 exposed (SSH optional)
- **No exposed databases**: All databases internal-only
- **Generated secrets**: All passwords auto-generated by Terraform
- **fail2ban**: SSH brute-force protection
- **No manual login**: All updates via CI/CD

## Terraform Outputs

| Output | Description |
|--------|-------------|
| `vps_ip` | VPS public IP address |
| `app_url` | Main application URL |
| `keycloak_url` | Keycloak admin URL |
| `api_url` | MCP Gateway API URL |
| `keycloak_admin_password` | Generated Keycloak admin password |
| `deploy_command` | Local deploy script path |
| `emergency_ssh` | SSH command (if enabled) |
| `dns_records` | Required DNS records |

View outputs:
```bash
terraform output
terraform output keycloak_admin_password  # Reveal sensitive
```

## Troubleshooting

### Check cloud-init logs

If SSH is enabled:
```bash
ssh -i .keys/deploy_key root@<VPS_IP>
cat /var/log/cloud-init-output.log
```

Otherwise, use cloud provider console:
- DigitalOcean: Droplet > Console
- Hetzner: Server > Console

### Service not responding

1. Check cloud-init completed:
   ```
   # Should show "Tamshai VPS setup complete"
   tail /var/log/cloud-init-output.log
   ```

2. Check Docker services:
   ```
   docker compose -f /opt/tamshai/docker-compose.vps.yml ps
   docker compose -f /opt/tamshai/docker-compose.vps.yml logs
   ```

3. Check Caddy (reverse proxy):
   ```
   docker logs tamshai-caddy
   ```

### DNS not resolving

- DNS propagation can take up to 48 hours
- Verify with: `dig +short auth.yourdomain.com`
- Use IP directly for testing: Add to `/etc/hosts`

### TLS certificate errors

Caddy obtains certificates automatically. If failing:
1. Ensure DNS is properly configured
2. Check Caddy logs: `docker logs tamshai-caddy`
3. Verify domain in Caddyfile matches DNS

## Cost Estimates

| Provider | Size | Monthly Cost |
|----------|------|--------------|
| DigitalOcean | s-2vcpu-4gb | ~$24 |
| DigitalOcean | s-4vcpu-8gb | ~$48 |
| Hetzner | CX21 (4GB) | ~$5 |
| Hetzner | CX31 (8GB) | ~$10 |
| Hetzner | CX41 (16GB) | ~$18 |

Recommendation: Start with Hetzner CX31 for staging (~$10/month).

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

This removes:
- VPS instance
- SSH keys
- Firewall rules
- Local key files

**Warning**: This is irreversible. All data on the VPS will be lost.

## Files

```
infrastructure/terraform/vps/
├── main.tf                    # Terraform configuration
├── cloud-init.yaml            # VPS bootstrap script
├── terraform.tfvars.example   # Example variables
├── README.md                  # This file
└── .keys/                     # Generated SSH keys (gitignored)
    ├── deploy_key             # Private key
    └── deploy_key.pub         # Public key

docker-compose.vps.yml         # Production compose file
scripts/deploy-vps.sh          # Local deployment script
.github/workflows/deploy-vps.yml  # CI/CD workflow
```
