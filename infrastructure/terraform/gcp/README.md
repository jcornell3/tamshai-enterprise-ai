# GCP Phase 1 Production Deployment

This directory contains Terraform configuration for deploying Tamshai Enterprise AI to Google Cloud Platform using **Cloud Run** (serverless architecture).

## Architecture Overview

**Phase 1: Cost-Optimized Production (~$50-80/month)**

- **Compute**: Cloud Run (scale to zero)
  - MCP Gateway, MCP Suite (HR, Finance, Sales, Support), Keycloak
- **Database**: Cloud SQL PostgreSQL (db-f1-micro, zonal)
- **MongoDB**: MongoDB Atlas M0 (Free Tier)
- **Redis**: Utility VM (e2-micro)
- **Storage**: Cloud Storage for static website and documents
- **Networking**: VPC with Serverless VPC Connector

See full specification: `docs/plans/GCP_PROD_PHASE_1_COST_SENSITIVE.md`

## Prerequisites

### 1. GCP Project Setup

```bash
# Set your project ID
export PROJECT_ID="your-gcp-project-id"

# Enable required APIs
gcloud services enable cloudrun.googleapis.com --project=$PROJECT_ID
gcloud services enable sqladmin.googleapis.com --project=$PROJECT_ID
gcloud services enable secretmanager.googleapis.com --project=$PROJECT_ID
gcloud services enable compute.googleapis.com --project=$PROJECT_ID
gcloud services enable artifactregistry.googleapis.com --project=$PROJECT_ID
gcloud services enable vpcaccess.googleapis.com --project=$PROJECT_ID
```

### 2. Service Account Setup

Option A: Use existing service account (recommended if already created):

```bash
# Service account already exists with required roles
# Key stored in GitHub secret: GCP_SA_KEY_PROD
```

Option B: Create new service account:

```bash
# See: docs/plans/GCP_PROD_PHASE_1_COST_SENSITIVE.md#appendix-b-gcp-service-account-setup
```

### 3. MongoDB Atlas Setup

Follow instructions in: `docs/plans/GCP_PROD_PHASE_1_COST_SENSITIVE.md#appendix-a-mongodb-atlas-m0-setup`

Or use self-hosted MongoDB on Utility VM (optional).

### 4. Terraform Cloud Setup

```bash
# Login to Terraform Cloud
terraform login

# Workspace: tamshai-gcp-prod (should already exist)
```

## Configuration

### 1. Create terraform.tfvars

```bash
# Copy example file
cp terraform.tfvars.example terraform.tfvars

# Edit with your values
# IMPORTANT: Never commit terraform.tfvars (it contains secrets)
```

### 2. Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `project_id` | GCP Project ID | `tamshai-prod-123456` |
| `region` | GCP Region | `us-central1` |
| `mongodb_atlas_uri` | MongoDB connection string | `mongodb+srv://...` |
| `keycloak_domain` | Keycloak domain | `auth.tamshai.com` |
| `static_website_domain` | Website domain | `prod.tamshai.com` |

See `terraform.tfvars.example` for complete list.

### 3. GCP Secrets Manager

Before deploying, create these secrets in GCP Secret Manager:

```bash
# Claude API Key
echo -n "sk-ant-api03-YOUR_KEY" | gcloud secrets create claude-api-key \
  --data-file=- --replication-policy="automatic"

# Keycloak Admin User
echo -n "admin" | gcloud secrets create keycloak-admin-user \
  --data-file=- --replication-policy="automatic"

# Keycloak Admin Password
echo -n "YOUR_STRONG_PASSWORD" | gcloud secrets create keycloak-admin-password \
  --data-file=- --replication-policy="automatic"

# Keycloak DB Password (auto-generated by Terraform security module)
# This will be created automatically during deployment
```

## Deployment

### 1. Initialize Terraform

```bash
cd infrastructure/terraform/gcp
terraform init
```

### 2. Plan Deployment

```bash
terraform plan
```

Review the plan carefully. Expected resources:
- VPC network and subnet
- Serverless VPC Connector
- Cloud SQL PostgreSQL instance
- Utility VM (e2-micro) for Redis
- Cloud Run services (6 services)
- GCS buckets (logs, docs, static website)
- IAM bindings and service accounts

### 3. Apply Deployment

```bash
terraform apply
```

This will take approximately 10-15 minutes.

### 4. Configure DNS

After deployment, configure DNS records (see `dns_records` output):

```bash
# Get DNS records to configure
terraform output dns_records
```

Add CNAME records in your DNS provider (Cloudflare):

| Name | Type | Value |
|------|------|-------|
| `api.tamshai.com` | CNAME | `<mcp-gateway-url>` |
| `auth.tamshai.com` | CNAME | `<keycloak-url>` |
| `prod.tamshai.com` | CNAME | `c.storage.googleapis.com` |

### 5. Deploy Docker Images

Use GitHub Actions workflow to build and push images:

```bash
# Trigger deployment workflow
gh workflow run deploy-to-gcp.yml --ref main
```

Or manually:

```bash
# Get Artifact Registry URL
AR_URL=$(terraform output -raw artifact_registry_url)

# Build and push images
docker build -t $AR_URL/mcp-gateway:latest services/mcp-gateway
docker push $AR_URL/mcp-gateway:latest

# Repeat for other services...
```

### 6. Sync Keycloak Configuration

```bash
# SSH into Utility VM (bastion)
UTILITY_VM_IP=$(terraform output -raw utility_vm_public_ip)
gcloud compute ssh utility-vm --zone=us-central1-a

# Copy and run Keycloak sync script
# (See CLAUDE.md for detailed instructions)
```

### 7. Upload Static Website

```bash
# Get bucket name
BUCKET=$(terraform output -raw static_website_bucket_name)

# Build web apps
cd clients/web
npm ci
npm run build

# Upload to GCS
gsutil -m rsync -r -d dist gs://$BUCKET
gsutil web set -m index.html -e 404.html gs://$BUCKET
```

## Outputs

After successful deployment:

```bash
# View all outputs
terraform output

# View deployment summary
terraform output deployment_summary

# View service URLs
terraform output mcp_gateway_url
terraform output keycloak_url
terraform output static_website_url
```

## Cost Management

### Estimated Monthly Cost: $50-80

| Service | Cost | Notes |
|---------|------|-------|
| Cloud Run (6 services) | $5-15 | Scale to zero |
| Cloud SQL (db-f1-micro) | $10-15 | Zonal, shared core |
| Utility VM (e2-micro) | $0-7 | Free tier eligible |
| Secret Manager | $1-2 | ~1000 accesses/month |
| Cloud Storage | $1-2 | Static website, docs |
| Networking | $5-10 | Egress, VPC connector |

### Cost Optimization Tips

1. **Scale to Zero**: Keep `keycloak_min_instances = "0"` (saves ~$25/mo)
2. **Free Tier VM**: Utility VM is e2-micro (eligible for free tier)
3. **MongoDB Free**: Use Atlas M0 instead of self-hosted
4. **Shared Core DB**: Use db-f1-micro (not dedicated CPU)

### Monitoring Costs

```bash
# View current month's costs
gcloud billing projects describe $PROJECT_ID \
  --format="table(billingAccountName, billingEnabled)"
```

## Troubleshooting

### Cloud Run Cold Starts

If Keycloak cold starts (~30s) are unacceptable:

```bash
# Set keycloak_min_instances = "1" in terraform.tfvars
# This adds ~$25/month but eliminates cold starts
terraform apply -var="keycloak_min_instances=1"
```

### Database Connection Issues

```bash
# Verify Cloud SQL instance is running
gcloud sql instances list

# Check Serverless VPC Connector status
gcloud compute networks vpc-access connectors list --region=us-central1
```

### Cloud Run Logs

```bash
# View MCP Gateway logs
gcloud run services logs read mcp-gateway --region=us-central1 --limit=50

# View Keycloak logs
gcloud run services logs read keycloak --region=us-central1 --limit=50
```

## Upgrade to Phase 2

To upgrade to High Availability (Phase 2):

See: `docs/plans/GCP_PROD_PHASE_2_HIGH_AVAILABILITY.md`

## Security

- All secrets stored in Secret Manager
- Database uses private IP only (no public access)
- Cloud Run services use service accounts (least privilege)
- VPC connector for private resource access
- Terraform state encrypted in Terraform Cloud

## Documentation

- [Phase 1 Plan](../../../docs/plans/GCP_PROD_PHASE_1_COST_SENSITIVE.md)
- [Phase 2 Plan](../../../docs/plans/GCP_PROD_PHASE_2_HIGH_AVAILABILITY.md)
- [CLAUDE.md](../../../CLAUDE.md)

---

*For VPS staging deployment, see: `infrastructure/terraform/vps/`*
