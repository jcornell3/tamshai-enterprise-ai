openapi: 3.0.3
info:
  title: Tamshai MCP Gateway API
  description: |
    AI Gateway service for Tamshai Corp Enterprise AI system.
    Routes AI queries to appropriate MCP servers based on user roles.

    ## Authentication
    All authenticated endpoints require a JWT Bearer token from Keycloak.

    ## v1.4 Features
    - SSE Streaming for long-running queries
    - Human-in-the-loop confirmations
    - Truncation warnings for large datasets
  version: 1.4.0
  contact:
    name: Tamshai Corp
    url: https://github.com/jcornell3/tamshai-enterprise-ai
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3100
    description: Local development
  - url: https://vps.tamshai.com/api
    description: Production

tags:
  - name: Health
    description: Health check endpoints
  - name: User
    description: User information
  - name: AI
    description: AI query endpoints
  - name: MCP
    description: MCP tool proxy endpoints
  - name: Confirmation
    description: Human-in-the-loop confirmations
  - name: GDPR
    description: GDPR compliance endpoints (HR admin only)

paths:
  /health:
    get:
      summary: Health check
      description: Check if the gateway is healthy
      tags: [Health]
      responses:
        '200':
          description: Gateway is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/health:
    get:
      summary: API health check
      description: Check if the API is healthy
      tags: [Health]
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/user:
    get:
      summary: Get current user
      description: Get information about the authenticated user
      tags: [User]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/mcp/tools:
    get:
      summary: Get available MCP tools
      description: List MCP data sources accessible to the current user
      tags: [MCP]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Available tools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/ai/query:
    post:
      summary: AI query (non-streaming)
      description: Send a query to Claude with MCP data context
      tags: [AI]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIQueryRequest'
      responses:
        '200':
          description: AI response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIQueryResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/query:
    get:
      summary: SSE streaming query (GET)
      description: |
        Stream AI responses using Server-Sent Events.
        Use for EventSource API which requires GET.
        Token can be passed via query param.
      tags: [AI]
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          description: The query string
          schema:
            type: string
        - name: cursor
          in: query
          required: false
          description: Pagination cursor for subsequent pages
          schema:
            type: string
        - name: token
          in: query
          required: false
          description: JWT token (alternative to Authorization header for EventSource)
          schema:
            type: string
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: SSE streaming query (POST)
      description: |
        Stream AI responses using Server-Sent Events.
        Use for fetch API with proper Authorization headers.
      tags: [AI]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                  description: The query string
                cursor:
                  type: string
                  description: Pagination cursor
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/confirm/{confirmationId}:
    post:
      summary: Confirm or reject action
      description: |
        Handle human-in-the-loop confirmations for write operations.
        v1.4 feature for destructive action approval.
      tags: [Confirmation]
      security:
        - bearerAuth: []
      parameters:
        - name: confirmationId
          in: path
          required: true
          description: The confirmation ID from pending action
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [approved]
              properties:
                approved:
                  type: boolean
                  description: Whether to approve or reject the action
      responses:
        '200':
          description: Confirmation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: User mismatch - only initiating user can confirm
        '404':
          description: Confirmation not found or expired

  /api/mcp/{serverName}/{toolName}:
    get:
      summary: Call MCP tool (GET)
      description: Proxy request to MCP server tool
      tags: [MCP]
      security:
        - bearerAuth: []
      parameters:
        - name: serverName
          in: path
          required: true
          description: MCP server name (hr, finance, sales, support)
          schema:
            type: string
            enum: [hr, finance, sales, support]
        - name: toolName
          in: path
          required: true
          description: Tool name to call
          schema:
            type: string
            pattern: '^[a-zA-Z][a-zA-Z0-9_-]{0,63}$'
      responses:
        '200':
          description: Tool response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Access denied to this MCP server
        '404':
          description: Server or tool not found
        '503':
          description: MCP server unavailable

    post:
      summary: Call MCP tool (POST)
      description: Proxy request to MCP server tool for write operations
      tags: [MCP]
      security:
        - bearerAuth: []
      parameters:
        - name: serverName
          in: path
          required: true
          description: MCP server name
          schema:
            type: string
            enum: [hr, finance, sales, support]
        - name: toolName
          in: path
          required: true
          description: Tool name to call
          schema:
            type: string
            pattern: '^[a-zA-Z][a-zA-Z0-9_-]{0,63}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Tool response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Access denied
        '503':
          description: MCP server unavailable

  # ===========================================================================
  # GDPR Compliance Endpoints (v1.5)
  # ===========================================================================

  /api/admin/gdpr/export:
    post:
      summary: Request GDPR data export
      description: |
        Initiate a GDPR data export for an employee (Art. 15 - Right of Access).
        HR representatives only. Exports data from all MCP servers.
      tags: [GDPR]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GDPRExportRequest'
      responses:
        '202':
          description: Export request accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPRExportResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write role

  /api/admin/gdpr/export/{exportId}/download:
    get:
      summary: Download GDPR export
      description: Download the completed GDPR data export file
      tags: [GDPR]
      security:
        - bearerAuth: []
      parameters:
        - name: exportId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Export file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPRExportData'
        '404':
          description: Export not found or expired
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write role

  /api/admin/gdpr/erase:
    post:
      summary: Request GDPR data erasure
      description: |
        Initiate GDPR data erasure for an employee (Art. 17 - Right to Erasure).
        HR representatives only. Returns confirmation requirements before execution.
      tags: [GDPR]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GDPREraseRequest'
      responses:
        '200':
          description: Erasure request created, confirmation required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPREraseResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write role

  /api/admin/gdpr/erase/{erasureId}/confirm:
    post:
      summary: Confirm GDPR erasure
      description: Confirm and execute the GDPR data erasure
      tags: [GDPR]
      security:
        - bearerAuth: []
      parameters:
        - name: erasureId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [confirmed]
              properties:
                confirmed:
                  type: boolean
      responses:
        '200':
          description: Erasure completed or cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPREraseConfirmResponse'
        '404':
          description: Erasure request not found or expired
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write role

  /api/admin/gdpr/erase/{erasureId}:
    get:
      summary: Get erasure status
      description: Get the current status and details of an erasure request
      tags: [GDPR]
      security:
        - bearerAuth: []
      parameters:
        - name: erasureId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Erasure request details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPREraseStatusResponse'
        '404':
          description: Erasure request not found
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write role

  /api/admin/gdpr/breach:
    get:
      summary: List all breaches
      description: Get a list of all registered data breaches
      tags: [GDPR]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of breaches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPRBreachListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write or security-admin role
    post:
      summary: Register data breach
      description: |
        Register a data breach incident (Art. 33 notification requirement).
        Tracks 72-hour notification deadline and required actions.
      tags: [GDPR]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GDPRBreachRequest'
      responses:
        '201':
          description: Breach registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPRBreachResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write or security-admin role

  /api/admin/gdpr/breach/{breachId}:
    get:
      summary: Get breach details
      description: Get details and status of a registered breach
      tags: [GDPR]
      security:
        - bearerAuth: []
      parameters:
        - name: breachId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Breach details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GDPRBreachResponse'
        '404':
          description: Breach not found
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires hr-write or security-admin role

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Keycloak JWT token

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "0.1.0"

    UserInfo:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        username:
          type: string
        email:
          type: string
          format: email
        roles:
          type: array
          items:
            type: string
        groups:
          type: array
          items:
            type: string

    MCPToolsResponse:
      type: object
      properties:
        user:
          type: string
        roles:
          type: array
          items:
            type: string
        accessibleDataSources:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string

    AIQueryRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: Natural language query
        conversationId:
          type: string
          format: uuid
          description: Optional conversation ID for context
        context:
          type: object
          description: Additional context

    AIQueryResponse:
      type: object
      properties:
        requestId:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        response:
          type: string
          description: AI-generated response
        metadata:
          type: object
          properties:
            dataSourcesQueried:
              type: array
              items:
                type: string
            processingTimeMs:
              type: integer

    MCPToolResponse:
      oneOf:
        - $ref: '#/components/schemas/MCPSuccessResponse'
        - $ref: '#/components/schemas/MCPErrorResponse'
        - $ref: '#/components/schemas/MCPPendingConfirmation'

    MCPSuccessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success]
        data:
          type: object
        metadata:
          type: object
          properties:
            truncated:
              type: boolean
            returnedCount:
              type: integer
            totalCount:
              type: string
            hasMore:
              type: boolean
            nextCursor:
              type: string

    MCPErrorResponse:
      type: object
      properties:
        status:
          type: string
          enum: [error]
        code:
          type: string
        message:
          type: string
        suggestedAction:
          type: string

    MCPPendingConfirmation:
      type: object
      properties:
        status:
          type: string
          enum: [pending_confirmation]
        confirmationId:
          type: string
          format: uuid
        message:
          type: string
        confirmationData:
          type: object

    ConfirmationResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, cancelled]
        message:
          type: string
        result:
          type: object

    Error:
      type: object
      properties:
        error:
          type: string
        requestId:
          type: string

    # GDPR Schemas
    GDPRExportRequest:
      type: object
      required: [employeeId]
      properties:
        employeeId:
          type: string
          format: uuid
          description: The employee ID to export data for
        reason:
          type: string
          description: Reason for the export request
          example: "GDPR Subject Access Request"

    GDPRExportResponse:
      type: object
      properties:
        exportId:
          type: string
          format: uuid
        status:
          type: string
          enum: [processing, completed, failed]
        employeeId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        estimatedCompletion:
          type: string
          format: date-time
        downloadUrl:
          type: string
          description: URL to download the export when ready

    GDPRExportData:
      type: object
      properties:
        subject:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            email:
              type: string
        exportDate:
          type: string
          format: date-time
        requestedBy:
          type: string
        data:
          type: object
          properties:
            hrData:
              type: object
              description: Employee profile and employment data
            financeData:
              type: object
              description: Salary and expense data
            supportData:
              type: object
              description: Support tickets
            auditLogs:
              type: array
              items:
                type: object
              description: AI query audit logs (90 days)
        retentionInfo:
          type: object
          description: Information about data retention requirements

    GDPREraseRequest:
      type: object
      required: [employeeId]
      properties:
        employeeId:
          type: string
          format: uuid
        reason:
          type: string
          example: "GDPR erasure request - employee offboarded"
        retainAuditLog:
          type: boolean
          default: true
          description: Keep anonymized audit trail for compliance
        retainFinancialRecords:
          type: boolean
          default: true
          description: Keep anonymized financial records (tax requirement)

    GDPREraseResponse:
      type: object
      properties:
        erasureId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending_confirmation, processing, completed, failed]
        employeeId:
          type: string
          format: uuid
        affectedSystems:
          type: array
          items:
            type: string
          description: Systems that will be affected
        retentionExceptions:
          type: array
          items:
            type: object
            properties:
              system:
                type: string
              reason:
                type: string
              anonymized:
                type: boolean
        confirmationRequired:
          type: boolean
        confirmationUrl:
          type: string

    GDPREraseConfirmResponse:
      type: object
      properties:
        erasureId:
          type: string
          format: uuid
        status:
          type: string
          enum: [completed, cancelled]
        completedAt:
          type: string
          format: date-time
        affectedRecords:
          type: object
          additionalProperties:
            type: integer
          description: Count of records affected per system

    GDPREraseStatusResponse:
      type: object
      properties:
        erasureId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending_confirmation, processing, completed, failed, cancelled]
        employeeId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        confirmedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
        affectedSystems:
          type: array
          items:
            type: string
        affectedRecords:
          type: object
          additionalProperties:
            type: integer
          description: Count of records affected per system

    GDPRBreachRequest:
      type: object
      required: [breachType, discoveryDate, description]
      properties:
        breachType:
          type: string
          enum: [unauthorized_access, data_loss, ransomware, disclosure, system_compromise]
        affectedDataTypes:
          type: array
          items:
            type: string
            enum: [employee_pii, financial, client_data, credentials, health_data]
        affectedCount:
          type: integer
          description: Estimated number of affected individuals
        discoveryDate:
          type: string
          format: date-time
        description:
          type: string
        containmentActions:
          type: array
          items:
            type: string
          description: Actions already taken to contain the breach

    GDPRBreachResponse:
      type: object
      properties:
        breachId:
          type: string
          format: uuid
        status:
          type: string
          enum: [registered, investigating, contained, notified, closed]
        notificationDeadline:
          type: string
          format: date-time
          description: 72-hour deadline for supervisory authority notification
        requiredActions:
          type: array
          items:
            type: object
            properties:
              action:
                type: string
              deadline:
                type: string
                format: date-time
              status:
                type: string
                enum: [pending, in_progress, completed]
              template:
                type: string
                description: URL to notification template if applicable
        affectedUserList:
          type: string
          description: URL to get list of affected users

    GDPRBreachListResponse:
      type: object
      properties:
        breaches:
          type: array
          items:
            type: object
            properties:
              breachId:
                type: string
                format: uuid
              breachType:
                type: string
                enum: [unauthorized_access, data_loss, ransomware, disclosure, system_compromise]
              status:
                type: string
                enum: [registered, investigating, contained, notified, closed]
              affectedCount:
                type: integer
              discoveryDate:
                type: string
                format: date-time
              notificationDeadline:
                type: string
                format: date-time
        total:
          type: integer
          description: Total number of breaches

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Missing or invalid authorization
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
